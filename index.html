<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Danh s√°ch ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2563eb;
      --accent: #22c55e;
      --bg: #0b1120;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), transparent 50%),
        radial-gradient(circle at top right, rgba(129, 140, 248, 0.2), transparent 55%),
        radial-gradient(circle at bottom, rgba(45, 212, 191, 0.25), transparent 55%),
        var(--bg);
      color: #e5e7eb;
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .container {
      width: 100%;
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      margin-bottom: 16px;
      padding-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: conic-gradient(from 120deg, #38bdf8, #22c55e, #6366f1, #38bdf8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0b1120;
      font-size: 0.9rem;
      font-weight: 800;
    }

    .btn {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      background: radial-gradient(circle at top left, #38bdf8, #2563eb);
      color: #f9fafb;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5);
      transition:
        transform 0.18s ease,
        box-shadow 0.18s ease,
        filter 0.18s ease,
        opacity 0.18s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(37, 99, 235, 0.8);
      filter: brightness(1.05);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.8);
      box-shadow: none;
    }

    .btn-outline:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .btn-disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      background: rgba(30, 64, 175, 0.5);
    }

    main {
      padding-bottom: 24px;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.96);
    }

    .tenant-mini {
      font-size: 0.8rem;
      color: rgba(226, 232, 240, 0.98);
    }

    .tenant-mini strong {
      color: #f9fafb;
    }

    .room-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
    }

    .room-card {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 18px 46px rgba(15, 23, 42, 0.96);
      padding: 12px;
      font-size: 0.88rem;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    .room-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .room-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .status-chip {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.95);
      white-space: nowrap;
    }

    .status-available {
      background: #22c55e;
      border-color: #22c55e;
      color: #022c22;
    }

    .status-rented {
      background: #4b5563;
      border-color: #6b7280;
      color: #e5e7eb;
    }

    .room-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.96);
    }

    .room-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .room-price {
      font-size: 1rem;
      font-weight: 700;
    }

    .room-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tag-current-tenant {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 0.7rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.2);
      border: 1px solid rgba(56, 189, 248, 0.8);
      color: #e0f2fe;
    }

    /* Modal ƒëƒÉng nh·∫≠p t√†i kho·∫£n ph√≤ng */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.98));
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.98);
      max-width: 420px;
      width: 100%;
      padding: 14px 16px 16px;
      font-size: 0.88rem;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .modal-close {
      border: none;
      background: transparent;
      color: rgba(148, 163, 184, 0.96);
      font-size: 1.1rem;
      cursor: pointer;
    }

    .form-group {
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 2px;
      font-weight: 600;
    }

    .form-control {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      font-size: 0.85rem;
      outline: none;
    }

    .form-control:focus {
      border-color: #38bdf8;
    }

    #tenantLoginStatus {
      margin-top: 4px;
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.96);
      min-height: 16px;
    }

    .tenant-login-hint {
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.96);
      margin-bottom: 6px;
    }

    @media (max-width: 900px) {
      header {
        align-items: flex-start;
      }
      .header-right {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">YT</div>
        <div>
          <div>YT Home</div>
          <div style="font-size:0.7rem; font-weight:500; color:rgba(148,163,184,0.9);">
            Danh s√°ch ph√≤ng
          </div>
        </div>
      </div>

      <div class="header-right">
        <div id="tenantMiniInfo" class="tenant-mini" style="display:none;">
          Xin ch√†o <strong id="tenantMiniName"></strong> ¬∑ Ph√≤ng <span id="tenantMiniRoom"></span>
        </div>
        <div>
          <button
            id="openTenantLoginFromHeader"
            class="btn-outline btn"
            style="padding:6px 14px; font-size:0.78rem;"
          >
            ƒêƒÉng nh·∫≠p t√†i kho·∫£n ph√≤ng
          </button>
        </div>
      </div>
    </header>

    <main>
      <p style="font-size:0.85rem; color:rgba(148,163,184,0.96); margin-bottom:10px;">
        Ch·ªçn ph√≤ng ƒë·ªÉ xem chi ti·∫øt. N·∫øu b·∫°n ƒëang l√† c∆∞ d√¢n, h√£y ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n ph√≤ng ƒë·ªÉ theo d√µi
        h√≥a ƒë∆°n, b√°o h·ªèng & ƒëƒÉng k√Ω t·∫°m tr√∫.
      </p>

      <div id="loadingRooms" style="font-size:0.9rem; color:rgba(148,163,184,0.96); margin-bottom:8px;">
        ƒêang t·∫£i danh s√°ch ph√≤ng...
      </div>

      <div id="roomGrid" class="room-grid"></div>
    </main>
  </div>

  <!-- Modal ƒëƒÉng nh·∫≠p t√†i kho·∫£n ph√≤ng (d√πng chung v·ªõi room.html v·ªÅ API & logic) -->
  <div id="tenantLoginModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ƒêƒÉng nh·∫≠p t√†i kho·∫£n ph√≤ng</div>
        <button class="modal-close" type="button" onclick="closeTenantLoginModal()">√ó</button>
      </div>
      <p class="tenant-login-hint">
        D√†nh cho c∆∞ d√¢n ƒëang thu√™. Vui l√≤ng nh·∫≠p <strong>M√£ ph√≤ng</strong> v√†
        <strong>CCCD/SDT c·ªßa ch·ªß ph√≤ng</strong> theo H·ª£p ƒë·ªìng hi·ªáu l·ª±c.
      </p>
      <form id="tenantLoginForm">
        <div class="form-group">
          <label for="tenantLoginRoomCode">M√£ ph√≤ng</label>
          <input
            id="tenantLoginRoomCode"
            class="form-control"
            type="text"
            placeholder="V√≠ d·ª•: 301, 4A, CH-502..."
            required
          />
        </div>
        <div class="form-group">
          <label for="tenantLoginIdentity">S·ªë CCCD/CMND ho·∫∑c S·ªë ƒëi·ªán tho·∫°i ch·ªß ph√≤ng</label>
          <input
            id="tenantLoginIdentity"
            class="form-control"
            type="text"
            placeholder="Nh·∫≠p CCCD/CMND ho·∫∑c S·ªë ƒëi·ªán tho·∫°i ch·ªß ph√≤ng"
            required
          />
        </div>
        <button type="submit" class="btn" style="width:100%;">ƒêƒÉng nh·∫≠p</button>
        <p id="tenantLoginStatus"></p>
      </form>
    </div>
  </div>

  <script>
    const API_URL =
      "https://script.google.com/macros/s/AKfycbxLTPhZH10mJPtmBxgIfOreFDLXN5oI8ebGZYrZLbeXh6tUKiFETrej-cdGaIMIKceLkw/exec";

    // ====== T√ÄI KHO·∫¢N PH√íNG: D√ôNG CHUNG V·ªöI room.html ======
    const TENANT_STORAGE_KEY = "ytHomeTenant";
    let CURRENT_TENANT = null;

    function loadTenantFromStorage() {
      try {
        const raw = localStorage.getItem(TENANT_STORAGE_KEY);
        CURRENT_TENANT = raw ? JSON.parse(raw) : null;
      } catch (e) {
        CURRENT_TENANT = null;
      }
    }

    function saveTenantToStorage() {
      try {
        if (CURRENT_TENANT) {
          localStorage.setItem(TENANT_STORAGE_KEY, JSON.stringify(CURRENT_TENANT));
        } else {
          localStorage.removeItem(TENANT_STORAGE_KEY);
        }
      } catch (e) {
        console.error("saveTenantToStorage error:", e);
      }
    }

    function openTenantLoginModal(prefillRoom) {
      const modal = document.getElementById("tenantLoginModal");
      const roomInput = document.getElementById("tenantLoginRoomCode");
      const statusEl = document.getElementById("tenantLoginStatus");
      if (statusEl) statusEl.textContent = "";
      if (roomInput && prefillRoom) roomInput.value = prefillRoom;
      if (modal) modal.classList.add("show");
    }

    function closeTenantLoginModal() {
      const modal = document.getElementById("tenantLoginModal");
      if (modal) modal.classList.remove("show");
    }

    function formatVND(amount) {
      if (amount === null || amount === undefined || amount === "") return "--";
      const num = Number(String(amount).replace(/[^\d.-]/g, ""));
      if (isNaN(num)) return String(amount);
      return num.toLocaleString("vi-VN") + " ƒë";
    }

    function updateTenantMiniInfo() {
      const wrapper = document.getElementById("tenantMiniInfo");
      const nameEl = document.getElementById("tenantMiniName");
      const roomEl = document.getElementById("tenantMiniRoom");

      if (CURRENT_TENANT && CURRENT_TENANT.roomCode) {
        if (wrapper) wrapper.style.display = "block";
        if (nameEl) {
          nameEl.textContent =
            CURRENT_TENANT.tenantName ||
            CURRENT_TENANT.tenNguoiThue ||
            "C∆∞ d√¢n";
        }
        if (roomEl) {
          roomEl.textContent = CURRENT_TENANT.roomCode || CURRENT_TENANT.maPhong || "";
        }
      } else {
        if (wrapper) wrapper.style.display = "none";
      }
    }

    async function handleTenantLogin(event) {
      event.preventDefault();
      const roomCode = document.getElementById("tenantLoginRoomCode").value.trim();
      const identity = document.getElementById("tenantLoginIdentity").value.trim();
      const statusEl = document.getElementById("tenantLoginStatus");
      if (!roomCode || !identity) {
        if (statusEl) statusEl.textContent = "Vui l√≤ng nh·∫≠p ƒë·ªß M√£ ph√≤ng v√† CCCD/SDT ch·ªß ph√≤ng.";
        return;
      }

      if (statusEl) statusEl.textContent = "ƒêang ki·ªÉm tra th√¥ng tin ƒëƒÉng nh·∫≠p...";

      try {
        const body = new URLSearchParams({
          action: "tenantLogin",
          roomCode: roomCode,
          identity: identity
        });

        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body
        });

        const data = await res.json();
        if (!data || !data.success) {
          if (statusEl) {
            statusEl.textContent =
              (data && data.message) ||
              "Kh√¥ng t√¨m th·∫•y H·ª£p ƒë·ªìng hi·ªáu l·ª±c ho·∫∑c th√¥ng tin ch·ªß ph√≤ng kh√¥ng kh·ªõp.";
          }
          return;
        }

        CURRENT_TENANT = {
          roomCode: data.roomCode || roomCode,
          tenantName: data.tenantName || data.tenNguoiThue || "",
          maPhong: data.maPhong || roomCode
        };
        saveTenantToStorage();
        updateTenantMiniInfo();

        if (statusEl) statusEl.textContent = "ƒêƒÉng nh·∫≠p th√†nh c√¥ng.";
        // ƒê√≥ng modal sau 1 ch√∫t, v√† highlight l·∫°i card (n·∫øu ƒë√£ load)
        setTimeout(() => {
          closeTenantLoginModal();
          renderRooms(LAST_ROOMS || []); // ƒë·ªÉ g·∫Øn tag "Ph√≤ng c·ªßa b·∫°n"
        }, 400);
      } catch (e) {
        console.error("handleTenantLogin error:", e);
        if (statusEl) {
          statusEl.textContent = "C√≥ l·ªói khi ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i sau.";
        }
      }
    }

    // ====== DANH S√ÅCH PH√íNG ======
    let LAST_ROOMS = [];

    function renderRooms(rooms) {
      LAST_ROOMS = rooms || [];
      const grid = document.getElementById("roomGrid");
      const loading = document.getElementById("loadingRooms");
      if (!grid) return;
      grid.innerHTML = "";

      if (!rooms || !rooms.length) {
        if (loading) loading.textContent = "Ch∆∞a c√≥ ph√≤ng n√†o tr√™n h·ªá th·ªëng.";
        return;
      }
      if (loading) loading.style.display = "none";

      rooms.forEach((room) => {
        const card = document.createElement("div");
        card.className = "room-card";

        const maPhong = room.maPhong || room.roomCode || "Ph√≤ng";
        const loaiPhong = room.loaiPhong || "Ph√≤ng cho thu√™";
        const gia = room.giaThue ? formatVND(room.giaThue) + "/th√°ng" : "Gi√° li√™n h·ªá";
        const tang = room.tang || "‚Äì";
        const dienTich = room.dienTich || room.dientich || "";
        const trangThai = room.trangThaiWebsite === "available" ? "available" : "rented";
        const statusClass =
          trangThai === "available" ? "status-available" : "status-rented";
        const statusText = trangThai === "available" ? "C√≤n tr·ªëng" : "ƒêang thu√™";

        const isCurrentTenant =
          CURRENT_TENANT &&
          (CURRENT_TENANT.roomCode === maPhong || CURRENT_TENANT.maPhong === maPhong);

        if (isCurrentTenant) {
          const tag = document.createElement("div");
          tag.className = "tag-current-tenant";
          tag.textContent = "Ph√≤ng c·ªßa b·∫°n";
          card.appendChild(tag);
        }

        card.innerHTML += `
          <div class="room-card-header">
            <div>
              <div class="room-name">${maPhong}</div>
              <div style="font-size:0.78rem; color:rgba(148,163,184,0.96);">${loaiPhong}</div>
            </div>
            <span class="status-chip ${statusClass}">${statusText}</span>
          </div>

          <div class="room-meta">
            <span>üè∑ <span class="room-price">${gia}</span></span>
            <span>‚¨Ü T·∫ßng ${tang}</span>
            ${dienTich ? `<span>üìê ${dienTich}</span>` : ""}
          </div>

          <div class="room-actions">
            <button
              class="btn-outline btn"
              style="padding:6px 12px; font-size:0.78rem;"
              onclick="window.location.href='room.html?room=${encodeURIComponent(maPhong)}'"
            >
              Xem chi ti·∫øt
            </button>
          </div>
        `;

        // th√™m n√∫t ƒëƒÉng nh·∫≠p t√†i kho·∫£n ph√≤ng theo tr·∫°ng th√°i
        const actions = card.querySelector(".room-actions");
        if (actions) {
          const loginBtn = document.createElement("button");
          loginBtn.style.padding = "6px 12px";
          loginBtn.style.fontSize = "0.78rem";

          if (trangThai === "available") {
            // Ph√≤ng tr·ªëng: kh√¥ng cho ƒëƒÉng nh·∫≠p
            loginBtn.textContent = "ƒêƒÉng nh·∫≠p ph√≤ng";
            loginBtn.className = "btn btn-disabled";
            loginBtn.disabled = true;
            loginBtn.title = "Ph√≤ng n√†y ƒëang tr·ªëng, ch∆∞a c√≥ h·ª£p ƒë·ªìng ƒë·ªÉ ƒëƒÉng nh·∫≠p.";
          } else {
            // ƒêang thu√™: cho ƒëƒÉng nh·∫≠p
            loginBtn.textContent = isCurrentTenant ? "Xem t√†i kho·∫£n ph√≤ng" : "ƒêƒÉng nh·∫≠p ph√≤ng";
            loginBtn.className = "btn";
            loginBtn.addEventListener("click", () => {
              // N·∫øu ƒë√£ l√† tenant c·ªßa ph√≤ng n√†y th√¨ cho ƒëi lu√¥n qua room.html
              if (isCurrentTenant) {
                window.location.href = "room.html?room=" + encodeURIComponent(maPhong);
              } else {
                openTenantLoginModal(maPhong);
              }
            });
          }

          actions.appendChild(loginBtn);
        }

        grid.appendChild(card);
      });
    }

    async function loadRooms() {
      const loading = document.getElementById("loadingRooms");
      if (loading) loading.textContent = "ƒêang t·∫£i danh s√°ch ph√≤ng...";

      try {
        const res = await fetch(API_URL + "?action=rooms");
        const data = await res.json();
        const rooms = (data && data.rooms) || [];
        renderRooms(rooms);
      } catch (e) {
        console.error("loadRooms error:", e);
        if (loading) loading.textContent = "C√≥ l·ªói khi t·∫£i danh s√°ch ph√≤ng.";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadTenantFromStorage();
      updateTenantMiniInfo();

      const loginFromHeader = document.getElementById("openTenantLoginFromHeader");
      if (loginFromHeader) {
        loginFromHeader.addEventListener("click", () => {
          // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p r·ªìi th√¨ ∆∞u ti√™n m·ªü ph√≤ng c·ªßa m√¨nh
          if (CURRENT_TENANT && CURRENT_TENANT.roomCode) {
            window.location.href =
              "room.html?room=" + encodeURIComponent(CURRENT_TENANT.roomCode);
          } else {
            openTenantLoginModal();
          }
        });
      }

      const tenantLoginForm = document.getElementById("tenantLoginForm");
      if (tenantLoginForm) {
        tenantLoginForm.addEventListener("submit", handleTenantLogin);
      }

      loadRooms();
    });
  </script>
</body>
</html>
