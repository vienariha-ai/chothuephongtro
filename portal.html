<!DOCTYPE html-2 in 1>
<html lang="vi">
<head>
<meta charset="UTF-8" />
  <title>YT Home ‚Äì Portal t√†i kho·∫£n ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="yt-home-common.css" />

  <!-- Patch CSS cho b·∫£ng ng∆∞·ªùi/xe + icon d·ªãch v·ª• + status xanh -->
  <style>
    .table-like.table-center th,
    .table-like.table-center td{
      text-align:center !important;
      vertical-align: middle;
      font-size: 0.78rem;
      white-space: nowrap;
    }
    .table-like.table-center thead th{ font-size: 0.74rem; }

    .svc-icon{
      display:inline-block;
      width:22px;
      text-align:center;
      margin-right:6px;
      opacity:.95;
    }

    .status-text-success,
    .status-ok{
      color:#22c55e;
      font-weight:700;
    }
  </style>

  <style>
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width: 720px){ .grid-2{grid-template-columns:1fr;} }

    .status-chip{border:none;cursor:pointer;padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px;line-height:1;display:inline-flex;align-items:center;justify-content:center;}
    .status-chip-warning{background:#fff4cc;color:#8a5a00;}
    .status-chip-success{background:#dcfce7;color:#166534;}
    .status-chip-info{background:#dbeafe;color:#1e3a8a;}
  </style>

<style>
  /* merged: view switch */
  .hidden{display:none !important;}
</style>

</head>
<body class="tenant-body">
<div id="loginPage" class="hidden">
<div class="container">
    <div class="page-wrapper">
      <div class="card">
        <div class="logo-row">
          <div class="logo-icon">YT</div>
          <div class="logo-text">
            <div class="logo-text-main">YT Home</div>
            <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
          </div>
        </div>

        <div class="page-title">ƒêƒÉng nh·∫≠p t√†i kho·∫£n ph√≤ng</div>
        <div class="page-subtitle">
          Nh·∫≠p <strong>M√£ ph√≤ng</strong> v√† <strong>S·ªë ƒëi·ªán tho·∫°i/CCCD</strong> c·ªßa ch·ªß ph√≤ng ƒë·ªÉ xem portal n·ªôi b·ªô.
        </div>

        <div id="roomBadgeLogin" class="badge" style="display:none;"></div>

        <form id="loginForm">
          <div class="form-group">
            <label for="loginCode">M√£ ph√≤ng</label>
            <input id="loginCode" class="form-control" type="text" autocomplete="off" required />
          </div>

          <div class="form-group">
            <label for="loginPhone">S·ªë ƒëi·ªán tho·∫°i/CCCD ch·ªß ph√≤ng</label>
            <input id="loginPhone" class="form-control" type="tel" autocomplete="off" required />
          </div>

          <button type="submit" class="btn" id="btnLogin">ƒêƒÉng nh·∫≠p</button>
        </form>

        <div id="loginStatus" class="portal-status"></div>

        <div class="small-note">
          Sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng, h·ªá th·ªëng s·∫Ω l∆∞u t√†i kho·∫£n ph√≤ng ƒë·ªÉ nh·ªØng l·∫ßn sau t·ª± chuy·ªÉn th·∫≥ng v√†o portal.
        </div>

        <div class="tenant-footer-actions">
          <a href="index.html" class="tenant-back-link">‚Üê Quay l·∫°i trang xem ph√≤ng</a>

          <button type="button" id="logoutBtn" class="btn-logout">
            <span class="btn-logout-icon">‚áÑ</span>
            <span>ƒêƒÉng xu·∫•t / ƒê·ªïi ph√≤ng</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="portalPage" class="hidden">
<div class="container">
    <header class="header">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn btn-outline">Trang xem ph√≤ng</a>
        <button type="button" class="btn btn-outline" onclick="logoutTenant()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">Xin ch√†o, c∆∞ d√¢n YT Home üè°</div>
      <div class="page-subtitle">
        ƒê√¢y l√† portal n·ªôi b·ªô d√†nh cho t√†i kho·∫£n ph√≤ng. D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ Google Sheet qua Apps Script.
      </div>
      <div id="portalStatusNote" class="portal-status">
        ƒêang t·∫£i d·ªØ li·ªáu ph√≤ng t·ª´ h·ªá th·ªëng...
      </div>

      <div class="grid">
        <!-- C·ªòT TR√ÅI: TH√îNG TIN -->
        <section class="card">
          <div class="card-title">Th√¥ng tin ph√≤ng</div>
          <div class="room-badge-row">
            <span class="badge" id="roomBadge">Ph√≤ng: --</span>
            <span id="contractAlertBadge" class="contract-alert-badge hidden"></span>
          </div>
          <div id="contractDaysLeft" class="contract-days-left hidden">C√≤n -- ng√†y</div>

          <div class="tab-row">
            <button class="tab-btn tab-info active" data-tab="owner">Ch·ªß ph√≤ng</button>
            <button class="tab-btn tab-info" data-tab="contract">T√≥m t·∫Øt h·ª£p ƒë·ªìng</button>
            <button class="tab-btn tab-info" data-tab="assets">Danh s√°ch thi·∫øt b·ªã</button>
          </div>

          <!-- TAB CH·ª¶ PH√íNG -->
          <div class="tab-pane tab-pane-info" id="tab-owner">
            <div class="info-row">
              <span class="info-label">Ph√≤ng:</span>
              <span class="info-value" id="roomLabel">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">T√™n ch·ªß ph√≤ng:</span>
              <span class="info-value owner-name" id="ownerName">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë CCCD:</span>
              <span class="info-value" id="ownerCCCD">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
              <span class="info-value" id="ownerPhone">--</span>
            </div>

            <div class="section-title" style="margin-top:12px;">Danh s√°ch ng∆∞·ªùi trong ph√≤ng</div>
            <table class="table-like table-center">
              <thead>
                <tr>
                  <th>H·ªç t√™n</th>
                  <th>ƒêi·ªán tho·∫°i</th>
                  <th>CCCD</th>
                  <th>Bi·ªÉn s·ªë</th>
                  <th>T·∫°m tr√∫</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="membersTableBody">
                <tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
              </tbody>
            </table>

            <div class="small-note">Nh·∫•n v√†o tr·∫°ng th√°i <strong>t·∫°m tr√∫</strong> (v√≠ d·ª•: "Ch∆∞a ƒëƒÉng k√Ω") ƒë·ªÉ m·ªü form x√°c nh·∫≠n.</div>
          </div>

          <!-- TAB H·ª¢P ƒê·ªíNG -->
          <div class="tab-pane tab-pane-info hidden" id="tab-contract">
            <ul class="list">
              <li>Tr·∫°ng th√°i: <strong id="contractStatus">--</strong></li>
              <li>Lo·∫°i Hƒê: <strong id="contractType">--</strong></li>
              <li>Th·ªùi gian: <strong id="contractPeriod">--</strong></li>
              <li>Ti·ªÅn thu√™: <strong id="contractRent">--</strong></li>
              <li>Ti·ªÅn c·ªçc: <strong id="contractDeposit">--</strong></li>
              <li>Ng√†y thu ti·ªÅn: <strong id="contractDueDay">--</strong></li>
              <li>D·ªãch v·ª• k√®m theo:</li>
            </ul>
            <ul class="list" id="contractServices"></ul>

            <button id="extendContractBtn" class="btn" style="margin-top:8px; display:none;">
              K√Ω ti·∫øp h·ª£p ƒë·ªìng
            </button>

            <div class="small-note">
              Hi·ªÉn th·ªã t·ª´ sheet <strong>H·ª£p ƒë·ªìng</strong>. N√∫t "K√Ω ti·∫øp h·ª£p ƒë·ªìng" ch·ªâ hi·ªán khi c√≤n &lt;= 1 th√°ng tr∆∞·ªõc ng√†y k·∫øt th√∫c.
            </div>
          </div>

          <!-- TAB THI·∫æT B·ªä / T√ÄI S·∫¢N -->
          <div class="tab-pane tab-pane-info hidden" id="tab-assets">
            <table class="table-like table-fixed">
              <thead>
                <tr>
                  <th>T√™n thi·∫øt b·ªã</th>
                  <th>T√¨nh tr·∫°ng</th>
                  <th>B·∫£o h√†nh</th>
                  <th>B·∫£o tr√¨/V·ªá sinh g·∫ßn nh·∫•t</th>
                  <th>B√°o h·ªèng</th>
                </tr>
              </thead>
              <tbody id="assetsTableBody">
                <tr><td colspan="5" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu thi·∫øt b·ªã.</td></tr>
              </tbody>
            </table>
            <div class="small-note">
              D·ªØ li·ªáu l·∫•y t·ª´ sheet <strong>T√†i s·∫£n</strong> theo <strong>M√£ ph√≤ng</strong>. N√∫t "B√°o h·ªèng" s·∫Ω t·∫°o y√™u c·∫ßu g·ª≠i cho ch·ªß nh√†.
            </div>
          </div>
        </section>

        <!-- C·ªòT PH·∫¢I: THANH TO√ÅN -->
        <section class="card">
          <div class="card-title">Thanh to√°n</div>

          <div class="tab-row">
            <button class="tab-btn tab-pay active" data-tab="history">L·ªãch s·ª≠ thanh to√°n</button>
            <button class="tab-btn tab-pay" data-tab="detail">Chi ti·∫øt h√≥a ƒë∆°n</button>
          </div>

          <!-- TAB (1) L·ªäCH S·ª¨ THANH TO√ÅN -->
          <div class="tab-pane tab-pane-pay" id="tab-history">
            <table class="table-like">
              <thead>
                <tr>
                  <th>K·ª≥ (NƒÉm th√°ng)</th>
                  <th>T·ªïng ph·∫£i thu</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Chi ti·∫øt</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody">
                <tr>
                  <td colspan="4" class="muted">
                    H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="tenant-footer-actions">
              <span class="muted">Ch·ªâ hi·ªÉn th·ªã n·∫øu H·ª£p ƒë·ªìng c√≤n hi·ªáu l·ª±c.</span>
              <button class="btn" type="button" onclick="downloadInvoicePdf()">T·∫£i / In h√≥a ƒë∆°n</button>
            </div>
          </div>

          <!-- TAB (2) CHI TI·∫æT H√ìA ƒê∆†N -->
          <div class="tab-pane tab-pane-pay hidden" id="tab-detail">
            <div class="detail-head">
              <div class="detail-title">
                <div class="muted" id="invKy">K·ª≥: --</div>
              </div>
              <div class="detail-actions">
                <span id="invStatusPill" class="pill pill-neutral">--</span>
                <button id="invPayBtn" type="button" class="btn btn-danger btn-sm" style="display:none;" onclick="openPaymentModal()">
                  Thanh to√°n
                </button>
              </div>
            </div>

            <div id="invoiceSummary">
              <p><span class="inv-label">Ng√†y t√≠nh Hƒê:</span> <span class="inv-value" id="invNgayTinh">--</span></p>
              <p><span class="inv-label">Ti·ªÅn ph√≤ng thanh to√°n:</span> <span class="inv-value" id="invTienPhong">--</span></p>
              <p><span class="inv-label">T·ªïng ti·ªÅn d·ªãch v·ª•:</span> <span class="inv-value" id="invTongDV">--</span></p>
              <p><span class="inv-label">Ph√°t sinh kh√°c:</span> <span class="inv-value" id="invPhatSinh">--</span></p>
              <p><span class="inv-label">Gi·∫£m tr·ª´ kh√°c:</span> <span class="inv-value" id="invGiamTru">--</span></p>
              <p><span class="inv-label">Thi·∫øu k·ª≥ tr∆∞·ªõc:</span> <span class="inv-value" id="invThieuTruoc">--</span></p>
              <p class="inv-total-row">
                <span class="inv-label">Ph·∫£i thu:</span>
                <span class="inv-total" id="invPhaiThu">--</span>
              </p>
            </div>

            <div class="section-title">Chi ti·∫øt d·ªãch v·ª•</div>
            <div class="table-wrap">
              <table class="table-like table-dv">
                <thead>
                  <tr>
                    <th>T√™n d·ªãch v·ª•</th>
                    <th>S·ªë ƒë·∫ßu</th>
                    <th>S·ªë cu·ªëi</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>Th√†nh ti·ªÅn</th>
                  </tr>
                </thead>
                <tbody id="invoiceServiceBody">
                  <tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu d·ªãch v·ª•.</td></tr>
                </tbody>
                <tfoot>
                  <tr class="dv-total-row">
                    <td colspan="5" class="dv-total-label">T·ªïng</td>
                    <td class="dv-total" id="invServiceTotal">--</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- TH√îNG TIN CHUY·ªÇN KHO·∫¢N + QR -->
          <div class="pay-bottom">
            <div class="section-title">Th√¥ng tin chuy·ªÉn kho·∫£n</div>
            <p class="small-note" id="invBankInfo">--</p>

            <div class="section-title">QR thanh to√°n</div>
            <div id="qrContainer" class="gallery-placeholder">Ch∆∞a c√≥ QR Code.</div>
          </div>
        </section>
      </div>

      <!-- H√ÄNG D∆Ø·ªöI -->
      <div class="grid" style="margin-top:12px;">
        <section class="card">
          <div class="card-title">L·ªãch b·∫£o tr√¨</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>T√†i s·∫£n</th>
                <th>Lo·∫°i c√¥ng vi·ªác</th>
                <th>Ng√†y d·ª± ki·∫øn</th>
                <th>Ng√†y th·ª±c hi·ªán</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody id="maintenanceBody">
              <tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>
            </tbody>
          </table>
          <div class="tenant-footer-actions">
            <span class="muted">D·ªØ li·ªáu t·ª´ sheet "L·ªãch b·∫£o tr√¨".</span>
            <button type="button" class="btn" onclick="openMaintenanceForm()">B√°o h·ªèng</button>
          </div>
        </section>

        <section class="card">
          <div class="card-title">Tin nh·∫Øn & y√™u c·∫ßu</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>Lo·∫°i</th>
                <th>Ng√†y</th>
                <th>N·ªôi dung</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="messageBody">
              <tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>
            </tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <!-- ‚úÖ GI·ªÆ 1 POPUP T·∫†M TR√ö DUY NH·∫§T (ID tempStayModal) -->
  <div class="modal hidden" id="tempStayModal" role="dialog" aria-modal="true" aria-labelledby="tempStayModalTitle">
    <div class="modal-backdrop" onclick="closeTempStayModal()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="tempStayModalTitle">X√°c nh·∫≠n th√¥ng tin t·∫°m tr√∫</div>
        <button class="modal-x" type="button" onclick="closeTempStayModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="small-note" id="tempStayMeta">Ph√≤ng: -- ‚Ä¢ Tr·∫°ng th√°i: --</div>

        <div class="grid-2">
          <label class="field">
            <div class="field-label">H·ªç v√† t√™n</div>
            <input type="text" id="tsHoTen" placeholder="Nh·∫≠p h·ªç t√™n" />
          </label>

          <label class="field">
            <div class="field-label">S·ªë CCCD (kh√≥a ƒë·ªãnh danh)</div>
            <input type="text" id="tsCCCD" readonly />
          </label>

          <label class="field">
            <div class="field-label">Ng√†y sinh</div>
            <input type="text" id="tsNgaySinh" placeholder="DD/MM/YYYY" />
          </label>

          <label class="field">
            <div class="field-label">Gi·ªõi t√≠nh</div>
            <select id="tsGioiTinh">
              <option value="">-- Ch·ªçn --</option>
              <option value="Nam">Nam</option>
              <option value="N·ªØ">N·ªØ</option>
              <option value="Kh√°c">Kh√°c</option>
            </select>
          </label>

          <label class="field">
            <div class="field-label">S·ªë ƒëi·ªán tho·∫°i</div>
            <input type="text" id="tsDienThoai" placeholder="V√≠ d·ª•: 09xx..." />
          </label>

          <label class="field">
            <div class="field-label">Email</div>
            <input type="email" id="tsEmail" placeholder="name@example.com" />
          </label>

          <label class="field">
            <div class="field-label">Ngh·ªÅ nghi·ªáp</div>
            <input type="text" id="tsNgheNghiep" placeholder="V√≠ d·ª•: Nh√¢n vi√™n vƒÉn ph√≤ng" />
          </label>

          <label class="field">
            <div class="field-label">N∆°i th∆∞·ªùng tr√∫</div>
            <input type="text" id="tsNoiThuongTru" placeholder="ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫" />
          </label>
        </div>

        <label class="field">
          <div class="field-label">ƒê·ªãa ch·ªâ ƒëƒÉng k√Ω t·∫°m tr√∫ (theo m·∫´u CT)</div>
          <input type="text" id="tsDiaChiTamTru" readonly />
          <div class="field-help">L·∫•y t·ª´ sheet <strong>ConfigLienHe</strong> (key = <code>diachi</code>).</div>
        </label>

        <div class="grid-2" style="margin-top:8px;">
          <div class="field">
            <div class="field-label">Th·ªùi h·∫°n / Th·ªùi gian t·∫°m tr√∫</div>
            <div id="tsThoiGian" class="small-note">--</div>
          </div>
          <div class="field">
            <div class="field-label">Ghi ch√∫ n·ªôi b·ªô</div>
            <div id="tsGhiChuNoiBo" class="small-note">--</div>
          </div>
        </div>

        <div id="tsNotice" class="portal-status" style="margin-top:10px;">Vui l√≤ng ki·ªÉm tra th√¥ng tin tr∆∞·ªõc khi x√°c nh·∫≠n.</div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" type="button" onclick="closeTempStayModal()">ƒê√≥ng</button>
        <button class="btn" id="tsConfirmBtn" type="button" onclick="submitTempStayConfirm()">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- POPUP THANH TO√ÅN -->
  <div class="modal hidden" id="paymentModal" role="dialog" aria-modal="true" aria-labelledby="paymentModalTitle">
    <div class="modal-backdrop" onclick="closePaymentModal()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="paymentModalTitle">X√°c nh·∫≠n thanh to√°n</div>
        <button class="modal-x" type="button" onclick="closePaymentModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="small-note" id="paymentModalMeta">H√≥a ƒë∆°n: --</div>

        <label class="field">
          <div class="field-label">ƒê√≠nh k√®m phi·∫øu chuy·ªÉn kho·∫£n (·∫£nh)</div>
          <input type="file" id="paymentProofFile" accept="image/*" />
          <div class="field-help">C√≥ th·ªÉ ch·ª•p m√†n h√¨nh/·∫£nh bi√™n lai chuy·ªÉn kho·∫£n.</div>
        </label>

        <label class="field">
          <div class="field-label">Ghi ch√∫ cho ch·ªß nh√† (tu·ª≥ ch·ªçn)</div>
          <textarea id="paymentNote" rows="3" placeholder="V√≠ d·ª•: Em ƒë√£ chuy·ªÉn kho·∫£n l√∫c 20:15, nh·ªù ch·ªß nh√† ki·ªÉm tra gi√∫p ·∫°."></textarea>
        </label>

        <div id="paymentPreview" class="payment-preview muted">Ch∆∞a ch·ªçn ·∫£nh.</div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" type="button" onclick="closePaymentModal()">H·ªßy</button>
        <button class="btn btn-danger" type="button" onclick="submitPaymentProof()">G·ª≠i x√°c nh·∫≠n</button>
      </div>
    </div>
  </div>
</div>
<script>

function setSID(sid){ try{ sessionStorage.setItem("YTH_SID", sid||""); }catch(e){} }
function readTenantFromStorage(){
  try{ const raw = localStorage.getItem(TENANT_STORAGE_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; }
}
function saveTenantToStorage(tenant){
  try{ localStorage.setItem(TENANT_STORAGE_KEY, JSON.stringify(tenant||{})); }catch(e){}
}
function safeGotoPortal(){
  // In merged file, portal is the same page without view=login
  const p = new URL(location.href);
  p.searchParams.delete('view');
  location.href = p.pathname + (p.searchParams.toString() ? ('?'+p.searchParams.toString()) : '');
}


  const TENANT_STORAGE_KEY = "ytHomeTenant";

  // ‚úÖ API_URL: d√πng ƒë√∫ng URL /exec b·∫°n ƒëang deploy
  const API_URL = "https://script.google.com/macros/s/AKfycbzRlr0oTXqRnBW6NEQSpR3o4tphd0krW76bCfn7tEVZpzsg4oc_XtRiHVZXAimTtRFLmw/exec";

function resolveInternalUrl_(toUrl){
  // When merged into one file: map old resolveInternalUrl_("tenant.html") navigation to this same page's login view
  try{
    const u = String(toUrl || '');
    if (!u) return location.pathname + location.search;
    const isTenant = /tenant\.html(\?|#|$)/i.test(u);
    const isPortal = /portal\.html(\?|#|$)/i.test(u);
    if (isTenant) {
      const p = new URL(location.href);
      p.searchParams.set('view','login');
      return p.pathname + '?' + p.searchParams.toString();
    }
    if (isPortal) {
      const p = new URL(location.href);
      p.searchParams.delete('view');
      return p.pathname + '?' + p.searchParams.toString();
    }
    return u;
  }catch(e){
    return toUrl;
  }
}

function showLoginView_(msg){
  const lp = document.getElementById('loginPage');
  const pp = document.getElementById('portalPage');
  if (pp) pp.classList.add('hidden');
  if (lp) lp.classList.remove('hidden');

  if (msg){
    const el = document.getElementById('loginStatus');
    if (el){ el.textContent = msg; el.className = 'muted'; }
  }
}

function showPortalView_(){
  const lp = document.getElementById('loginPage');
  const pp = document.getElementById('portalPage');
  if (lp) lp.classList.add('hidden');
  if (pp) pp.classList.remove('hidden');
}

  /* ======================================================
   * ‚úÖ CH·ªêNG V√íNG L·∫∂P REDIRECT portal.html <-> tenant.html
   * ====================================================== */
  const YTH_REDIRECT_GUARD_KEY = "YTH_REDIRECT_GUARD";
  const YTH_RETURN_TO_KEY = "YTH_RETURN_TO";
  const REDIRECT_MAX = 2;        // t·ªëi ƒëa 2 l·∫ßn/phi√™n
  const REDIRECT_TTL_MS = 15000; // trong 15s m√† v·∫´n l·∫∑p => d·ª´ng

  function guardRedirectOnce(toUrl){
    let g = {};
    try { g = JSON.parse(sessionStorage.getItem(YTH_REDIRECT_GUARD_KEY) || "{}"); } catch(e){}
    const now = Date.now();

    if (!g.t || (now - g.t) > REDIRECT_TTL_MS) g = { t: now, c: 0 };
    g.c = (g.c || 0) + 1;
    g.t = now;
    sessionStorage.setItem(YTH_REDIRECT_GUARD_KEY, JSON.stringify(g));

    // l∆∞u returnTo ƒë·ªÉ tenant.html quay v·ªÅ ƒë√∫ng portal sau login
    try { sessionStorage.setItem(YTH_RETURN_TO_KEY, location.href); } catch(e){}

    if (g.c > REDIRECT_MAX) return false; // stop redirect
    location.replace(resolveInternalUrl_(toUrl));
    return true;
  }

  function ensureLoginActionUI(message){
    const note = document.getElementById("portalStatusNote");
    if (note) note.textContent = message || "B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c phi√™n ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.";

    // th√™m n√∫t "V·ªÅ trang ƒëƒÉng nh·∫≠p" (kh√¥ng tr√πng)
    const actions = document.querySelector(".header-actions");
    if (actions && !document.getElementById("btnGoTenant")){
      const a = document.createElement("a");
      a.id = "btnGoTenant";
      a.href = resolveInternalUrl_("tenant.html");
      a.className = "btn btn-outline";
      a.textContent = "V·ªÅ trang ƒëƒÉng nh·∫≠p";
      actions.appendChild(a);
    }
  }

  /* ======================================================
   * ‚úÖ SID/TS/NONCE (chu·∫©n ho√°)
   * ====================================================== */
  const YTH_SID_KEY = "YTH_SID";
  const YTH_NONCE_KEY = "YTH_NONCE";
  
  function setNonce(nonce){
    if (!nonce) return;
    try { sessionStorage.setItem(YTH_NONCE_KEY, String(nonce)); } catch(e){}
  }
  
  function getNonce(){
    try { return (sessionStorage.getItem(YTH_NONCE_KEY) || "").trim(); } catch(e){ return ""; }
  }
  
  function clearNonce(){
    try { sessionStorage.removeItem(YTH_NONCE_KEY); } catch(e){}
  }

  function getSID(){
    return (sessionStorage.getItem(YTH_SID_KEY) || localStorage.getItem(YTH_SID_KEY) || "").trim();
  }
  function clearSID(){
    try { sessionStorage.removeItem(YTH_SID_KEY); } catch(e){}
    try { localStorage.removeItem(YTH_SID_KEY); } catch(e){}
  }
  function nowTs(){ return Date.now(); }
  function makeNonce(){
    return `${Date.now()}_${Math.random().toString(16).slice(2)}_${Math.floor(Math.random()*1e6)}`;
  }

  /* ======================================================
   * ‚úÖ JSONP CALL (b·∫Øt bu·ªôc ƒë·ªÉ tr√°nh CORS)
   * - AUTO g·∫Øn sid + ts v√†o M·ªåI request
   * - ACTION GHI: th√™m nonce
   * ====================================================== */
   function callApi(action, params = {}) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
      const sid = getSID();
      const ts  = Date.now();
  
      const merged = { ...params, ts };
      if (sid) merged.sid = sid;
  
      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };
  
      const qs = new URLSearchParams({
        action,
        ...merged,
        callback: cb
      }).toString();
  
      const s = document.createElement("script");
      s.src = API_URL + "?" + qs;
      s.onerror = () => {
        cleanup();
        reject(new Error("JSONP load failed"));
      };
  
      document.body.appendChild(s);
  
      function cleanup(){
        try { delete window[cb]; } catch(e){}
        if (s.parentNode) s.parentNode.removeChild(s);
      }
    });
  }

   function callApiWrite(action, params = {}) {
    const nonce = getNonce();
    return callApi(action, { ...params, nonce });
  }

  /* ======================================================
   * ‚úÖ HELPERS UI
   * ====================================================== */
  let __selectedInvoiceIndex = 0;
  let __portalDataCache = null;

  function logoutTenant() {
    try { localStorage.removeItem(TENANT_STORAGE_KEY); } catch(e){}
    clearSID();
    clearNonce();   // ‚úÖ th√™m d√≤ng n√†y
    window.location.href = resolveInternalUrl_(resolveInternalUrl_("tenant.html"));
  }

  function formatVND(amount){
    if(amount===null||amount===undefined||amount==='') return '--';
    const num = Number(String(amount).replace(/[^\d.-]/g,''));
    if(isNaN(num)) return String(amount);
    return num.toLocaleString('vi-VN') + ' ƒë';
  }

  function maskLast4Digits(v){
    const s = String(v || '').replace(/\s+/g,'').trim();
    if (!s) return '--';
    const last4 = s.slice(-4);
    return '****' + last4;
  }

  function setActiveTab(group, tabName){
    document.querySelectorAll('.tab-btn.tab-' + group).forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.tab === tabName);
    });
    document.querySelectorAll('.tab-pane-' + group).forEach(pane=>{
      pane.classList.toggle('hidden', pane.id !== 'tab-' + tabName);
    });
  }

  function toDateObject(value) {
    if (!value) return null;
    if (value instanceof Date) return value;
    const d = new Date(value);
    return isNaN(d) ? null : d;
  }

  function formatDateDDMMYYYY(value) {
    const d = toDateObject(value);
    if (!d) return value || '';
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  function monthsBetween(from, to) {
    const d1 = new Date(from);
    const d2 = new Date(to);
    if (isNaN(d1) || isNaN(d2)) return null;

    let months =
      (d2.getFullYear() - d1.getFullYear()) * 12 +
      (d2.getMonth() - d1.getMonth());

    if (d2.getDate() < d1.getDate()) months -= 1;
    return months;
  }

  function openStatusDetail(context, statusText) {
    const ctx = context ? `Ng·ªØ c·∫£nh: ${context}\n` : '';
    alert(ctx + 'Tr·∫°ng th√°i: ' + statusText);
  }

  function renderStatusHTML(text, context) {
    const raw = (text == null) ? '' : String(text).trim();
    if (!raw) return '<span class="status-text muted">--</span>';

    const lower = raw.toLowerCase();
    const isIncomplete =
      lower.includes('ch∆∞a') ||
      lower.includes('chua') ||
      lower.includes('c√≤n thi·∫øu') ||
      lower.includes('con thieu');

    const isCompleted =
      lower.includes('ƒë√£') ||
      lower.includes('da ') ||
      lower === 'ok' ||
      lower === 'h·ª£p l·ªá' ||
      lower === 'hop le';

    if (isCompleted) return `<span class="status-text status-text-success">${raw}</span>`;
    if (!isIncomplete) return `<span class="status-text">${raw}</span>`;

    const safeStatus = raw.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    const safeContext = (context || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

    return `
      <button type="button"
        class="status-chip status-chip-warning"
        onclick="openStatusDetail('${safeContext}','${safeStatus}')">
        ${raw}
      </button>`;
  }

  /* ======================================================
   * ‚úÖ RENDER TH√îNG TIN PH√íNG
   * ====================================================== */
  function renderInfoCard(data){
    const $ = (id) => document.getElementById(id);

    const roomBadge   = $('roomBadge');
    const roomLabel   = $('roomLabel');
    const ownerName   = $('ownerName');
    const ownerCCCD   = $('ownerCCCD');
    const ownerPhone  = $('ownerPhone');

    const contractStatusEl  = $('contractStatus');
    const contractTypeEl    = $('contractType');
    const contractPeriodEl  = $('contractPeriod');
    const contractRentEl    = $('contractRent');
    const contractDepositEl = $('contractDeposit');
    const contractDueDayEl  = $('contractDueDay');
    const contractServices  = $('contractServices');
    const extendBtn         = $('extendContractBtn');

    const membersBody       = $('membersTableBody');
    const contractAlertBadge = $('contractAlertBadge');

    const isEmptyData =
      !data || typeof data !== 'object' || Object.keys(data).length === 0;

    function escapeHtml(s){
      return String(s ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function getContractStatusBadgeClass(statusText) {
      if (!statusText) return 'badge-neutral';
      const s = statusText.toString().toLowerCase();
      if (s.includes('hi·ªáu l·ª±c') || s.includes('ƒëang thu√™')) return 'badge-success';
      if (s.includes('s·∫Øp h·∫øt') || s.includes('ch·ªù gia h·∫°n')) return 'badge-warning';
      if (s.includes('h·∫øt h·∫°n') || s.includes('thanh l√Ω') || s.includes('ng∆∞ng')) return 'badge-danger';
      return 'badge-neutral';
    }

    function renderServiceItem(serviceText){
      const raw = String(serviceText ?? '').trim();
      if (!raw) return '';

      const t = raw.toLowerCase();
      let icon = 'üîπ';
      if (t.includes('ƒëi·ªán') || t.includes('dien')) icon = '‚ö°';
      else if (t.includes('n∆∞·ªõc') || t.includes('nuoc')) icon = 'üö∞';
      else if (t.includes('wifi')) icon = 'üì∂';
      else if (t.includes('gi·∫∑t') || t.includes('giat')) icon = 'üß∫';
      else if (t.includes('r√°c') || t.includes('rac')) icon = 'üóëÔ∏è';
      else if (t.includes('xe') || t.includes('gi·ªØ xe') || t.includes('giu xe')) icon = 'üÖøÔ∏è';

      return `<li><span class="svc-icon">${icon}</span>${escapeHtml(raw)}</li>`;
    }

    function renderTamTruStatusCell(member){
      const rawStatus = member && member.trangThaiTamTru ? String(member.trangThaiTamTru).trim() : '';
      const status = rawStatus || 'Ch∆∞a ƒëƒÉng k√Ω';

      const cccd = member && member.cccd ? String(member.cccd).trim() : '';
      const hoTen = member && member.hoTen ? String(member.hoTen).trim() : '';
      const lower = status.toLowerCase();

      let cls = 'status-chip status-chip-warning';
      if (lower.includes('ƒë√£ ƒëƒÉng k√Ω') || lower.includes('da dang ky')) cls = 'status-chip status-chip-success';
      else if (lower.includes('ƒë√£ x√°c nh·∫≠n') || lower.includes('da xac nhan')) cls = 'status-chip status-chip-info';
      else if (lower.includes('k√Ω t√™n') || lower.includes('ky ten')) cls = 'status-chip status-chip-info';
      else if (lower.includes('ch·ªù k·∫øt qu·∫£') || lower.includes('cho ket qua')) cls = 'status-chip status-chip-info';
      else if (lower.includes('nh·∫≠n k·∫øt qu·∫£') || lower.includes('nhan ket qua')) cls = 'status-chip status-chip-info';

      const safeCCCD = escapeHtml(cccd);
      const safeName = escapeHtml(hoTen);
      const safeStatus = escapeHtml(status);

      return `
        <button type="button"
          class="${cls}"
          onclick="openTempStayModal('${safeCCCD}','${safeName}','${safeStatus}')">
          ${escapeHtml(status)}
        </button>
      `;
    }

    if (isEmptyData) {
      const skeletonTargets = [
        roomBadge, roomLabel,
        ownerName, ownerCCCD, ownerPhone,
        contractStatusEl, contractTypeEl,
        contractPeriodEl, contractRentEl,
        contractDepositEl, contractDueDayEl
      ];

      skeletonTargets.forEach(el => {
        if (!el) return;
        el.textContent = '';
        el.classList.add('skeleton');
      });

      if (contractServices) contractServices.innerHTML = '<li class="skeleton">ƒêang t·∫£i th√¥ng tin d·ªãch v·ª•...</li>';
      if (membersBody) membersBody.innerHTML = '<tr><td colspan="6" class="muted skeleton">ƒêang t·∫£i danh s√°ch ng∆∞·ªùi ·ªü...</td></tr>';

      if (contractAlertBadge) {
        contractAlertBadge.textContent = '';
        contractAlertBadge.classList.add('hidden');
        contractAlertBadge.classList.remove('contract-alert-red','contract-alert-yellow');
      }
      if (extendBtn) extendBtn.style.display = 'none';
      return;
    }

    const allTargets = [
      roomBadge, roomLabel,
      ownerName, ownerCCCD, ownerPhone,
      contractStatusEl, contractTypeEl,
      contractPeriodEl, contractRentEl,
      contractDepositEl, contractDueDayEl
    ];
    allTargets.forEach(el => { if (el) el.classList.remove('skeleton'); });

    const roomCode = (data && data.roomCode) ? data.roomCode : '--';
    if (roomBadge) roomBadge.textContent = 'Ph√≤ng: ' + roomCode;
    if (roomLabel) roomLabel.textContent = roomCode;

    const chuPhong = (data && data.chuPhong) ? data.chuPhong : {};
    if (ownerName)  ownerName.textContent  = chuPhong.hoTen     || '--';
    if (ownerCCCD)  ownerCCCD.textContent  = chuPhong.cccd ? maskLast4Digits(chuPhong.cccd) : '--';
    if (ownerPhone) ownerPhone.textContent = chuPhong.dienThoai ? maskLast4Digits(chuPhong.dienThoai) : '--';

    const contract = (data && data.contract) ? data.contract : null;

    let monthsLeft = null;
    if (contract && contract.ngayKT) monthsLeft = monthsBetween(new Date(), contract.ngayKT);

    let warningClass = "";
    if (monthsLeft != null) {
      if (monthsLeft <= 1) warningClass = "contract-alert-red";
      else if (monthsLeft <= 2) warningClass = "contract-alert-yellow";
    }

    if (contractAlertBadge) {
      contractAlertBadge.classList.add('hidden');
      contractAlertBadge.classList.remove('contract-alert-red','contract-alert-yellow');
      contractAlertBadge.textContent = '';

      if (warningClass) {
        const m = (monthsLeft == null) ? '' : String(monthsLeft);
        contractAlertBadge.textContent =
          (warningClass === 'contract-alert-red')
            ? `‚ö† S·∫Øp h·∫øt h·∫°n (${m} th√°ng)`
            : `‚è≥ C√≤n ${m} th√°ng`;
        contractAlertBadge.classList.remove('hidden');
        contractAlertBadge.classList.add(warningClass);
      }
    }

    if (contractStatusEl) {
      const text = contract ? (contract.trangThai || '--') : '--';
      contractStatusEl.textContent = text;
      contractStatusEl.classList.remove('badge-success','badge-warning','badge-danger','badge-neutral');
      contractStatusEl.classList.add(getContractStatusBadgeClass(text));
    }

    if (contractTypeEl) contractTypeEl.textContent = contract ? (contract.loaiHD || '--') : '--';

    if (contractPeriodEl) {
      let baseText = '--';
      let daysLeftText = '';

      if (contract && (contract.ngayBD || contract.ngayKT)) {
        const startRaw = contract.ngayBD ? contract.ngayBD : '';
        const endRaw   = contract.ngayKT ? contract.ngayKT : '';
        const start = startRaw ? formatDateDDMMYYYY(startRaw) : '';
        const end   = endRaw   ? formatDateDDMMYYYY(endRaw)   : '';
        baseText = (start && end) ? (start + ' ‚Äì ' + end) : (start || end || '--');

        const endDateObj = toDateObject(endRaw);
        if (endDateObj) {
          const today = new Date();
          today.setHours(0,0,0,0);
          const diffMs   = endDateObj.getTime() - today.getTime();
          const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

          if (diffDays >= 0) {
            let cls = '';
            if (diffDays < 30) cls = 'days-left-red';
            else if (diffDays < 60) cls = 'days-left-yellow';
            if (cls) daysLeftText = ` <span class="${cls}">(c√≤n ${diffDays} ng√†y)</span>`;
          }
        }
      }
      contractPeriodEl.innerHTML = escapeHtml(baseText) + daysLeftText;
    }

    if (contractRentEl) contractRentEl.textContent = (contract && contract.tienThue != null) ? formatVND(contract.tienThue) : '--';
    if (contractDepositEl) contractDepositEl.textContent = (contract && contract.tienCoc != null) ? formatVND(contract.tienCoc) : '--';
    if (contractDueDayEl) contractDueDayEl.textContent = contract ? (contract.ngayThuTien || '--') : '--';

    if (contractServices) {
      if (contract && Array.isArray(contract.dichVuKemTheo) && contract.dichVuKemTheo.length) {
        contractServices.innerHTML = contract.dichVuKemTheo.map(renderServiceItem).join('');
      } else if (contract) {
        contractServices.innerHTML = '<li class="muted">Kh√¥ng c√≥</li>';
      } else {
        contractServices.innerHTML = '<li class="muted">Kh√¥ng c√≥ h·ª£p ƒë·ªìng.</li>';
      }
    }

    if (extendBtn) {
      if (contract && contract.coTheGiaHan) {
        extendBtn.style.display = 'inline-flex';
        extendBtn.textContent = "Gia h·∫°n h·ª£p ƒë·ªìng";
        extendBtn.classList.remove('btn-disabled','btn-warning','btn-danger','btn-accent');

        if (monthsLeft != null) {
          if (monthsLeft <= 1) extendBtn.classList.add("btn-danger");
          else if (monthsLeft <= 2) extendBtn.classList.add("btn-warning");
          else extendBtn.classList.add("btn-accent");
        } else {
          extendBtn.classList.add("btn-accent");
        }
      } else {
        extendBtn.style.display = 'none';
      }
    }

    if (membersBody) {
      membersBody.innerHTML = '';
      const members = Array.isArray(data.members) ? data.members : [];

      if (!members.length) {
        membersBody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ ng∆∞·ªùi ·ªü.</td></tr>';
      } else {
        members.forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(m.hoTen || '')}</td>
            <td>${escapeHtml(m.dienThoai || '')}</td>
            <td>${escapeHtml(m.cccd || '')}</td>
            <td>${escapeHtml(m.bienSo || '')}</td>
            <td>${m.ngayTamTru ? escapeHtml(formatDateDDMMYYYY(m.ngayTamTru)) : ''}</td>
            <td>${renderTamTruStatusCell(m)}</td>
          `;
          membersBody.appendChild(tr);
        });
      }
    }

    const assetsBody = $('assetsTableBody');
    if (assetsBody) {
      assetsBody.innerHTML = '';
      const assets = Array.isArray(data.assets) ? data.assets : [];

      if (!assets.length) {
        assetsBody.innerHTML = '<tr><td colspan="5" class="muted">Ch∆∞a c√≥ thi·∫øt b·ªã / t√†i s·∫£n cho ph√≤ng.</td></tr>';
      } else {
        assets.forEach((a)=>{
          const assetId = String(a.id || a.assetId || '').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
          const assetName = String(a.tenThietBi || a.tenTaiSan || '').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="assets-name">${escapeHtml(a.tenThietBi || a.tenTaiSan || '')}</td>
            <td>${escapeHtml(a.tinhTrang || '')}</td>
            <td>${escapeHtml(a.baoHanh || '')}</td>
            <td>${a.baoTriGanNhat ? escapeHtml(formatDateDDMMYYYY(a.baoTriGanNhat)) : ''}</td>
            <td>
              <button type="button" class="btn btn-outline btn-sm"
                onclick="openAssetReportModal('${assetId}','${assetName}')">B√°o h·ªèng</button>
            </td>
          `;
          assetsBody.appendChild(tr);
        });
      }
    }
  }

  function openAssetReportModal(assetId, assetName){
    alert('B√°o h·ªèng thi·∫øt b·ªã: ' + (assetName || '') + '\n(ID: ' + (assetId || '-') + ')');
  }

  /* ======================================================
   * ‚úÖ T·∫†M TR√ö
   * ====================================================== */
  let __tempStayCurrent = { cccd:'', roomCode:'', status:'' };

  function openTempStayModal(cccd, hoTen, statusText){
    const modal = document.getElementById('tempStayModal');
    if (!modal) return;

    const roomCode = (__portalDataCache && __portalDataCache.roomCode) ? __portalDataCache.roomCode : '';
    __tempStayCurrent = { cccd: String(cccd||''), roomCode: String(roomCode||''), status: String(statusText||'') };

    setTempStayEditable_(false);
    setTempStayConfirmVisible_(false);

    document.getElementById('tsHoTen').value = hoTen || '';
    document.getElementById('tsCCCD').value = cccd || '';
    document.getElementById('tsNgaySinh').value = '';
    document.getElementById('tsGioiTinh').value = '';
    document.getElementById('tsDienThoai').value = '';
    document.getElementById('tsNgheNghiep').value = '';
    document.getElementById('tsNoiThuongTru').value = '';
    document.getElementById('tsEmail').value = '';
    document.getElementById('tsDiaChiTamTru').value = '';
    document.getElementById('tsThoiGian').textContent = '--';
    document.getElementById('tsGhiChuNoiBo').textContent = '--';

    const meta = document.getElementById('tempStayMeta');
    if (meta) meta.textContent = `Ph√≤ng: ${roomCode || '--'} ‚Ä¢ Tr·∫°ng th√°i: ${statusText || '--'}`;

    const notice = document.getElementById('tsNotice');
    if (notice) notice.textContent = 'ƒêang t·∫£i th√¥ng tin t·∫°m tr√∫...';

    modal.classList.remove('hidden');
    modal.classList.add('show');

    callApi('tempStayGet', { roomCode: roomCode || '', cccd: cccd || '' })
      .then(out=>{
        if (!out || !out.success){
          if (notice) notice.textContent = (out && out.message) ? out.message : 'Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin t·∫°m tr√∫.';
          return;
        }

        const tenant = out.tenant || {};
        const tempStay = out.tempStay || null;

        document.getElementById('tsHoTen').value = tenant.hoTen || (hoTen||'');
        document.getElementById('tsCCCD').value = tenant.cccd || (cccd||'');
        document.getElementById('tsNgaySinh').value = tenant.ngaySinh || '';
        document.getElementById('tsGioiTinh').value = tenant.gioiTinh || '';
        document.getElementById('tsDienThoai').value = tenant.dienThoai || '';
        document.getElementById('tsNgheNghiep').value = tenant.ngheNghiep || '';
        document.getElementById('tsNoiThuongTru').value = tenant.noiThuongTru || '';
        document.getElementById('tsEmail').value = tenant.email || '';
        document.getElementById('tsDiaChiTamTru').value = out.diaChiTamTru || '';

        const st = (tempStay && tempStay.trangThai) ? String(tempStay.trangThai) : (statusText || '');
        if (meta) meta.textContent = `Ph√≤ng: ${roomCode || '--'} ‚Ä¢ Tr·∫°ng th√°i: ${st || '--'}`;

        document.getElementById('tsThoiGian').textContent =
          (tempStay && tempStay.thoiGianTamTru) ? String(tempStay.thoiGianTamTru) : '--';
        document.getElementById('tsGhiChuNoiBo').textContent =
          (tempStay && tempStay.ghiChuNoiBo) ? String(tempStay.ghiChuNoiBo) : '--';

        const lower = (st || '').toLowerCase();
        const canConfirm =
          (!tempStay) &&
          (lower.includes('ch∆∞a') || lower.includes('chua') || lower.includes('ch∆∞a ƒëƒÉng k√Ω') || lower.includes('chua dang ky') || lower === '');

        if (canConfirm){
          setTempStayEditable_(true);
          setTempStayConfirmVisible_(true);
          if (notice) notice.textContent = 'Vui l√≤ng ki·ªÉm tra, ch·ªânh s·ª≠a (n·∫øu c·∫ßn) r·ªìi b·∫•m X√°c nh·∫≠n.';
        } else {
          setTempStayEditable_(false);
          setTempStayConfirmVisible_(false);
          if (notice) notice.textContent = 'H·ªì s∆° ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n. B·∫°n c√≥ th·ªÉ xem tr·∫°ng th√°i, th·ªùi h·∫°n v√† ghi ch√∫ n·ªôi b·ªô t·∫°i ƒë√¢y.';
        }
      })
      .catch(err=>{
        console.error('openTempStayModal error:', err);
        if (notice) notice.textContent = 'L·ªói k·∫øt n·ªëi (kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin t·∫°m tr√∫).';
      });
  }

  function closeTempStayModal(){
    const modal = document.getElementById('tempStayModal');
    if (!modal) return;
    modal.classList.remove('show');
    modal.classList.add('hidden');
  }

  function setTempStayEditable_(editable){
    ['tsHoTen','tsNgaySinh','tsGioiTinh','tsDienThoai','tsNgheNghiep','tsNoiThuongTru','tsEmail'].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (el.tagName === 'SELECT') el.disabled = !editable;
      else el.readOnly = !editable;
    });
  }

  function setTempStayConfirmVisible_(visible){
    const btn = document.getElementById('tsConfirmBtn');
    if (btn) btn.style.display = visible ? 'inline-flex' : 'none';
  }

  async function submitTempStayConfirm(){
    const roomCode = (__portalDataCache && __portalDataCache.roomCode) ? __portalDataCache.roomCode : '';
    const cccd = document.getElementById('tsCCCD').value || '';

    const notice = document.getElementById('tsNotice');
    if (notice) notice.textContent = 'ƒêang g·ª≠i x√°c nh·∫≠n...';

    try{
      const out = await callApiWrite('tempStaySubmit', {
        roomCode: roomCode || '',
        cccd: cccd || '',
        hoTen: document.getElementById('tsHoTen').value || '',
        ngaySinh: document.getElementById('tsNgaySinh').value || '',
        gioiTinh: document.getElementById('tsGioiTinh').value || '',
        dienThoai: document.getElementById('tsDienThoai').value || '',
        ngheNghiep: document.getElementById('tsNgheNghiep').value || '',
        noiThuongTru: document.getElementById('tsNoiThuongTru').value || '',
        email: document.getElementById('tsEmail').value || ''
      });

      if (out && out.success){
        if (notice) notice.textContent = 'ƒê√£ ghi nh·∫≠n x√°c nh·∫≠n t·∫°m tr√∫. Ch·ªß nh√† s·∫Ω ti·∫øp nh·∫≠n v√† x·ª≠ l√Ω.';
        closeTempStayModal();

        const tenant = JSON.parse(localStorage.getItem(TENANT_STORAGE_KEY) || '{}');
        if (tenant && tenant.maPhong){
          fetchData(tenant.maPhong, tenant.identity || '');
        }
      } else {
        if (notice) notice.textContent = (out && out.message) ? out.message : 'Kh√¥ng g·ª≠i ƒë∆∞·ª£c x√°c nh·∫≠n.';
      }
    }catch(err){
      console.error('submitTempStayConfirm error:', err);
      if (notice) notice.textContent = 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
    }
  }

  /* ======================================================
   * ‚úÖ H√ìA ƒê∆†N / THANH TO√ÅN
   * ====================================================== */
  function isInvoicePaid_(inv){
    const st = String(inv && inv.trangThai || '').toLowerCase();
    return (
      st.includes('ƒë·ªß') || st.includes('da du') ||
      st.includes('ƒë√£ thu') || st.includes('da thu') ||
      st.includes('ƒë√£ thanh to√°n') || st.includes('da thanh toan') ||
      st.includes('ho√†n t·∫•t') || st.includes('hoan tat')
    );
  }

  function renderInvoiceStatusCell_(inv, index){
    if (!inv) return '<span class="pill pill-neutral">--</span>';
    const paid = isInvoicePaid_(inv);
    if (paid) return '<span class="pill pill-success">ƒê√£ thanh to√°n</span>';
    return `<button type="button" class="btn btn-danger btn-sm" onclick="openPaymentModal(${index})">Thanh to√°n</button>`;
  }

  function renderPaymentCard(data){
    __portalDataCache = data || null;

    const historyBody = document.getElementById('paymentHistoryBody');
    if (!historyBody) return;
    historyBody.innerHTML = '';

    const invoices = (data && Array.isArray(data.invoices)) ? data.invoices : [];

    const isContractActive =
      !!(data && data.contract && String(data.contract.trangThai || '').toLowerCase().includes('hi·ªáu l·ª±c'));

    if (!isContractActive) {
      historyBody.innerHTML = `<tr><td colspan="4" class="muted">H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.</td></tr>`;
      renderInvoiceDetail_(null);
      return;
    }

    if (!invoices.length){
      historyBody.innerHTML = `<tr><td colspan="4" class="muted">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o cho ph√≤ng n√†y.</td></tr>`;
      renderInvoiceDetail_(null);
      return;
    }

    invoices.forEach((inv, i)=>{
      const tr = document.createElement('tr');
      tr.classList.toggle('row-active', i === __selectedInvoiceIndex);
      tr.innerHTML = `
        <td>${inv.namThang || ''}</td>
        <td>${formatVND(inv.tongPhaiThu)}</td>
        <td>${renderInvoiceStatusCell_(inv, i)}</td>
        <td>
          <button type="button" class="btn btn-outline btn-sm" onclick="selectInvoice(${i})">Chi ti·∫øt</button>
        </td>
      `;
      historyBody.appendChild(tr);
    });

    if (__selectedInvoiceIndex >= invoices.length) __selectedInvoiceIndex = 0;
    renderInvoiceDetail_(invoices[__selectedInvoiceIndex]);
  }

  function selectInvoice(index){
    __selectedInvoiceIndex = Number(index) || 0;

    const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
      ? __portalDataCache.invoices : [];

    const rows = document.querySelectorAll('#paymentHistoryBody tr');
    rows.forEach((r, i)=> r.classList.toggle('row-active', i === __selectedInvoiceIndex));

    const inv = invoices[__selectedInvoiceIndex] || null;
    renderInvoiceDetail_(inv);
    setActiveTab('pay', 'detail');
  }

  function renderInvoiceDetail_(inv){
    const kyEl = document.getElementById('invKy');
    const pillEl = document.getElementById('invStatusPill');
    const payBtn = document.getElementById('invPayBtn');

    if (!inv){
      if (kyEl) kyEl.textContent = 'K·ª≥: --';
      if (pillEl){ pillEl.className = 'pill pill-neutral'; pillEl.textContent = '--'; }
      if (payBtn) payBtn.style.display = 'none';

      ['invNgayTinh','invTienPhong','invTongDV','invPhatSinh','invGiamTru','invThieuTruoc','invPhaiThu','invServiceTotal'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.textContent = '--';
      });
      const dvBody = document.getElementById('invoiceServiceBody');
      if (dvBody) dvBody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu d·ªãch v·ª•.</td></tr>';

      updateBankAndQr_(null);
      return;
    }

    if (kyEl) kyEl.textContent = 'K·ª≥: ' + (inv.namThang || '--');

    const paid = isInvoicePaid_(inv);
    if (pillEl){
      pillEl.className = paid ? 'pill pill-success' : 'pill pill-danger';
      pillEl.textContent = paid ? 'ƒê√£ thanh to√°n' : 'C√≤n thi·∫øu';
    }
    if (payBtn) payBtn.style.display = paid ? 'none' : 'inline-flex';

    const c = inv.chiTiet || {};
    document.getElementById('invNgayTinh').textContent =
      (c.ngayTinhHD != null && c.ngayTinhHD !== '') ? (parseInt(c.ngayTinhHD,10) + ' ng√†y') : '--';
    document.getElementById('invTienPhong').textContent  = formatVND(c.tienPhongTT);
    document.getElementById('invTongDV').textContent     = formatVND(
      (c.tongDichVu != null && c.tongDichVu !== '') ? c.tongDichVu : (inv.tongDN_DV || 0)
    );
    document.getElementById('invPhatSinh').textContent   = formatVND(c.phatSinhKhac);
    document.getElementById('invGiamTru').textContent    = formatVND(c.giamTruKhac);
    document.getElementById('invThieuTruoc').textContent = formatVND(c.thieuKyTruoc);
    document.getElementById('invPhaiThu').textContent    = formatVND(c.phaiThu);

    const dvBody = document.getElementById('invoiceServiceBody');
    const dvTotalEl = document.getElementById('invServiceTotal');

    if (dvBody){
      dvBody.innerHTML = '';

      const services = Array.isArray(inv.services) ? inv.services : [];
      const serviceMap =
        (__portalDataCache && (__portalDataCache.serviceMap || __portalDataCache.servicesMap || __portalDataCache.serviceMetaMap))
          ? (__portalDataCache.serviceMap || __portalDataCache.servicesMap || __portalDataCache.serviceMetaMap)
          : {};

      let total = 0;

      const filtered = services.filter(s=>{
        const maDV = String(s.maDV || s.tenDichVu || '').trim();
        const thanhTien = Number(s.thanhTien || 0);
        return !!maDV && thanhTien !== 0;
      });

      if (!filtered.length){
        dvBody.innerHTML = '<tr><td colspan="6" class="muted">Kh√¥ng c√≥ d·ªãch v·ª• ph√°t sinh.</td></tr>';
        if (dvTotalEl) dvTotalEl.textContent = formatVND(0);
      } else {
        filtered.forEach(s=>{
          const thanhTien = Number(s.thanhTien || 0) || 0;
          total += thanhTien;

          const idDV = String(s.idDV || '').trim();
          const maDV = String(s.maDV || s.tenDichVu || '').trim();

          const metaById = idDV && serviceMap[idDV] ? serviceMap[idDV] : null;
          const metaByMa = !metaById && maDV && serviceMap[maDV] ? serviceMap[maDV] : null;
          const meta = metaById || metaByMa || {};
          const loai = String(meta.loai || meta['Lo·∫°i'] || meta.type || '').trim().toLowerCase();
          const isTheoSoLuong = loai === 'theo s·ªë l∆∞·ª£ng' || loai === 'theo so luong';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="dv-name">${maDV}</td>
            <td>${isTheoSoLuong ? '-' : (s.soDau ?? '')}</td>
            <td>${isTheoSoLuong ? '-' : (s.soCuoi ?? '')}</td>
            <td>${s.soLuong ?? ''}</td>
            <td class="dv-money">${formatVND(s.donGia)}</td>
            <td class="dv-money">${formatVND(thanhTien)}</td>
          `;
          dvBody.appendChild(tr);
        });

        if (dvTotalEl) dvTotalEl.textContent = formatVND(total);
      }
    }

    updateBankAndQr_(inv);
  }

  function updateBankAndQr_(inv){
    const bankInfoEl = document.getElementById('invBankInfo');
    const qrContainer = document.getElementById('qrContainer');

    const bankInfo =
      (inv && inv.chiTiet && inv.chiTiet.bankInfo) ? inv.chiTiet.bankInfo : null;

    if (bankInfoEl){
      const bankText = [
        bankInfo?.soTaiKhoan ? ('S·ªë t√†i kho·∫£n: ' + bankInfo.soTaiKhoan) : '',
        bankInfo?.chuTaiKhoan ? ('Ch·ªß t√†i kho·∫£n: ' + bankInfo.chuTaiKhoan) : '',
        bankInfo?.nganHang ? ('Ng√¢n h√†ng: ' + bankInfo.nganHang) : '',
        bankInfo?.chiNhanh ? ('CN ng√¢n h√†ng: ' + bankInfo.chiNhanh) : ''
      ].filter(Boolean).join('<br>');

      bankInfoEl.innerHTML = bankText || '--';
    }

    if (!qrContainer) return;
    qrContainer.innerHTML = '';

    const c = (inv && inv.chiTiet) ? inv.chiTiet : {};
    const qr = (c && (c.qrCode || c.qr || c.qr_code || c["QR Code"])) ||
               (inv && (inv.qrCode || inv.qr || inv.qr_code || inv["QR Code"])) || '';

    if (qr){
      const img = document.createElement('img');
      img.src = qr;
      img.alt = 'QR thanh to√°n';
      img.style.maxWidth = '160px';
      img.style.marginTop = '4px';
      qrContainer.appendChild(img);
    } else {
      qrContainer.textContent = 'Ch∆∞a c√≥ QR Code.';
    }
  }

  function renderMaintenance(data){
    const tbody = document.getElementById('maintenanceBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const list = (data && Array.isArray(data.maintenance)) ? data.maintenance : [];
    if (!list.length){
      tbody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>';
      return;
    }
    list.forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.tenTaiSan || ''}</td>
        <td>${m.loaiCongViec || ''}</td>
        <td>${m.ngayDuKien ? formatDateDDMMYYYY(m.ngayDuKien) : ''}</td>
        <td>${m.ngayThucHien ? formatDateDDMMYYYY(m.ngayThucHien) : ''}</td>
        <td>${m.trangThai || ''}</td>
        <td>${m.ghiChu || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderMessages(data){
    const tbody = document.getElementById('messageBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const msgs = (data && Array.isArray(data.messages)) ? data.messages : [];
    if (!msgs.length){
      tbody.innerHTML = '<tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>';
      return;
    }
    msgs.forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.type || m.loai || ''}</td>
        <td>${m.createdAt || m.ngay || ''}</td>
        <td>${m.content || m.noiDung || ''}</td>
        <td>${renderStatusHTML(m.status || m.trangThai || '', 'message')}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openMaintenanceForm(){ alert('Form b√°o h·ªèng: b·∫°n c√≥ th·ªÉ d√πng tenantMaintenance API nh∆∞ ƒë√£ c·∫•u h√¨nh ·ªü Apps Script.'); }

  function openPaymentModal(index){
    if (index !== undefined && index !== null) __selectedInvoiceIndex = Number(index) || 0;

    const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
      ? __portalDataCache.invoices : [];
    const inv = invoices[__selectedInvoiceIndex] || null;

    const modal = document.getElementById('paymentModal');
    if (!modal) return;

    const meta = document.getElementById('paymentModalMeta');
    if (meta) meta.textContent = 'H√≥a ƒë∆°n: ' + (inv ? (inv.namThang || '--') : '--');

    const fileInput = document.getElementById('paymentProofFile');
    const noteInput = document.getElementById('paymentNote');
    const preview = document.getElementById('paymentPreview');

    if (fileInput) fileInput.value = '';
    if (noteInput) noteInput.value = '';
    if (preview) preview.textContent = 'Ch∆∞a ch·ªçn ·∫£nh.';

    modal.classList.remove('hidden');
  }

  function closePaymentModal(){
    const modal = document.getElementById('paymentModal');
    if (modal) modal.classList.add('hidden');
  }

  document.addEventListener('change', (e)=>{
    if (e.target && e.target.id === 'paymentProofFile'){
      const file = e.target.files && e.target.files[0];
      const preview = document.getElementById('paymentPreview');
      if (!preview) return;

      if (!file){
        preview.textContent = 'Ch∆∞a ch·ªçn ·∫£nh.';
        preview.classList.add('muted');
        return;
      }

      preview.classList.remove('muted');
      preview.innerHTML = '';
      const img = document.createElement('img');
      img.alt = 'Phi·∫øu chuy·ªÉn kho·∫£n';
      img.className = 'payment-proof-img';
      img.src = URL.createObjectURL(file);
      preview.appendChild(img);
    }
  });

  async function submitPaymentProof(){
    const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
      ? __portalDataCache.invoices : [];
    const inv = invoices[__selectedInvoiceIndex] || null;

    const fileInput = document.getElementById('paymentProofFile');
    const noteInput = document.getElementById('paymentNote');

    const file = fileInput && fileInput.files ? fileInput.files[0] : null;
    const note = noteInput ? (noteInput.value || '') : '';

    try{
      const out = await callApiWrite('tenantPaymentProof', {
        roomCode: (__portalDataCache && __portalDataCache.roomCode) ? __portalDataCache.roomCode : '',
        invoiceId: inv && (inv.id || inv.invoiceId || inv.maHoaDon) ? (inv.id || inv.invoiceId || inv.maHoaDon) : '',
        namThang: inv && inv.namThang ? inv.namThang : '',
        note: note,
        hasFile: file ? '1' : '0'
      });

      if (out && out.success){
        alert('ƒê√£ g·ª≠i x√°c nh·∫≠n thanh to√°n cho ch·ªß nh√†.');
      } else {
        alert((out && out.message) || 'ƒê√£ ghi nh·∫≠n. N·∫øu ch∆∞a th·∫•y c·∫≠p nh·∫≠t, ch·ªß nh√† s·∫Ω ki·ªÉm tra v√† x√°c nh·∫≠n sau.');
      }

      closePaymentModal();

      const tenant = JSON.parse(localStorage.getItem(TENANT_STORAGE_KEY) || '{}');
      if (tenant && tenant.maPhong){
        fetchData(tenant.maPhong, tenant.identity || '');
      }
    } catch(err){
      console.error('submitPaymentProof error:', err);
      alert('Kh√¥ng g·ª≠i ƒë∆∞·ª£c x√°c nh·∫≠n (l·ªói k·∫øt n·ªëi). Vui l√≤ng th·ª≠ l·∫°i.');
    }
  }

  function downloadInvoicePdf(){ window.print(); }

  /* ======================================================
   * ‚úÖ FETCH DATA (QUAN TR·ªåNG)
   * - ƒê·ªïi action: tenantPortalObj (ƒë√∫ng theo function b·∫°n ƒëang c√≥)
   * ====================================================== */
  async function fetchData(){
  const note = document.getElementById('portalStatusNote');
  if (note) note.textContent = 'ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ h·ªá th·ªëng...';

  renderInfoCard(null); // skeleton

  try {
    const sid = getSID();
    if (!sid){
      if (note) note.textContent = "Thi·∫øu SID (phi√™n h·∫øt h·∫°n). Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.";
      showLoginView_("Phi√™n ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
      return;
    }

    // ‚úÖ A4.3b portal: tenantPortal & sid
    const data = await callApi("tenantPortal", { sid });

    console.log("RAW PORTAL DATA =", data);

    // Tu·ª≥ backend b·∫°n tr·∫£ ok/true hay success/true: ∆∞u ti√™n ok
    if (!data || data.ok !== true){
      if (note) note.textContent = data?.error || data?.message || "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu portal.";
      // n·∫øu SID sai/h·∫øt h·∫°n th√¨ quay v·ªÅ login
      showLoginView_("Phi√™n kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
      clearSID();
      return;
    }

    if (note) note.textContent = "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng.";

    // ‚úÖ n·∫øu server c·∫•p nonce ƒë·ªÉ action ghi th√¨ l∆∞u
    if (data.nonce) setNonce(data.nonce);

    __portalDataCache = data;

    renderInfoCard(data);
    renderPaymentCard(data);
    renderMaintenance(data);
    renderMessages(data);

  } catch (err) {
    console.error("fetchData error:", err);
    if (note) note.textContent = "L·ªói k·∫øt n·ªëi t·ªõi Apps Script.";
  }
}

  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.tab-btn.tab-info').forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveTab('info', btn.dataset.tab));
    });
    document.querySelectorAll('.tab-btn.tab-pay').forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveTab('pay', btn.dataset.tab));
    });

    let tenant = null;
    try {
      const saved = localStorage.getItem(TENANT_STORAGE_KEY);
      if (saved) tenant = JSON.parse(saved);
    } catch(e){}

    // ‚úÖ CH·∫∂N V√íNG L·∫∂P: kh√¥ng redirect c·ª©ng n·ªØa
    if (!tenant || !tenant.maPhong){
      const ok = guardRedirectOnce(resolveInternalUrl_("tenant.html"));
      if (!ok) ensureLoginActionUI('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p (ho·∫∑c d·ªØ li·ªáu ƒëƒÉng nh·∫≠p b·ªã m·∫•t). Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
      return;
    }

    // N·∫øu backend ƒëang enforce SID th√¨ ph·∫£i c√≥ SID
    const sid = getSID();
    if (!sid){
      const ok = guardRedirectOnce(resolveInternalUrl_("tenant.html"));
      if (!ok) ensureLoginActionUI('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n (thi·∫øu SID). Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
      return;
    }

    fetchData();
  });
  function jsonpCall(url, timeout = 15000) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1000);
    const script = document.createElement("script");
    let timer;

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    function cleanup() {
      if (timer) clearTimeout(timer);
      delete window[cb];
      if (script.parentNode) script.parentNode.removeChild(script);
    }

    timer = setTimeout(() => {
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeout);

    const u = new URL(url);
    u.searchParams.set("callback", cb);

    script.src = u.toString();
    script.onerror = () => {
      cleanup();
      reject(new Error("JSONP load error"));
    };

    document.body.appendChild(script);
  });
}


async function handleLoginSubmit(ev){
  if (ev) ev.preventDefault();

  const statusEl = document.getElementById("loginStatus");
  const btn = document.getElementById("btnLogin");

  const roomCode = String(document.getElementById("loginCode")?.value || "")
    .trim()
    .toUpperCase();
  const identity = String(document.getElementById("loginPhone")?.value || "")
    .trim();

  if (!roomCode || !identity){
    if (statusEl){
      statusEl.textContent = "Vui l√≤ng nh·∫≠p M√£ ph√≤ng v√† SƒêT/CCCD.";
      statusEl.className = "portal-status muted";
    }
    return;
  }

  if (btn){
    btn.disabled = true;
    btn.textContent = "ƒêang ƒëƒÉng nh·∫≠p...";
  }
  if (statusEl){
    statusEl.textContent = "ƒêang x√°c th·ª±c...";
    statusEl.className = "portal-status muted";
  }

  try{
    // ‚úÖ A4.3b login th·∫≠t: TenantLogin (backend c·ªßa b·∫°n ƒëang test)
    const res = await callApi("TenantLogin", { roomCode, identity });

    if (!res || res.ok !== true){
      throw new Error(res?.error || res?.message || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");
    }

    // ‚úÖ L∆∞u SID (+ expiresAt n·∫øu c√≥)
    if (res.sid){
      try { sessionStorage.setItem(YTH_SID_KEY, res.sid); } catch(e){}
      try { localStorage.setItem(YTH_SID_KEY, res.sid); } catch(e){}
    }
    if (res.expiresAt){
      try { localStorage.setItem("YTH_SID_EXPIRES", String(res.expiresAt)); } catch(e){}
    }

    // ‚úÖ L∆∞u tenant ƒë·ªÉ UI bi·∫øt ph√≤ng/identity
    const tenantObj = { maPhong: roomCode, identity };
    saveTenantToStorage(tenantObj);

    showPortalView_();

    // ‚úÖ v√†o portal b·∫±ng SID
    await fetchData();

  }catch(err){
    console.error("LOGIN ERROR:", err);
    if (statusEl){
      statusEl.textContent = "L·ªói: " + (err?.message || err);
      statusEl.className = "portal-status muted";
    }
  }finally{
    if (btn){
      btn.disabled = false;
      btn.textContent = "ƒêƒÉng nh·∫≠p";
    }
  }
}


function initMergedBoot_(){
  // bind login events if login page exists
  const form = document.getElementById("loginForm");
  if (form && !form.__bound){
    form.addEventListener("submit", handleLoginSubmit);
    form.__bound = true;
  }
  const rb = document.getElementById("roomBadgeLogin");
  const qs = new URLSearchParams(location.search);
  const room = String(qs.get("room") || qs.get("roomCode") || "").trim().toUpperCase();
  if (rb && room) rb.textContent = room;

  // Decide view
  const view = String(qs.get("view") || "").toLowerCase();
  const sid = getSID();
  const tenant = readTenantFromStorage();
  const hasSession = !!(sid && tenant && (tenant.maPhong || tenant.roomCode || tenant.MaPhong));

  if (view === "login" || !hasSession){
    showLoginView_(!hasSession ? "Vui l√≤ng ƒëƒÉng nh·∫≠p." : "");
  }else{
    showPortalView_();
    const t = readTenantFromStorage();
    if (t && (t.maPhong || t.roomCode)){
      fetchData();
    }
  }
}

// Run after all portal DOMContentLoaded handlers, but safe to run now as well
document.addEventListener("DOMContentLoaded", initMergedBoot_);

</script>
</body>
</html>







