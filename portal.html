<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Portal t√†i kho·∫£n ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="yt-home-common.css" />
</head>
<body class="tenant-body">
  <div class="container">
    <header class="header">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn btn-outline">Trang xem ph√≤ng</a>
        <button type="button" class="btn btn-outline" onclick="logoutTenant()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">Xin ch√†o, c∆∞ d√¢n YT Home üè°</div>
      <div class="page-subtitle">
        ƒê√¢y l√† portal n·ªôi b·ªô d√†nh cho t√†i kho·∫£n ph√≤ng. D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ Google Sheet qua Apps Script.
      </div>
      <div id="portalStatusNote" class="portal-status">
        ƒêang t·∫£i d·ªØ li·ªáu ph√≤ng t·ª´ h·ªá th·ªëng...
      </div>

      <div class="grid">
        <!-- C·ªòT TR√ÅI: TH√îNG TIN -->
        <section class="card">
          <div class="card-title">Th√¥ng tin ph√≤ng</div>
          <div class="badge" id="roomBadge">Ph√≤ng: --</div>

          <div class="tab-row">
            <button class="tab-btn tab-info active" data-tab="owner">Ch·ªß ph√≤ng</button>
            <button class="tab-btn tab-info" data-tab="contract">T√≥m t·∫Øt h·ª£p ƒë·ªìng</button>
            <button class="tab-btn tab-info" data-tab="members">Ng∆∞·ªùi & xe</button>
          </div>

          <!-- TAB CH·ª¶ PH√íNG -->
          <div class="tab-pane tab-pane-info" id="tab-owner">
            <div class="info-row">
              <span class="info-label">Ph√≤ng:</span>
              <span class="info-value" id="roomLabel">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">T√™n ch·ªß ph√≤ng:</span>
              <span class="info-value owner-name" id="ownerName">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë CCCD:</span>
              <span class="info-value" id="ownerCCCD">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
              <span class="info-value" id="ownerPhone">--</span>
            </div>
            <div class="small-note">
              Th√¥ng tin ƒë∆∞·ª£c l·∫•y t·ª´ sheet <strong>Kh√°ch thu√™</strong> (Lo·∫°i = "Ch·ªß ph√≤ng", Tr·∫°ng th√°i = "ƒêang ·ªü").
            </div>
          </div>

          <!-- TAB H·ª¢P ƒê·ªíNG -->
          <div class="tab-pane tab-pane-info hidden" id="tab-contract">
            <ul class="list">
              <li>Tr·∫°ng th√°i: <strong id="contractStatus">--</strong></li>
              <li>Lo·∫°i Hƒê: <strong id="contractType">--</strong></li>
              <li>Th·ªùi gian: <strong id="contractPeriod">--</strong></li>
              <li>Ti·ªÅn thu√™: <strong id="contractRent">--</strong></li>
              <li>Ti·ªÅn c·ªçc: <strong id="contractDeposit">--</strong></li>
              <li>Ng√†y thu ti·ªÅn: <strong id="contractDueDay">--</strong></li>
              <li>D·ªãch v·ª• k√®m theo:</li>
            </ul>
            <ul class="list" id="contractServices"></ul>

            <button id="extendContractBtn" class="btn" style="margin-top:8px; display:none;">
              K√Ω ti·∫øp h·ª£p ƒë·ªìng
            </button>

            <div class="small-note">
              Hi·ªÉn th·ªã t·ª´ sheet <strong>H·ª£p ƒë·ªìng</strong>. N√∫t "K√Ω ti·∫øp h·ª£p ƒë·ªìng" ch·ªâ hi·ªán khi c√≤n &lt;= 1 th√°ng tr∆∞·ªõc ng√†y k·∫øt th√∫c.
            </div>
          </div>

          <!-- TAB NG∆Ø·ªúI & XE -->
          <div class="tab-pane tab-pane-info hidden" id="tab-members">
            <table class="table-like">
              <thead>
                <tr>
                  <th>H·ªç t√™n</th>
                  <th>ƒêi·ªán tho·∫°i</th>
                  <th>CCCD</th>
                  <th>Bi·ªÉn s·ªë</th>
                  <th>T·∫°m tr√∫</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="membersTableBody">
                <tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
              </tbody>
            </table>
            <div class="tenant-footer-actions">
              <span></span>
              <button class="btn" type="button" onclick="openTempStayForm()">ƒêƒÉng k√Ω t·∫°m tr√∫</button>
            </div>
          </div>
        </section>

        
        <!-- C·ªòT PH·∫¢I: THANH TO√ÅN -->
        <section class="card">
          <div class="card-title">Thanh to√°n</div>

          <div class="tab-row">
            <button class="tab-btn tab-pay active" data-tab="history">L·ªãch s·ª≠ thanh to√°n</button>
            <button class="tab-btn tab-pay" data-tab="detail">Chi ti·∫øt h√≥a ƒë∆°n</button>
          </div>

          <!-- TAB (1) L·ªäCH S·ª¨ THANH TO√ÅN -->
          <div class="tab-pane tab-pane-pay" id="tab-history">
            <table class="table-like">
              <thead>
                <tr>
                  <th>K·ª≥ (NƒÉm th√°ng)</th>
                  <th>T·ªïng ph·∫£i thu</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Chi ti·∫øt</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody">
                <tr>
                  <td colspan="4" class="muted">
                    H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="tenant-footer-actions">
              <span class="muted">Ch·ªâ hi·ªÉn th·ªã n·∫øu H·ª£p ƒë·ªìng c√≤n hi·ªáu l·ª±c.</span>
              <button class="btn" type="button" onclick="downloadInvoicePdf()">T·∫£i / In h√≥a ƒë∆°n</button>
            </div>
          </div>

          <!-- TAB (2) CHI TI·∫æT H√ìA ƒê∆†N -->
          <div class="tab-pane tab-pane-pay hidden" id="tab-detail">
            <div class="detail-head">
              <div class="detail-title">
                <div class="muted" id="invKy">K·ª≥: --</div>
              </div>
              <div class="detail-actions">
                <span id="invStatusPill" class="pill pill-neutral">--</span>
                <button id="invPayBtn" type="button" class="btn btn-danger btn-sm" style="display:none;" onclick="openPaymentModal()">
                  Thanh to√°n
                </button>
              </div>
            </div>

            <div id="invoiceSummary">
              <p><span class="inv-label">Ng√†y t√≠nh Hƒê:</span> <span class="inv-value" id="invNgayTinh">--</span></p>
              <p><span class="inv-label">Ti·ªÅn ph√≤ng thanh to√°n:</span> <span class="inv-value" id="invTienPhong">--</span></p>
              <p><span class="inv-label">Ph√°t sinh kh√°c:</span> <span class="inv-value" id="invPhatSinh">--</span></p>
              <p><span class="inv-label">Gi·∫£m tr·ª´ kh√°c:</span> <span class="inv-value" id="invGiamTru">--</span></p>
              <p><span class="inv-label">Thi·∫øu k·ª≥ tr∆∞·ªõc:</span> <span class="inv-value" id="invThieuTruoc">--</span></p>
              <p class="inv-total-row">
                <span class="inv-label">Ph·∫£i thu:</span>
                <span class="inv-total" id="invPhaiThu">--</span>
              </p>
            </div>

            <div class="section-title">B·∫£ng d·ªãch v·ª•</div>
            <div class="table-wrap">
              <table class="table-like table-dv">
                <thead>
                  <tr>
                    <th>T√™n d·ªãch v·ª•</th>
                    <th>S·ªë ƒë·∫ßu</th>
                    <th>S·ªë cu·ªëi</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>Th√†nh ti·ªÅn</th>
                  </tr>
                </thead>
                <tbody id="invoiceServiceBody">
                  <tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu d·ªãch v·ª•.</td></tr>
                </tbody>
                <tfoot>
                  <tr class="dv-total-row">
                    <td colspan="5" class="dv-total-label">T·ªïng</td>
                    <td class="dv-total" id="invServiceTotal">--</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- TH√îNG TIN CHUY·ªÇN KHO·∫¢N + QR (lu√¥n n·∫±m b√™n d∆∞·ªõi 2 tab) -->
          <div class="pay-bottom">
            <div class="section-title">Th√¥ng tin chuy·ªÉn kho·∫£n</div>
            <p class="small-note" id="invBankInfo">--</p>

            <div class="section-title">QR thanh to√°n</div>
            <div id="qrContainer" class="gallery-placeholder">Ch∆∞a c√≥ QR Code.</div>
          </div>
        </section>

      </div>

      <!-- H√ÄNG D∆Ø·ªöI: B·∫¢O TR√å + TIN NH·∫ÆN -->
      <div class="grid" style="margin-top:12px;">
        <!-- B·∫£o tr√¨ -->
        <section class="card">
          <div class="card-title">L·ªãch b·∫£o tr√¨</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>T√†i s·∫£n</th>
                <th>Lo·∫°i c√¥ng vi·ªác</th>
                <th>Ng√†y d·ª± ki·∫øn</th>
                <th>Ng√†y th·ª±c hi·ªán</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody id="maintenanceBody">
              <tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>
            </tbody>
          </table>
          <div class="tenant-footer-actions">
            <span class="muted">D·ªØ li·ªáu t·ª´ sheet "L·ªãch b·∫£o tr√¨".</span>
            <button type="button" class="btn" onclick="openMaintenanceForm()">B√°o h·ªèng</button>
          </div>
        </section>

        <!-- Tin nh·∫Øn / y√™u c·∫ßu -->
        <section class="card">
          <div class="card-title">Tin nh·∫Øn & y√™u c·∫ßu</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>Lo·∫°i</th>
                <th>Ng√†y</th>
                <th>N·ªôi dung</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="messageBody">
              <tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>
            </tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <!-- POPUP THANH TO√ÅN -->
  <div class="modal hidden" id="paymentModal" role="dialog" aria-modal="true" aria-labelledby="paymentModalTitle">
    <div class="modal-backdrop" onclick="closePaymentModal()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="paymentModalTitle">X√°c nh·∫≠n thanh to√°n</div>
        <button class="modal-x" type="button" onclick="closePaymentModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="small-note" id="paymentModalMeta">H√≥a ƒë∆°n: --</div>

        <label class="field">
          <div class="field-label">ƒê√≠nh k√®m phi·∫øu chuy·ªÉn kho·∫£n (·∫£nh)</div>
          <input type="file" id="paymentProofFile" accept="image/*" />
          <div class="field-help">C√≥ th·ªÉ ch·ª•p m√†n h√¨nh/·∫£nh bi√™n lai chuy·ªÉn kho·∫£n.</div>
        </label>

        <label class="field">
          <div class="field-label">Ghi ch√∫ cho ch·ªß nh√† (tu·ª≥ ch·ªçn)</div>
          <textarea id="paymentNote" rows="3" placeholder="V√≠ d·ª•: Em ƒë√£ chuy·ªÉn kho·∫£n l√∫c 20:15, nh·ªù ch·ªß nh√† ki·ªÉm tra gi√∫p ·∫°."></textarea>
        </label>

        <div id="paymentPreview" class="payment-preview muted">Ch∆∞a ch·ªçn ·∫£nh.</div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" type="button" onclick="closePaymentModal()">H·ªßy</button>
        <button class="btn btn-danger" type="button" onclick="submitPaymentProof()">G·ª≠i x√°c nh·∫≠n</button>
      </div>
    </div>
  </div>


  <script>
    const TENANT_STORAGE_KEY = "ytHomeTenant";
    const API_URL = "https://script.google.com/macros/s/AKfycbxYMPK9Ox-XPK9AGd4TmcPK_uglkgEUHw9zLbUlqclSVwjIq6Ciu5hycl_G_h0chY44/exec";
    let CURRENT_INVOICES = [];
    let CURRENT_SELECTED_INVOICE = null;

    function logoutTenant() {
      try { localStorage.removeItem(TENANT_STORAGE_KEY); } catch(e){}
      window.location.href = "tenant.html";
    }

    function formatVND(amount){
      if(amount===null||amount===undefined||amount==='') return '--';
      const num = Number(String(amount).replace(/[^\d.-]/g,''));
      if(isNaN(num)) return String(amount);
      return num.toLocaleString('vi-VN') + ' ƒë';
    }

    function setActiveTab(group, tabName){
      document.querySelectorAll('.tab-btn.tab-' + group).forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('.tab-pane-' + group).forEach(pane=>{
        pane.classList.toggle('hidden', pane.id !== 'tab-' + tabName);
      });
    }

    // ƒê·ªïi m·ªçi ki·ªÉu ng√†y v·ªÅ Date r·ªìi format DD/MM/YYYY
    function toDateObject(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      const d = new Date(value);
      return isNaN(d) ? null : d;
    }

    function formatDateDDMMYYYY(value) {
      const d = toDateObject(value);
      if (!d) return value || '';
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // Render tr·∫°ng th√°i d·∫°ng text ho·∫∑c n√∫t "xem chi ti·∫øt" (d√πng cho c√°c b·∫£ng kh√°c)
    function renderStatusHTML(text, context) {
      const raw = (text == null) ? '' : String(text).trim();
      if (!raw) {
        return '<span class="status-text muted">--</span>';
      }

      const lower = raw.toLowerCase();
      const isIncomplete =
        lower.includes('ch∆∞a') ||
        lower.includes('chua') ||
        lower.includes('c√≤n thi·∫øu') ||
        lower.includes('con thieu');

      if (!isIncomplete) {
        return `<span class="status-text">${raw}</span>`;
      }

      const safeStatus = raw.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      const safeContext = (context || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

      return `
        <button type="button"
          class="status-chip status-chip-warning"
          onclick="openStatusDetail('${safeContext}','${safeStatus}')">
          ${raw}
        </button>`;
    }

    // Popup chi ti·∫øt ‚Äì hi·ªán t·∫°i ch·ªâ alert
    function openStatusDetail(context, statusText) {
      const ctx = context ? `Ng·ªØ c·∫£nh: ${context}\n` : '';
      alert(ctx + 'Tr·∫°ng th√°i: ' + statusText);
    }

    // T√≠nh s·ªë th√°ng c√≤n l·∫°i gi·ªØa 2 ng√†y
    function monthsBetween(from, to) {
      const d1 = new Date(from);
      const d2 = new Date(to);
      if (isNaN(d1) || isNaN(d2)) return null;

      let months =
        (d2.getFullYear() - d1.getFullYear()) * 12 +
        (d2.getMonth() - d1.getMonth());

      if (d2.getDate() < d1.getDate()) months -= 1;
      return months;
    }

    // X√°c ƒë·ªãnh mode tr·∫°ng th√°i h√≥a ƒë∆°n: c·∫ßn thanh to√°n / ƒë√£ thanh to√°n / kh√°c
    function getInvoiceStatusMode(inv){
      const txt = (inv && inv.trangThai ? String(inv.trangThai) : '').toLowerCase();
      if (!txt) return 'unknown';
      if (txt.includes('thi·∫øu') || txt.includes('con thieu')) return 'need-pay';
      if (txt.includes('thu ƒë·ªß') || txt.includes('thu du') || txt.includes('ƒë√£ thanh to√°n') || txt.includes('da thanh toan')) {
        return 'paid';
      }
      return 'unknown';
    }

    // üîß renderInfoCard v·ªõi skeleton + c·∫£nh b√°o Hƒê
    function renderInfoCard(data){
      const $ = (id) => document.getElementById(id);

      const roomBadge   = $('roomBadge');
      const roomLabel   = $('roomLabel');
      const ownerName   = $('ownerName');
      const ownerCCCD   = $('ownerCCCD');
      const ownerPhone  = $('ownerPhone');

      const contractStatusEl  = $('contractStatus');
      const contractTypeEl    = $('contractType');
      const contractPeriodEl  = $('contractPeriod');
      const contractRentEl    = $('contractRent');
      const contractDepositEl = $('contractDeposit');
      const contractDueDayEl  = $('contractDueDay');
      const contractServices  = $('contractServices');
      const extendBtn         = $('extendContractBtn');

      const membersBody       = $('membersTableBody');

      const isEmptyData =
        !data ||
        typeof data !== 'object' ||
        Object.keys(data).length === 0;

      if (isEmptyData) {
        const skeletonTargets = [
          roomBadge, roomLabel,
          ownerName, ownerCCCD, ownerPhone,
          contractStatusEl, contractTypeEl,
          contractPeriodEl, contractRentEl,
          contractDepositEl, contractDueDayEl
        ];

        skeletonTargets.forEach(el => {
          if (!el) return;
          el.textContent = '';
          el.classList.add('skeleton');
        });

        if (contractServices) {
          contractServices.innerHTML =
            '<li class="skeleton">ƒêang t·∫£i th√¥ng tin d·ªãch v·ª•...</li>';
        }

        if (membersBody) {
          membersBody.innerHTML =
            '<tr><td colspan="6" class="muted skeleton">ƒêang t·∫£i danh s√°ch ng∆∞·ªùi ·ªü...</td></tr>';
        }

        if (extendBtn) {
          extendBtn.style.display = 'none';
        }

        return;
      }

      const allTargets = [
        roomBadge, roomLabel,
        ownerName, ownerCCCD, ownerPhone,
        contractStatusEl, contractTypeEl,
        contractPeriodEl, contractRentEl,
        contractDepositEl, contractDueDayEl
      ];
      allTargets.forEach(el => {
        if (el) el.classList.remove('skeleton');
      });
      if (membersBody) membersBody.classList.remove('skeleton');
      if (contractServices) contractServices.classList.remove('skeleton');

      // 2. Th√¥ng tin ph√≤ng
      const roomCode = (data && data.roomCode) ? data.roomCode : '--';
      if (roomBadge) roomBadge.textContent = 'Ph√≤ng: ' + roomCode;
      if (roomLabel) roomLabel.textContent = roomCode;

      // 3. Ch·ªß ph√≤ng
      const chuPhong = (data && data.chuPhong) ? data.chuPhong : {};
      if (ownerName)  ownerName.textContent  = chuPhong.hoTen     || '--';
      if (ownerCCCD)  ownerCCCD.textContent  = chuPhong.cccd      || '--';
      if (ownerPhone) ownerPhone.textContent = chuPhong.dienThoai || '--';

      // 4. H·ª£p ƒë·ªìng
      const contract = (data && data.contract) ? data.contract : null;

      // C·∫£nh b√°o s·∫Øp h·∫øt h·∫°n
      let monthsLeft = null;
      if (contract && contract.ngayKT) {
        monthsLeft = monthsBetween(new Date(), contract.ngayKT);
      }

      let warningClass = "";
      if (monthsLeft != null) {
        if (monthsLeft <= 1) warningClass = "contract-alert-red";
        else if (monthsLeft <= 2) warningClass = "contract-alert-yellow";
      }

      if (contractStatusEl) {
        contractStatusEl.classList.remove("contract-alert-red","contract-alert-yellow");
        if (warningClass) contractStatusEl.classList.add(warningClass);
      }

      function getStatusClass(statusText) {
        if (!statusText) return '';
        const s = statusText.toString().toLowerCase();

        if (s.includes('hi·ªáu l·ª±c') || s.includes('ƒëang thu√™')) {
          return 'badge-success';
        }
        if (s.includes('s·∫Øp h·∫øt') || s.includes('ch·ªù gia h·∫°n')) {
          return 'badge-warning';
        }
        if (s.includes('h·∫øt h·∫°n') || s.includes('thanh l√Ω') || s.includes('ng∆∞ng')) {
          return 'badge-danger';
        }
        return 'badge-neutral';
      }

      if (contractStatusEl) {
        const text = contract ? (contract.trangThai || '--') : '--';
        contractStatusEl.textContent = text;

        contractStatusEl.classList.remove(
          'badge-success','badge-warning','badge-danger','badge-neutral'
        );
        const statusClass = getStatusClass(text);
        if (statusClass) contractStatusEl.classList.add(statusClass);
      }

      if (contractTypeEl) {
        contractTypeEl.textContent = contract ? (contract.loaiHD || '--') : '--';
      }

      // Th·ªùi gian Hƒê + s·ªë ng√†y c√≤n l·∫°i
      if (contractPeriodEl) {
        let baseText = '--';
        let daysLeftText = '';

        if (contract && (contract.ngayBD || contract.ngayKT)) {
          const startRaw = contract.ngayBD ? contract.ngayBD : '';
          const endRaw   = contract.ngayKT ? contract.ngayKT : '';

          const start = startRaw ? formatDateDDMMYYYY(startRaw) : '';
          const end   = endRaw   ? formatDateDDMMYYYY(endRaw)   : '';

          baseText = (start && end) ? (start + ' ‚Äì ' + end) : (start || end || '--');

          const endDateObj = toDateObject(endRaw);
          if (endDateObj) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const diffMs   = endDateObj.getTime() - today.getTime();
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays >= 0) {
              let cls = '';
              if (diffDays < 30)      cls = 'days-left-red';
              else if (diffDays < 60) cls = 'days-left-yellow';

              if (cls) {
                daysLeftText = ` <span class="${cls}">(c√≤n ${diffDays} ng√†y)</span>`;
              }
            }
          }
        }

        contractPeriodEl.innerHTML = baseText + daysLeftText;
      }

      if (contractRentEl) {
        contractRentEl.textContent = (contract && contract.tienThue != null)
          ? formatVND(contract.tienThue)
          : '--';
      }

      if (contractDepositEl) {
        contractDepositEl.textContent = (contract && contract.tienCoc != null)
          ? formatVND(contract.tienCoc)
          : '--';
      }

      if (contractDueDayEl) {
        contractDueDayEl.textContent = contract ? (contract.ngayThuTien || '--') : '--';
      }

      // 5. D·ªãch v·ª• trong Hƒê
      if (contractServices) {
        contractServices.innerHTML = '';

        if (contract) {
          ['1','2','3'].forEach(n => {
            const ma = contract['maDV' + n];
            const dg = contract['donGiaDV' + n];
            if (ma) {
              const li = document.createElement('li');
              li.textContent = ma + (dg != null ? (' ‚Äì ' + formatVND(dg)) : '');
              contractServices.appendChild(li);
            }
          });

          if (!contractServices.childElementCount) {
            const li = document.createElement('li');
            li.textContent = 'Ch∆∞a c·∫•u h√¨nh d·ªãch v·ª•.';
            contractServices.appendChild(li);
          }
        } else {
          const li = document.createElement('li');
          li.textContent = 'Kh√¥ng c√≥ h·ª£p ƒë·ªìng ƒë·ªÉ hi·ªÉn th·ªã d·ªãch v·ª•.';
          contractServices.appendChild(li);
        }
      }

      // 6. N√∫t gia h·∫°n Hƒê
      if (extendBtn) {
        if (contract && contract.coTheGiaHan) {
          extendBtn.style.display = 'inline-flex';
          extendBtn.textContent = "Gia h·∫°n h·ª£p ƒë·ªìng";

          extendBtn.classList.remove(
            'btn-disabled','btn-warning','btn-danger','btn-accent'
          );

          if (monthsLeft != null) {
            if (monthsLeft <= 1) {
              extendBtn.classList.add("btn-danger");
            } else if (monthsLeft <= 2) {
              extendBtn.classList.add("btn-warning");
            } else {
              extendBtn.classList.add("btn-accent");
            }
          }

          const statusText = contract.trangThai ? contract.trangThai.toString().toLowerCase() : '';
          if (statusText.includes('h·∫øt h·∫°n')) {
            extendBtn.classList.add('btn-danger');
          } else if (statusText.includes('s·∫Øp h·∫øt')) {
            extendBtn.classList.add('btn-warning');
          }
        } else {
          extendBtn.style.display = 'none';
        }
      }

      // 7. Danh s√°ch ng∆∞·ªùi ·ªü
      if (membersBody) {
        membersBody.innerHTML = '';
        const members = Array.isArray(data.members) ? data.members : [];

        if (!members.length) {
          membersBody.innerHTML =
            '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ ng∆∞·ªùi ·ªü.</td></tr>';
        } else {
          members.forEach(m => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${m.hoTen || ''}</td>
              <td>${m.dienThoai || ''}</td>
              <td>${m.cccd || ''}</td>
              <td>${m.bienSo || ''}</td>
              <td>${m.ngayTamTru ? formatDateDDMMYYYY(m.ngayTamTru) : ''}</td>
              <td>${renderStatusHTML(m.trangThaiTamTru, 'tamtru')}</td>
            `;
            membersBody.appendChild(tr);
          });
        }
      }
    }

    // Hi·ªÉn th·ªã popup thanh to√°n (placeholder)
    function openPaymentPopupByInvoice(inv){
      if (!inv) return;
      const code = inv.maHD || inv.namThang || '';
      alert(
        'B·∫°n h√£y ch·ª•p m√†n h√¨nh/ƒë√≠nh k√®m phi·∫øu chuy·ªÉn kho·∫£n v√† g·ª≠i cho ch·ªß nh√†.\n' +
        (code ? ('M√£/k·ª≥ h√≥a ƒë∆°n: ' + code) : '')
      );
    }

    function openPaymentPopup(index){
      const inv = CURRENT_INVOICES[index];
      openPaymentPopupByInvoice(inv);
    }

    // Ch·ªçn 1 h√≥a ƒë∆°n trong b·∫£ng l·ªãch s·ª≠
    function selectInvoice(index){
      const historyBody = document.getElementById('paymentHistoryBody');
      if (!historyBody) return;

      historyBody.querySelectorAll('tr').forEach(row=>{
        row.classList.remove('row-active');
      });

      const tr = historyBody.querySelector(`tr[data-index="${index}"]`);
      if (tr) tr.classList.add('row-active');

      const inv = CURRENT_INVOICES[index];
      showInvoiceDetail(inv);
      setActiveTab('pay','detail');
    }
    /*
    function showInvoiceDetail(inv){
      CURRENT_SELECTED_INVOICE = inv || null;

      if (!inv || !inv.chiTiet) {
        document.getElementById('invNgayTinh').textContent   = '--';
        document.getElementById('invTienPhong').textContent  = '--';
        document.getElementById('invTongDV').textContent     = '--';
        document.getElementById('invPhatSinh').textContent   = '--';
        document.getElementById('invGiamTru').textContent    = '--';
        document.getElementById('invThieuTruoc').textContent = '--';
        document.getElementById('invPhaiThu').textContent    = '--';
        document.getElementById('invBankInfo').textContent   = '--';

        const tbody = document.getElementById('invoiceServiceBody');
        if (tbody){
          tbody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ chi ti·∫øt d·ªãch v·ª•.</td></tr>';
        }
        const totalCell = document.getElementById('invoiceServiceTotal');
        if (totalCell) totalCell.textContent = '0 ƒë';

        const qrContainer = document.getElementById('qrContainer');
        if (qrContainer){
          qrContainer.innerHTML = 'Ch∆∞a c√≥ QR Code.';
        }

        const detailBtn = document.getElementById('detailStatusBtn');
        if (detailBtn){
          detailBtn.style.display = 'none';
          detailBtn.onclick = null;
        }
        return;
      }

      const c = inv.chiTiet;

      // Ng√†y t√≠nh Hƒê: xx ng√†y (s·ªë nguy√™n)
      document.getElementById('invNgayTinh').textContent =
        Number.isFinite(Number(c.ngayTinhHD))
          ? `${parseInt(c.ngayTinhHD)} ng√†y`
          : '--';

      document.getElementById('invTienPhong').textContent  = formatVND(c.tienPhongTT);
      document.getElementById('invTongDV').textContent     = formatVND(c.tongDichVu);
      document.getElementById('invPhatSinh').textContent   = formatVND(c.phatSinhKhac);
      document.getElementById('invGiamTru').textContent    = formatVND(c.giamTruKhac);
      document.getElementById('invThieuTruoc').textContent = formatVND(c.thieuKyTruoc);
      document.getElementById('invPhaiThu').textContent    = formatVND(c.phaiThu);

      // Th√¥ng tin chuy·ªÉn kho·∫£n: m·ªói m·ª•c 1 d√≤ng
      const bankInfo = c.bankInfo || {};
      const bankLines = [];
      if (bankInfo.soTaiKhoan)  bankLines.push('S·ªë t√†i kho·∫£n: ' + bankInfo.soTaiKhoan);
      if (bankInfo.chuTaiKhoan) bankLines.push('Ch·ªß t√†i kho·∫£n: ' + bankInfo.chuTaiKhoan);
      if (bankInfo.nganHang)    bankLines.push('Ng√¢n h√†ng: ' + bankInfo.nganHang);
      if (bankInfo.chiNhanh)    bankLines.push('Chi nh√°nh: ' + bankInfo.chiNhanh);

      const bankEl = document.getElementById('invBankInfo');
      if (bankEl) bankEl.innerHTML = bankLines.length ? bankLines.join('<br>') : '--';

      // QR
      const qrContainer = document.getElementById('qrContainer');
      if (qrContainer) {
        qrContainer.innerHTML = '';
        if (c.qrCode){
          const img = document.createElement('img');
          img.src = c.qrCode;
          img.alt = 'QR thanh to√°n';
          img.style.maxWidth = '160px';
          img.style.marginTop = '4px';
          qrContainer.appendChild(img);
        } else {
          qrContainer.textContent = 'Ch∆∞a c√≥ QR Code.';
        }
      }

    // // B·∫£ng d·ªãch v·ª• chi ti·∫øt (T√™n d·ªãch v·ª• = M√£ DV t·ª´ sheet H√≥a ƒë∆°n)
      const tbody = document.getElementById('invoiceServiceBody');
      const totalCell = document.getElementById('invoiceServiceTotal');
      if (tbody && totalCell) {
        tbody.innerHTML = '';
      
        // ∆∞u ti√™n inv.services (Apps Script build), fallback c.services
        const servicesRaw = Array.isArray(inv?.services)
          ? inv.services
          : (Array.isArray(c?.services) ? c.services : []);
      
        // Chu·∫©n ho√° + l·ªçc b·ªè d√≤ng r·ªóng/0
        const rows = servicesRaw
          .map(s => {
            const maDV = (s.maDV ?? s.ma ?? s.maDichVu ?? s.tenDV ?? '').toString().trim(); // ‚úÖ t√™n DV l·∫•y t·ª´ "M√£ DV..."
            const soDau = Number(s.soDau ?? s.slDau ?? s.chiSoDau ?? 0);
            const soCuoi = Number(s.soCuoi ?? s.slCuoi ?? s.chiSoCuoi ?? 0);
            const soLuong = Number(s.soLuong ?? s.slDV ?? 0);
            const donGia = Number(s.donGia ?? s.donGiaDV ?? 0);
            const thanhTien = Number(s.thanhTien ?? s.thanhTienDV ?? 0);
      
            return { maDV, soDau, soCuoi, soLuong, donGia, thanhTien };
          })
          .filter(x => {
            // b·ªè d√≤ng r·ªóng
            if (!x.maDV) return false;
      
            // b·ªè d√≤ng to√†n 0
            const allZero =
              x.soDau === 0 &&
              x.soCuoi === 0 &&
              x.soLuong === 0 &&
              x.donGia === 0 &&
              x.thanhTien === 0;
            if (allZero) return false;
      
            // b·ªè d√≤ng c√≥ th√†nh ti·ªÅn = 0 (theo y√™u c·∫ßu "b·∫±ng 0" c≈©ng b·ªè)
            if (x.thanhTien === 0) return false;
      
            return true;
          });
      
        if (!rows.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="muted">Kh√¥ng c√≥ d·ªãch v·ª• ph√°t sinh.</td></tr>';
          totalCell.textContent = formatVND(0);
        } else {
          let total = 0;
      
          rows.forEach(x => {
            total += x.thanhTien;
      
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${x.maDV}</td>
              <td>${x.soDau ? x.soDau : ''}</td>
              <td>${x.soCuoi ? x.soCuoi : ''}</td>
              <td>${x.soLuong ? x.soLuong : ''}</td>
              <td>${formatVND(x.donGia)}</td>
              <td>${formatVND(x.thanhTien)}</td>
            `;
            tbody.appendChild(tr);
          });
      
          totalCell.textContent = formatVND(total);
        }
      }

    */
    // =========================
    // THANH TO√ÅN: l·ªãch s·ª≠ + chi ti·∫øt (ch·ªçn d√≤ng)
    // =========================
    let __selectedInvoiceIndex = 0;
    let __portalDataCache = null;

    function isInvoicePaid_(inv){
      const st = String(inv && inv.trangThai || '').toLowerCase();
      // coi "ƒë·ªß/ƒë√£ thu/ƒë√£ thanh to√°n/ho√†n t·∫•t" l√† ƒë√£ thanh to√°n
      return (
        st.includes('ƒë·ªß') ||
        st.includes('da du') ||
        st.includes('ƒë√£ thu') ||
        st.includes('da thu') ||
        st.includes('ƒë√£ thanh to√°n') ||
        st.includes('da thanh toan') ||
        st.includes('ho√†n t·∫•t') ||
        st.includes('hoan tat')
      );
    }

    function renderInvoiceStatusCell_(inv, index){
      if (!inv) return '<span class="pill pill-neutral">--</span>';

      const paid = isInvoicePaid_(inv);
      if (paid){
        return '<span class="pill pill-success">ƒê√£ thanh to√°n</span>';
      }
      // c√≤n thi·∫øu ‚Üí n√∫t Thanh to√°n ƒë·ªè
      return `<button type="button" class="btn btn-danger btn-sm" onclick="openPaymentModal(${index})">Thanh to√°n</button>`;
    }

    function renderPaymentCard(data){
      __portalDataCache = data || null;

      const historyBody = document.getElementById('paymentHistoryBody');
      if (!historyBody) return;
      historyBody.innerHTML = '';

      const invoices = (data && Array.isArray(data.invoices)) ? data.invoices : [];

      // Ch·ªâ hi·ªÉn th·ªã n·∫øu h·ª£p ƒë·ªìng c√≤n hi·ªáu l·ª±c
      const isContractActive =
        !!(data && data.contract && String(data.contract.trangThai || '').toLowerCase().includes('hi·ªáu l·ª±c'));

      if (!isContractActive) {
        historyBody.innerHTML = `
          <tr>
            <td colspan="4" class="muted">
              H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.
            </td>
          </tr>`;
        // reset ph·∫ßn chi ti·∫øt
        renderInvoiceDetail_(null);
        return;
      }

      if (!invoices.length){
        historyBody.innerHTML = `
          <tr>
            <td colspan="4" class="muted">
              Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o cho ph√≤ng n√†y.
            </td>
          </tr>`;
        renderInvoiceDetail_(null);
        return;
      }

      invoices.forEach((inv, i)=>{
        const tr = document.createElement('tr');
        tr.classList.toggle('row-active', i === __selectedInvoiceIndex);
        tr.innerHTML = `
          <td>${inv.namThang || ''}</td>
          <td>${formatVND(inv.tongPhaiThu)}</td>
          <td>${renderInvoiceStatusCell_(inv, i)}</td>
          <td>
            <button type="button" class="btn btn-outline btn-sm" onclick="selectInvoice(${i})">
              Chi ti·∫øt
            </button>
          </td>
        `;
        historyBody.appendChild(tr);
      });

      // m·∫∑c ƒë·ªãnh ch·ªçn d√≤ng ƒë·∫ßu ti√™n (m·ªõi nh·∫•t)
      if (__selectedInvoiceIndex >= invoices.length) __selectedInvoiceIndex = 0;
      renderInvoiceDetail_(invoices[__selectedInvoiceIndex]);
    }

    function selectInvoice(index){
      __selectedInvoiceIndex = Number(index) || 0;

      const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
        ? __portalDataCache.invoices
        : [];

      // highlight l·∫°i d√≤ng
      const rows = document.querySelectorAll('#paymentHistoryBody tr');
      rows.forEach((r, i)=> r.classList.toggle('row-active', i === __selectedInvoiceIndex));

      const inv = invoices[__selectedInvoiceIndex] || null;
      renderInvoiceDetail_(inv);
      setActiveTab('pay', 'detail');
    }

    function renderInvoiceDetail_(inv){
      // pill + n√∫t thanh to√°n
      const kyEl = document.getElementById('invKy');
      const pillEl = document.getElementById('invStatusPill');
      const payBtn = document.getElementById('invPayBtn');

      const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
        ? __portalDataCache.invoices
        : [];

      if (!inv){
        if (kyEl) kyEl.textContent = 'K·ª≥: --';
        if (pillEl){ pillEl.className = 'pill pill-neutral'; pillEl.textContent = '--'; }
        if (payBtn) payBtn.style.display = 'none';

        // reset summary
        ['invNgayTinh','invTienPhong','invPhatSinh','invGiamTru','invThieuTruoc','invPhaiThu','invoiceServiceTotal'].forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.textContent = '--';
        });
        const dvBody = document.getElementById('invoiceServiceBody');
        if (dvBody) dvBody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu d·ªãch v·ª•.</td></tr>';

        // bank + qr
        updateBankAndQr_(null);
        return;
      }

      if (kyEl) kyEl.textContent = 'K·ª≥: ' + (inv.namThang || '--');

      const paid = isInvoicePaid_(inv);
      if (pillEl){
        pillEl.className = paid ? 'pill pill-success' : 'pill pill-danger';
        pillEl.textContent = paid ? 'ƒê√£ thanh to√°n' : 'C√≤n thi·∫øu';
      }
      if (payBtn){
        payBtn.style.display = paid ? 'none' : 'inline-flex';
      }

      // summary
      const c = inv.chiTiet || {};
      document.getElementById('invNgayTinh').textContent = (c.ngayTinhHD != null && c.ngayTinhHD !== '') ? (parseInt(c.ngayTinhHD,10) + ' ng√†y') : '--';
      document.getElementById('invTienPhong').textContent  = formatVND(c.tienPhongTT);
      document.getElementById('invPhatSinh').textContent   = formatVND(c.phatSinhKhac);
      document.getElementById('invGiamTru').textContent    = formatVND(c.giamTruKhac);
      document.getElementById('invThieuTruoc').textContent = formatVND(c.thieuKyTruoc);
      document.getElementById('invPhaiThu').textContent    = formatVND(c.phaiThu);

      // =========================
      // B·∫¢NG D·ªäCH V·ª§ (T√™n DV = M√£ DV | B·ªè d√≤ng r·ªóng & = 0)
      // =========================
      const tbody = document.getElementById('invoiceServiceBody');
      const totalCell = document.getElementById('invServiceTotal');
      
      if (tbody && totalCell) {
        tbody.innerHTML = '';
      
        const servicesRaw = Array.isArray(inv?.services) ? inv.services : [];
        const rows = servicesRaw
          .map(s => {
            const maDV = (s.maDV || '').toString().trim();
            const soDau = Number(s.soDau ?? 0);
            const soCuoi = Number(s.soCuoi ?? 0);
            const soLuong = Number(s.soLuong ?? 0);
            const donGia = Number(s.donGia ?? 0);
            const thanhTien = Number(s.thanhTien ?? 0);
      
            return { maDV, soDau, soCuoi, soLuong, donGia, thanhTien };
          })
          .filter(x =>
            x.maDV && x.thanhTien > 0
          );
      
        if (!rows.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="muted">Kh√¥ng c√≥ d·ªãch v·ª• ph√°t sinh.</td></tr>';
          totalCell.textContent = formatVND(0);
        } else {
          let total = 0;
          rows.forEach(x => {
            total += x.thanhTien;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${x.maDV}</td>
              <td>${x.soDau || ''}</td>
              <td>${x.soCuoi || ''}</td>
              <td>${x.soLuong || ''}</td>
              <td>${formatVND(x.donGia)}</td>
              <td>${formatVND(x.thanhTien)}</td>
            `;
            tbody.appendChild(tr);
          });
          totalCell.textContent = formatVND(total);
        }
      }

      // bank + qr d·ª±a theo d√≤ng ƒë∆∞·ª£c ch·ªçn
      updateBankAndQr_(inv);
    }

    function updateBankAndQr_(inv){
      const bankInfoEl = document.getElementById('invBankInfo');
      const qrContainer = document.getElementById('qrContainer');

      const c = (inv && inv.chiTiet) ? inv.chiTiet : {};
      const bankInfo = c.bankInfo || {};

      const bankText = [
        bankInfo.soTaiKhoan ? ('S·ªë t√†i kho·∫£n: ' + bankInfo.soTaiKhoan) : '',
        bankInfo.chuTaiKhoan ? ('Ch·ªß t√†i kho·∫£n: ' + bankInfo.chuTaiKhoan) : '',
        bankInfo.nganHang ? ('Ng√¢n h√†ng: ' + bankInfo.nganHang) : '',
        bankInfo.chiNhanh ? ('Chi nh√°nh: ' + bankInfo.chiNhanh) : ''
      ].filter(Boolean).join(' ‚Ä¢ ');

      if (bankInfoEl) bankInfoEl.textContent = bankText || '--';

      if (!qrContainer) return;
      qrContainer.innerHTML = '';
      const qr =
        (c && (c.qrCode || c.qr || c.qr_code || c["QR Code"])) ||
        (inv && (inv.qrCode || inv.qr || inv.qr_code || inv["QR Code"])) ||
        '';

      if (qr){
        const img = document.createElement('img');
        img.src = qr;
        img.alt = 'QR thanh to√°n';
        img.style.maxWidth = '160px';
        img.style.marginTop = '4px';
        qrContainer.appendChild(img);
      } else {
        qrContainer.textContent = 'Ch∆∞a c√≥ QR Code.';
      }
    }


    function renderMaintenance(data){
      const tbody = document.getElementById('maintenanceBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const list = (data && Array.isArray(data.maintenance)) ? data.maintenance : [];
      if (!list.length){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>';
        return;
      }
      list.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.tenTaiSan || ''}</td>
          <td>${m.loaiCongViec || ''}</td>
          <td>${m.ngayDuKien ? formatDateDDMMYYYY(m.ngayDuKien) : ''}</td>
          <td>${m.ngayThucHien ? formatDateDDMMYYYY(m.ngayThucHien) : ''}</td>
          <td>${m.trangThai || ''}</td>
          <td>${m.ghiChu || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderMessages(data){
      const tbody = document.getElementById('messageBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const msgs = (data && Array.isArray(data.messages)) ? data.messages : [];
      if (!msgs.length){
        tbody.innerHTML = '<tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>';
        return;
      }
      msgs.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.type || m.loai || ''}</td>
          <td>${m.createdAt || m.ngay || ''}</td>
          <td>${m.content || m.noiDung || ''}</td>
          <td>${renderStatusHTML(m.status || m.trangThai || '', 'message')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // G·ª≠i y√™u c·∫ßu b√°o h·ªèng / t·∫°m tr√∫ (placeholder)
    function openMaintenanceForm(){
      alert('Form b√°o h·ªèng: b·∫°n c√≥ th·ªÉ d√πng tenantMaintenance API nh∆∞ ƒë√£ c·∫•u h√¨nh ·ªü Apps Script.');
    }
    function openTempStayForm(){
      alert('Form ƒëƒÉng k√Ω t·∫°m tr√∫: d√πng tenantTempStay API.');
    }


    // =========================
    // POPUP THANH TO√ÅN (g·ª≠i phi·∫øu / b√°o ch·ªß nh√†)
    // =========================
    function openPaymentModal(index){
      // n·∫øu g·ªçi t·ª´ tab chi ti·∫øt: index c√≥ th·ªÉ undefined ‚Üí d√πng __selectedInvoiceIndex
      if (index !== undefined && index !== null) {
        __selectedInvoiceIndex = Number(index) || 0;
      }
      const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
        ? __portalDataCache.invoices
        : [];
      const inv = invoices[__selectedInvoiceIndex] || null;

      const modal = document.getElementById('paymentModal');
      if (!modal) return;

      const meta = document.getElementById('paymentModalMeta');
      if (meta) meta.textContent = 'H√≥a ƒë∆°n: ' + (inv ? (inv.namThang || '--') : '--');

      const fileInput = document.getElementById('paymentProofFile');
      const noteInput = document.getElementById('paymentNote');
      const preview = document.getElementById('paymentPreview');

      if (fileInput) fileInput.value = '';
      if (noteInput) noteInput.value = '';
      if (preview) preview.textContent = 'Ch∆∞a ch·ªçn ·∫£nh.';

      modal.classList.remove('hidden');
    }

    function closePaymentModal(){
      const modal = document.getElementById('paymentModal');
      if (modal) modal.classList.add('hidden');
    }

    // preview ·∫£nh
    document.addEventListener('change', (e)=>{
      if (e.target && e.target.id === 'paymentProofFile'){
        const file = e.target.files && e.target.files[0];
        const preview = document.getElementById('paymentPreview');
        if (!preview) return;

        if (!file){
          preview.textContent = 'Ch∆∞a ch·ªçn ·∫£nh.';
          preview.classList.add('muted');
          return;
        }

        preview.classList.remove('muted');
        preview.innerHTML = '';
        const img = document.createElement('img');
        img.alt = 'Phi·∫øu chuy·ªÉn kho·∫£n';
        img.className = 'payment-proof-img';
        img.src = URL.createObjectURL(file);
        preview.appendChild(img);
      }
    });

    async function submitPaymentProof(){
      const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
        ? __portalDataCache.invoices
        : [];
      const inv = invoices[__selectedInvoiceIndex] || null;

      const fileInput = document.getElementById('paymentProofFile');
      const noteInput = document.getElementById('paymentNote');

      const file = fileInput && fileInput.files ? fileInput.files[0] : null;
      const note = noteInput ? (noteInput.value || '') : '';

      // Chu·∫©n payload: base64 ·∫£nh (n·∫øu c√≥)
      let base64 = '';
      if (file){
        base64 = await new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result || ''));
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      try{
        const body = new URLSearchParams({
          action: 'tenantPaymentProof',
          roomCode: (__portalDataCache && __portalDataCache.roomCode) ? __portalDataCache.roomCode : '',
          invoiceId: inv && (inv.id || inv.invoiceId || inv.maHoaDon) ? (inv.id || inv.invoiceId || inv.maHoaDon) : '',
          namThang: inv && inv.namThang ? inv.namThang : '',
          note: note,
          proofBase64: base64
        });

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body
        });

        let out = null;
        try { out = await res.json(); } catch(e){}

        if (out && out.success){
          alert('ƒê√£ g·ª≠i x√°c nh·∫≠n thanh to√°n cho ch·ªß nh√†.');
          closePaymentModal();
          // N·∫øu backend c√≥ c·∫≠p nh·∫≠t tr·∫°ng th√°i, reload l·∫°i data ƒë·ªÉ refresh
          const tenant = JSON.parse(localStorage.getItem(TENANT_STORAGE_KEY) || '{}');
          if (tenant && tenant.maPhong){
            fetchTenantPortalData(tenant.maPhong, tenant.identity || '');
          }
        } else {
          // fallback n·∫øu backend ch∆∞a c√≥ endpoint
          alert((out && out.message) || 'ƒê√£ ghi nh·∫≠n. N·∫øu ch∆∞a th·∫•y c·∫≠p nh·∫≠t, ch·ªß nh√† s·∫Ω ki·ªÉm tra v√† x√°c nh·∫≠n sau.');
          closePaymentModal();
        }
      } catch(err){
        console.error('submitPaymentProof error:', err);
        alert('Kh√¥ng g·ª≠i ƒë∆∞·ª£c x√°c nh·∫≠n (l·ªói k·∫øt n·ªëi). Vui l√≤ng th·ª≠ l·∫°i.');
      }
    }


    function downloadInvoicePdf(){
      window.print();
    }

    async function fetchTenantPortalData(roomCode, identity){
      const note = document.getElementById('portalStatusNote');
      if (note) note.textContent = 'ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Google Sheet (Apps Script)...';

      // G·ªçi skeleton tr∆∞·ªõc khi fetch
      renderInfoCard(null);

      try{
        const body = new URLSearchParams({
          action:   'tenantPortal',
          roomCode: roomCode,
          identity: identity || ''
        });

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body
        });
        const data = await res.json();

        if (!data || !data.success){
          if (note) note.textContent = (data && data.message) || 'Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu portal.';
          return;
        }

        if (note) note.textContent = 'D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ h·ªá th·ªëng (Google Sheet).';

        renderInfoCard(data);
        renderPaymentCard(data);
        renderMaintenance(data);
        renderMessages(data);

      } catch(err){
        console.error('fetchTenantPortalData error:',err);
        const noteEl = document.getElementById('portalStatusNote');
        if (noteEl) noteEl.textContent = 'L·ªói k·∫øt n·ªëi t·ªõi Apps Script, vui l√≤ng th·ª≠ l·∫°i.';
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Tab handler
      document.querySelectorAll('.tab-btn.tab-info').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          setActiveTab('info', btn.dataset.tab);
        });
      });
      document.querySelectorAll('.tab-btn.tab-pay').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          setActiveTab('pay', btn.dataset.tab);
        });
      });

      // L·∫•y tenant t·ª´ localStorage
      let tenant = null;
      try {
        const saved = localStorage.getItem(TENANT_STORAGE_KEY);
        if (saved) tenant = JSON.parse(saved);
      } catch(e){}

      if (!tenant || !tenant.maPhong){
        window.location.href = 'tenant.html';
        return;
      }
      fetchTenantPortalData(tenant.maPhong, tenant.identity || '');
    });
  </script>
</body>
</html>





