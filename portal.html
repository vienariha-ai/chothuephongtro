<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Portal t√†i kho·∫£n ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="yt-home-common.css" />
</head>
<body class="tenant-body">
  <div class="container">
    <header class="header">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn btn-outline">Trang xem ph√≤ng</a>
        <button type="button" class="btn btn-outline" onclick="logoutTenant()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">Xin ch√†o, c∆∞ d√¢n YT Home üè°</div>
      <div class="page-subtitle">
        ƒê√¢y l√† portal n·ªôi b·ªô d√†nh cho t√†i kho·∫£n ph√≤ng. D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ Google Sheet qua Apps Script.
      </div>
      <div id="portalStatusNote" class="portal-status">
        ƒêang t·∫£i d·ªØ li·ªáu ph√≤ng t·ª´ h·ªá th·ªëng...
      </div>

      <div class="grid">
        <!-- C·ªòT TR√ÅI: TH√îNG TIN -->
        <section class="card">
          <div class="card-title">Th√¥ng tin ph√≤ng</div>
          <div class="badge" id="roomBadge">Ph√≤ng: --</div>

          <div class="tab-row">
            <button class="tab-btn tab-info active" data-tab="owner">Ch·ªß ph√≤ng</button>
            <button class="tab-btn tab-info" data-tab="contract">T√≥m t·∫Øt h·ª£p ƒë·ªìng</button>
            <button class="tab-btn tab-info" data-tab="members">Ng∆∞·ªùi & xe</button>
          </div>

          <!-- TAB CH·ª¶ PH√íNG -->
          <div class="tab-pane tab-pane-info" id="tab-owner">
            <div class="info-row">
              <span class="info-label">Ph√≤ng:</span>
              <span class="info-value" id="roomLabel">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">T√™n ch·ªß ph√≤ng:</span>
              <span class="info-value" id="ownerName">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë CCCD:</span>
              <span class="info-value" id="ownerCCCD">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
              <span class="info-value" id="ownerPhone">--</span>
            </div>
            <div class="small-note">
              Th√¥ng tin ƒë∆∞·ª£c l·∫•y t·ª´ sheet <strong>Kh√°ch thu√™</strong> (Lo·∫°i = "Ch·ªß ph√≤ng", Tr·∫°ng th√°i = "ƒêang ·ªü").
            </div>
          </div>

          <!-- TAB H·ª¢P ƒê·ªíNG -->
          <div class="tab-pane tab-pane-info hidden" id="tab-contract">
            <ul class="list">
              <li>Tr·∫°ng th√°i: <strong id="contractStatus">--</strong></li>
              <li>Lo·∫°i Hƒê: <strong id="contractType">--</strong></li>
              <li>Th·ªùi gian: <strong id="contractPeriod">--</strong></li>
              <li>Ti·ªÅn thu√™: <strong id="contractRent">--</strong></li>
              <li>Ti·ªÅn c·ªçc: <strong id="contractDeposit">--</strong></li>
              <li>Ng√†y thu ti·ªÅn: <strong id="contractDueDay">--</strong></li>
              <li>D·ªãch v·ª• k√®m theo:</li>
            </ul>
            <ul class="list" id="contractServices"></ul>

            <button id="extendContractBtn" class="btn" style="margin-top:8px; display:none;">
              K√Ω ti·∫øp h·ª£p ƒë·ªìng
            </button>

            <div class="small-note">
              Hi·ªÉn th·ªã t·ª´ sheet <strong>H·ª£p ƒë·ªìng</strong>. N√∫t "K√Ω ti·∫øp h·ª£p ƒë·ªìng" ch·ªâ hi·ªán khi c√≤n &lt;= 1 th√°ng tr∆∞·ªõc ng√†y k·∫øt th√∫c.
            </div>
          </div>

          <!-- TAB NG∆Ø·ªúI & XE -->
          <div class="tab-pane tab-pane-info hidden" id="tab-members">
            <table class="table-like">
              <thead>
                <tr>
                  <th>H·ªç t√™n</th>
                  <th>ƒêi·ªán tho·∫°i</th>
                  <th>CCCD</th>
                  <th>Bi·ªÉn s·ªë</th>
                  <th>T·∫°m tr√∫</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="membersTableBody">
                <tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
              </tbody>
            </table>
            <div class="tenant-footer-actions">
              <span></span>
              <button class="btn" type="button" onclick="openTempStayForm()">ƒêƒÉng k√Ω t·∫°m tr√∫</button>
            </div>
          </div>
        </section>

        <!-- C·ªòT PH·∫¢I: THANH TO√ÅN -->
        <section class="card">
          <div class="card-title">Thanh to√°n</div>
          <div class="tab-row">
            <button class="tab-btn tab-pay active" data-tab="history">L·ªãch s·ª≠ thanh to√°n</button>
            <button class="tab-btn tab-pay" data-tab="detail">Chi ti·∫øt h√≥a ƒë∆°n</button>
          </div>

          <!-- TAB L·ªäCH S·ª¨ THANH TO√ÅN -->
          <div class="tab-pane tab-pane-pay" id="tab-history">
            <table class="table-like">
              <thead>
                <tr>
                  <th>K·ª≥ (NƒÉm th√°ng)</th>
                  <th>T·ªïng ƒêN + DV</th>
                  <th>T·ªïng ph·∫£i thu</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody">
                <tr>
                  <td colspan="4" class="muted">
                    H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="tenant-footer-actions">
              <span class="muted">Ch·ªâ hi·ªÉn th·ªã n·∫øu H·ª£p ƒë·ªìng c√≤n hi·ªáu l·ª±c.</span>
              <button class="btn" type="button" onclick="downloadInvoicePdf()">T·∫£i / In h√≥a ƒë∆°n</button>
            </div>
          </div>

          <!-- TAB CHI TI·∫æT H√ìA ƒê∆†N (k·ª≥ m·ªõi nh·∫•t) -->
          <div class="tab-pane tab-pane-pay hidden" id="tab-detail">
            <div id="invoiceSummary">
              <p><strong>Ng√†y t√≠nh Hƒê:</strong> <span id="invNgayTinh">--</span></p>
              <p><strong>Ti·ªÅn ph√≤ng thanh to√°n:</strong> <span id="invTienPhong">--</span></p>
              <p><strong>T·ªïng d·ªãch v·ª• (ƒêN + DV):</strong> <span id="invTongDV">--</span></p>
              <p><strong>Ph√°t sinh kh√°c:</strong> <span id="invPhatSinh">--</span></p>
              <p><strong>Gi·∫£m tr·ª´ kh√°c:</strong> <span id="invGiamTru">--</span></p>
              <p><strong>Thi·∫øu k·ª≥ tr∆∞·ªõc:</strong> <span id="invThieuTruoc">--</span></p>
              <p><strong>Ph·∫£i thu:</strong> <span id="invPhaiThu">--</span></p>
            </div>

            <div class="section-title">Th√¥ng tin chuy·ªÉn kho·∫£n</div>
            <p class="small-note" id="invBankInfo">--</p>

            <div class="section-title">QR thanh to√°n</div>
            <div id="qrContainer" class="gallery-placeholder">Ch∆∞a c√≥ QR Code.</div>
          </div>
        </section>
      </div>

      <!-- H√ÄNG D∆Ø·ªöI: B·∫¢O TR√å + TIN NH·∫ÆN -->
      <div class="grid" style="margin-top:12px;">
        <!-- B·∫£o tr√¨ -->
        <section class="card">
          <div class="card-title">L·ªãch b·∫£o tr√¨</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>T√†i s·∫£n</th>
                <th>Lo·∫°i c√¥ng vi·ªác</th>
                <th>Ng√†y d·ª± ki·∫øn</th>
                <th>Ng√†y th·ª±c hi·ªán</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody id="maintenanceBody">
              <tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>
            </tbody>
          </table>
          <div class="tenant-footer-actions">
            <span class="muted">D·ªØ li·ªáu t·ª´ sheet "L·ªãch b·∫£o tr√¨".</span>
            <button type="button" class="btn" onclick="openMaintenanceForm()">B√°o h·ªèng</button>
          </div>
        </section>

        <!-- Tin nh·∫Øn / y√™u c·∫ßu -->
        <section class="card">
          <div class="card-title">Tin nh·∫Øn & y√™u c·∫ßu</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>Lo·∫°i</th>
                <th>Ng√†y</th>
                <th>N·ªôi dung</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="messageBody">
              <tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>
            </tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <script>
    const TENANT_STORAGE_KEY = "ytHomeTenant";
    const API_URL = "https://script.google.com/macros/s/AKfycbwkh47q9l1zqBWI-Ml7wzJrNVrBM_70xgWLzV9PEwGaWKJc0qbLYn_-tce-xS9Ntxxf2g/exec";

    function logoutTenant() {
      try { localStorage.removeItem(TENANT_STORAGE_KEY); } catch(e){}
      window.location.href = "tenant.html";
    }

    function formatVND(amount){
      if(amount===null||amount===undefined||amount==='') return '--';
      const num = Number(String(amount).replace(/[^\d.-]/g,''));
      if(isNaN(num)) return String(amount);
      return num.toLocaleString('vi-VN') + ' ƒë';
    }

    function setActiveTab(group, tabName){
      document.querySelectorAll('.tab-btn.tab-' + group).forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('.tab-pane-' + group).forEach(pane=>{
        pane.classList.toggle('hidden', pane.id !== 'tab-' + tabName);
      });
    }

    function renderInfoCard(data){
      const roomBadge  = document.getElementById('roomBadge');
      const roomLabel  = document.getElementById('roomLabel');
      const ownerName  = document.getElementById('ownerName');
      const ownerCCCD  = document.getElementById('ownerCCCD');
      const ownerPhone = document.getElementById('ownerPhone');

      if(roomBadge) roomBadge.textContent = 'Ph√≤ng: ' + (data.roomCode || '--');
      if(roomLabel) roomLabel.textContent = data.roomCode || '--';

      if (data.chuPhong){
        ownerName.textContent  = data.chuPhong.hoTen || '--';
        ownerCCCD.textContent  = data.chuPhong.cccd || '--';
        ownerPhone.textContent = data.chuPhong.dienThoai || '--';
      }

      // H·ª£p ƒë·ªìng
      const contract = data.contract || null;
      document.getElementById('contractStatus').textContent = contract ? (contract.trangThai || '--') : '--';
      document.getElementById('contractType').textContent   = contract ? (contract.loaiHD || '--') : '--';

      const periodEl = document.getElementById('contractPeriod');
      if (contract && (contract.ngayBD || contract.ngayKT)){
        const start = contract.ngayBD ? contract.ngayBD : '';
        const end   = contract.ngayKT ? contract.ngayKT : '';
        periodEl.textContent = (start && end) ? (start + ' ‚Äì ' + end) : (start || end || '--');
      } else {
        periodEl.textContent = '--';
      }

      document.getElementById('contractRent').textContent    = contract ? formatVND(contract.tienThue) : '--';
      document.getElementById('contractDeposit').textContent = contract ? formatVND(contract.tienCoc) : '--';
      document.getElementById('contractDueDay').textContent  = contract ? (contract.ngayThuTien || '--') : '--';

      const svList = document.getElementById('contractServices');
      svList.innerHTML = '';
      if (contract){
        ['1','2','3'].forEach(n=>{
          const ma  = contract['maDV'+n];
          const dg  = contract['donGiaDV'+n];
          if(ma){
            const li = document.createElement('li');
            li.textContent = ma + (dg ? (' ‚Äì ' + formatVND(dg)) : '');
            svList.appendChild(li);
          }
        });
        if(!svList.childElementCount){
          const li = document.createElement('li');
          li.textContent = 'Ch∆∞a c·∫•u h√¨nh d·ªãch v·ª•.';
          svList.appendChild(li);
        }
      }

      const extendBtn = document.getElementById('extendContractBtn');
      if (contract && contract.coTheGiaHan){
        extendBtn.style.display = 'inline-flex';
      } else {
        extendBtn.style.display = 'none';
      }

      // Members
      const tbody = document.getElementById('membersTableBody');
      tbody.innerHTML = '';
      const members = data.members || [];
      if (!members.length){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ ng∆∞·ªùi ·ªü.</td></tr>';
      } else {
        members.forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${m.hoTen || ''}</td>
            <td>${m.dienThoai || ''}</td>
            <td>${m.cccd || ''}</td>
            <td>${m.bienSo || ''}</td>
            <td>${m.ngayTamTru || ''}</td>
            <td>${m.trangThaiTamTru || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

    function renderPaymentCard(data){
      const historyBody = document.getElementById('paymentHistoryBody');
      historyBody.innerHTML = '';

      const invoices = data.invoices || [];

      if (!data.contract || !String(data.contract.trangThai || '').toLowerCase().includes('hi·ªáu l·ª±c')) {
        historyBody.innerHTML = `
          <tr>
            <td colspan="4" class="muted">
              H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.
            </td>
          </tr>`;
        return;
      }

      if (!invoices.length){
        historyBody.innerHTML = `
          <tr>
            <td colspan="4" class="muted">
              Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o cho ph√≤ng n√†y.
            </td>
          </tr>`;
      } else {
        invoices.forEach(inv=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${inv.namThang || ''}</td>
            <td>${formatVND(inv.tongDN_DV)}</td>
            <td>${formatVND(inv.tongPhaiThu)}</td>
            <td>${inv.trangThai || ''}</td>
          `;
          historyBody.appendChild(tr);
        });
      }

      // Chi ti·∫øt h√≥a ƒë∆°n = b·∫£n ghi m·ªõi nh·∫•t
      const latest = invoices[0];
      if (!latest) return;
      const c = latest.chiTiet || {};

      document.getElementById('invNgayTinh').textContent   = c.ngayTinhHD || '--';
      document.getElementById('invTienPhong').textContent  = formatVND(c.tienPhongTT);
      document.getElementById('invTongDV').textContent     = formatVND(c.tongDichVu);
      document.getElementById('invPhatSinh').textContent   = formatVND(c.phatSinhKhac);
      document.getElementById('invGiamTru').textContent    = formatVND(c.giamTruKhac);
      document.getElementById('invThieuTruoc').textContent = formatVND(c.thieuKyTruoc);
      document.getElementById('invPhaiThu').textContent    = formatVND(c.phaiThu);

      const bankInfo = c.bankInfo || {};
      const bankText = [
        bankInfo.soTaiKhoan ? ('STK: ' + bankInfo.soTaiKhoan) : '',
        bankInfo.chuTaiKhoan ? ('Ch·ªß TK: ' + bankInfo.chuTaiKhoan) : '',
        bankInfo.nganHang ? ('Ng√¢n h√†ng: ' + bankInfo.nganHang) : '',
        bankInfo.chiNhanh ? ('Chi nh√°nh: ' + bankInfo.chiNhanh) : ''
      ].filter(Boolean).join(' ‚Ä¢ ');

      document.getElementById('invBankInfo').textContent = bankText || '--';

      const qrContainer = document.getElementById('qrContainer');
      qrContainer.innerHTML = '';
      if (c.qrCode){
        // n·∫øu qrCode l√† URL ·∫£nh
        const img = document.createElement('img');
        img.src = c.qrCode;
        img.alt = 'QR thanh to√°n';
        img.style.maxWidth = '160px';
        img.style.marginTop = '4px';
        qrContainer.appendChild(img);
      } else {
        qrContainer.textContent = 'Ch∆∞a c√≥ QR Code.';
      }
    }

    function renderMaintenance(data){
      const tbody = document.getElementById('maintenanceBody');
      tbody.innerHTML = '';
      const list = data.maintenance || [];
      if (!list.length){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>';
        return;
      }
      list.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.tenTaiSan || ''}</td>
          <td>${m.loaiCongViec || ''}</td>
          <td>${m.ngayDuKien || ''}</td>
          <td>${m.ngayThucHien || ''}</td>
          <td>${m.trangThai || ''}</td>
          <td>${m.ghiChu || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderMessages(data){
      const tbody = document.getElementById('messageBody');
      tbody.innerHTML = '';
      const msgs = data.messages || [];
      if (!msgs.length){
        tbody.innerHTML = '<tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>';
        return;
      }
      msgs.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.type || m.loai || ''}</td>
          <td>${m.createdAt || m.ngay || ''}</td>
          <td>${m.content || m.noiDung || ''}</td>
          <td>${m.status || m.trangThai || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // G·ª≠i y√™u c·∫ßu b√°o h·ªèng / t·∫°m tr√∫ (placeholder)
    function openMaintenanceForm(){
      alert('Form b√°o h·ªèng: b·∫°n c√≥ th·ªÉ d√πng tenantMaintenance API nh∆∞ ƒë√£ c·∫•u h√¨nh ·ªü Apps Script.');
    }
    function openTempStayForm(){
      alert('Form ƒëƒÉng k√Ω t·∫°m tr√∫: d√πng tenantTempStay API.');
    }

    function downloadInvoicePdf(){
      // Gi·∫£i ph√°p ƒë∆°n gi·∫£n: in trang hi·ªán t·∫°i
      window.print();
    }

    async function fetchTenantPortalData(roomCode, identity){
      const note = document.getElementById('portalStatusNote');
      if (note) note.textContent = 'ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Google Sheet (Apps Script)...';

      try{
        const body = new URLSearchParams({
          action:   'tenantPortal',
          roomCode: roomCode,
          identity: identity || ''
        });

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body
        });
        const data = await res.json();

        if (!data || !data.success){
          if (note) note.textContent = (data && data.message) || 'Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu portal.';
          return;
        }

        if (note) note.textContent = 'D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ h·ªá th·ªëng (Google Sheet).';

        renderInfoCard(data);
        renderPaymentCard(data);
        renderMaintenance(data);
        renderMessages(data);

      } catch(err){
        console.error('fetchTenantPortalData error:',err);
        const noteEl = document.getElementById('portalStatusNote');
        if (noteEl) noteEl.textContent = 'L·ªói k·∫øt n·ªëi t·ªõi Apps Script, vui l√≤ng th·ª≠ l·∫°i.';
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Tab handler
      document.querySelectorAll('.tab-btn.tab-info').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          setActiveTab('info', btn.dataset.tab);
        });
      });
      document.querySelectorAll('.tab-btn.tab-pay').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          setActiveTab('pay', btn.dataset.tab);
        });
      });

      // L·∫•y tenant t·ª´ localStorage
      let tenant = null;
      try {
        const saved = localStorage.getItem(TENANT_STORAGE_KEY);
        if (saved) tenant = JSON.parse(saved);
      } catch(e){}

      if (!tenant || !tenant.maPhong){
        window.location.href = 'tenant.html';
        return;
      }

      fetchTenantPortalData(tenant.maPhong, tenant.identity || '');
    });
  </script>
</body>
</html>


