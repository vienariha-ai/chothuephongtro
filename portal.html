<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Portal t√†i kho·∫£n ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="yt-home-common.css" />
</head>
<body class="tenant-body">
  <div class="container">
    <header class="header">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn btn-outline">Trang xem ph√≤ng</a>
        <button type="button" class="btn btn-outline" onclick="logoutTenant()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">Xin ch√†o, c∆∞ d√¢n YT Home üè°</div>
      <div class="page-subtitle">
        ƒê√¢y l√† portal n·ªôi b·ªô d√†nh cho t√†i kho·∫£n ph√≤ng. D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ Google Sheet qua Apps Script.
      </div>
      <div id="portalStatusNote" class="portal-status">
        ƒêang t·∫£i d·ªØ li·ªáu ph√≤ng t·ª´ h·ªá th·ªëng...
      </div>

      <div class="grid">
        <!-- C·ªòT TR√ÅI: TH√îNG TIN -->
        <section class="card">
          <div class="card-title">Th√¥ng tin ph√≤ng</div>
          <div class="badge" id="roomBadge">Ph√≤ng: --</div>

          <div class="tab-row">
            <button class="tab-btn tab-info active" data-tab="owner">Ch·ªß ph√≤ng</button>
            <button class="tab-btn tab-info" data-tab="contract">T√≥m t·∫Øt h·ª£p ƒë·ªìng</button>
            <button class="tab-btn tab-info" data-tab="members">Ng∆∞·ªùi & xe</button>
          </div>

          <!-- TAB CH·ª¶ PH√íNG -->
          <div class="tab-pane tab-pane-info" id="tab-owner">
            <div class="info-row">
              <span class="info-label">Ph√≤ng:</span>
              <span class="info-value" id="roomLabel">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">T√™n ch·ªß ph√≤ng:</span>
              <span class="info-value" id="ownerName">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë CCCD:</span>
              <span class="info-value" id="ownerCCCD">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
              <span class="info-value" id="ownerPhone">--</span>
            </div>
            <div class="small-note">
              Th√¥ng tin ƒë∆∞·ª£c l·∫•y t·ª´ sheet <strong>Kh√°ch thu√™</strong> (Lo·∫°i = "Ch·ªß ph√≤ng", Tr·∫°ng th√°i = "ƒêang ·ªü").
            </div>
          </div>

          <!-- TAB H·ª¢P ƒê·ªíNG -->
          <div class="tab-pane tab-pane-info hidden" id="tab-contract">
            <ul class="list">
              <li>Tr·∫°ng th√°i: <strong id="contractStatus">--</strong></li>
              <li>Lo·∫°i Hƒê: <strong id="contractType">--</strong></li>
              <li>Th·ªùi gian: <strong id="contractPeriod">--</strong></li>
              <li>Ti·ªÅn thu√™: <strong id="contractRent">--</strong></li>
              <li>Ti·ªÅn c·ªçc: <strong id="contractDeposit">--</strong></li>
              <li>Ng√†y thu ti·ªÅn: <strong id="contractDueDay">--</strong></li>
              <li>D·ªãch v·ª• k√®m theo:</li>
            </ul>
            <ul class="list" id="contractServices"></ul>

            <button id="extendContractBtn" class="btn" style="margin-top:8px; display:none;">
              K√Ω ti·∫øp h·ª£p ƒë·ªìng
            </button>

            <div class="small-note">
              Hi·ªÉn th·ªã t·ª´ sheet <strong>H·ª£p ƒë·ªìng</strong>. N√∫t "K√Ω ti·∫øp h·ª£p ƒë·ªìng" ch·ªâ hi·ªán khi c√≤n &lt;= 1 th√°ng tr∆∞·ªõc ng√†y k·∫øt th√∫c.
            </div>
          </div>

          <!-- TAB NG∆Ø·ªúI & XE -->
          <div class="tab-pane tab-pane-info hidden" id="tab-members">
            <table class="table-like">
              <thead>
                <tr>
                  <th>H·ªç t√™n</th>
                  <th>ƒêi·ªán tho·∫°i</th>
                  <th>CCCD</th>
                  <th>Bi·ªÉn s·ªë</th>
                  <th>T·∫°m tr√∫</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="membersTableBody">
                <tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
              </tbody>
            </table>
            <div class="tenant-footer-actions">
              <span></span>
              <button class="btn" type="button" onclick="openTempStayForm()">ƒêƒÉng k√Ω t·∫°m tr√∫</button>
            </div>
          </div>
        </section>

        <!-- C·ªòT PH·∫¢I: THANH TO√ÅN -->
        <section class="card">
          <div class="card-title">Thanh to√°n</div>
          <div class="tab-row">
            <button class="tab-btn tab-pay active" data-tab="history">L·ªãch s·ª≠ thanh to√°n</button>
            <button class="tab-btn tab-pay" data-tab="detail">Chi ti·∫øt h√≥a ƒë∆°n</button>
          </div>

          <!-- TAB L·ªäCH S·ª¨ THANH TO√ÅN -->
          <div class="tab-pane tab-pane-pay" id="tab-history">
            <table class="table-like">
              <thead>
                <tr>
                  <th>K·ª≥ (NƒÉm th√°ng)</th>
                  <th>T·ªïng ƒêN + DV</th>
                  <th>T·ªïng ph·∫£i thu</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody">
                <tr>
                  <td colspan="4" class="muted">
                    H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="tenant-footer-actions">
              <span class="muted">Ch·ªâ hi·ªÉn th·ªã n·∫øu H·ª£p ƒë·ªìng c√≤n hi·ªáu l·ª±c.</span>
              <button class="btn" type="button" onclick="downloadInvoicePdf()">T·∫£i / In h√≥a ƒë∆°n</button>
            </div>
          </div>

          <!-- TAB CHI TI·∫æT H√ìA ƒê∆†N (k·ª≥ m·ªõi nh·∫•t) -->
          <div class="tab-pane tab-pane-pay hidden" id="tab-detail">
            <div id="invoiceSummary">
              <p><span class="inv-label">Ng√†y t√≠nh Hƒê:</span> <span class="inv-value" id="invNgayTinh">--</span></p>
              <p><span class="inv-label">Ti·ªÅn ph√≤ng thanh to√°n:</span> <span class="inv-value" id="invTienPhong">--</span></p>
              <p><span class="inv-label">T·ªïng d·ªãch v·ª• (ƒêN + DV):</span> <span class="inv-value" id="invTongDV">--</span></p>
              <p><span class="inv-label">Ph√°t sinh kh√°c:</span> <span class="inv-value" id="invPhatSinh">--</span></p>
              <p><span class="inv-label">Gi·∫£m tr·ª´ kh√°c:</span> <span class="inv-value" id="invGiamTru">--</span></p>
              <p><span class="inv-label">Thi·∫øu k·ª≥ tr∆∞·ªõc:</span> <span class="inv-value" id="invThieuTruoc">--</span></p>
              <p class="inv-total-row">
                <span class="inv-label">Ph·∫£i thu:</span>
                <span class="inv-total" id="invPhaiThu">--</span>
              </p>
            </div>
            <div class="section-title">Th√¥ng tin chuy·ªÉn kho·∫£n</div>
            <p class="small-note" id="invBankInfo">--</p>

            <div class="section-title">QR thanh to√°n</div>
            <div id="qrContainer" class="gallery-placeholder">Ch∆∞a c√≥ QR Code.</div>
          </div>
        </section>
      </div>

      <!-- H√ÄNG D∆Ø·ªöI: B·∫¢O TR√å + TIN NH·∫ÆN -->
      <div class="grid" style="margin-top:12px;">
        <!-- B·∫£o tr√¨ -->
        <section class="card">
          <div class="card-title">L·ªãch b·∫£o tr√¨</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>T√†i s·∫£n</th>
                <th>Lo·∫°i c√¥ng vi·ªác</th>
                <th>Ng√†y d·ª± ki·∫øn</th>
                <th>Ng√†y th·ª±c hi·ªán</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody id="maintenanceBody">
              <tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>
            </tbody>
          </table>
          <div class="tenant-footer-actions">
            <span class="muted">D·ªØ li·ªáu t·ª´ sheet "L·ªãch b·∫£o tr√¨".</span>
            <button type="button" class="btn" onclick="openMaintenanceForm()">B√°o h·ªèng</button>
          </div>
        </section>

        <!-- Tin nh·∫Øn / y√™u c·∫ßu -->
        <section class="card">
          <div class="card-title">Tin nh·∫Øn & y√™u c·∫ßu</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>Lo·∫°i</th>
                <th>Ng√†y</th>
                <th>N·ªôi dung</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="messageBody">
              <tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>
            </tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <script>
    const TENANT_STORAGE_KEY = "ytHomeTenant";
    const API_URL = "https://script.google.com/macros/s/AKfycbyrVC40zXWMybOxz4fsmG7XKF8sXQlSIlafX5LWISuU3uiRTYJWBsfP6qkutAmudy3VAw/exec";

    function logoutTenant() {
      try { localStorage.removeItem(TENANT_STORAGE_KEY); } catch(e){}
      window.location.href = "tenant.html";
    }

    function formatVND(amount){
      if(amount===null||amount===undefined||amount==='') return '--';
      const num = Number(String(amount).replace(/[^\d.-]/g,''));
      if(isNaN(num)) return String(amount);
      return num.toLocaleString('vi-VN') + ' ƒë';
    }

    function setActiveTab(group, tabName){
      document.querySelectorAll('.tab-btn.tab-' + group).forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('.tab-pane-' + group).forEach(pane=>{
        pane.classList.toggle('hidden', pane.id !== 'tab-' + tabName);
      });
    }
    // ƒê·ªïi m·ªçi ki·ªÉu ng√†y v·ªÅ Date r·ªìi format DD/MM/YYYY
    function toDateObject(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      const d = new Date(value);
      return isNaN(d) ? null : d;
     }

     function formatDateDDMMYYYY(value) {
        const d = toDateObject(value);
        if (!d) return value || '';
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      // Render tr·∫°ng th√°i d·∫°ng text ho·∫∑c n√∫t "xem chi ti·∫øt"
      function renderStatusHTML(text, context) {
        const raw = (text == null) ? '' : String(text).trim();
        if (!raw) {
          return '<span class="status-text muted">--</span>';
        }

          const lower = raw.toLowerCase();
          const isIncomplete =
            lower.includes('ch∆∞a') ||
            lower.includes('chua') ||
            lower.includes('c√≤n thi·∫øu') ||
            lower.includes('con thieu');

         if (!isIncomplete) {
            return `<span class="status-text">${raw}</span>`;
          }

          const safeStatus = raw.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const safeContext = (context || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

          return `
          <button type="button"
            class="status-chip status-chip-warning"
            onclick="openStatusDetail('${safeContext}','${safeStatus}')">
            ${raw}
          </button>`;
         }

        // Popup chi ti·∫øt ‚Äì hi·ªán t·∫°i ch·ªâ alert, sau b√† mu·ªën c√≥ modal ƒë·∫πp th√¨ m√¨nh l√†m th√™m
        function openStatusDetail(context, statusText) {
          const ctx = context ? `Ng·ªØ c·∫£nh: ${context}\n` : '';
          alert(ctx + 'Tr·∫°ng th√°i: ' + statusText);
        }
        // T√≠nh s·ªë th√°ng c√≤n l·∫°i gi·ªØa 2 ng√†y
        function monthsBetween(from, to) {
          const d1 = new Date(from);
          const d2 = new Date(to);
          if (isNaN(d1) || isNaN(d2)) return null;
        
          let months =
            (d2.getFullYear() - d1.getFullYear()) * 12 +
            (d2.getMonth() - d1.getMonth());
        
          // N·∫øu ng√†y trong th√°ng c√≤n ch∆∞a t·ªõi ‚Üí tr·ª´ 1
          if (d2.getDate() < d1.getDate()) months -= 1;
        
          return months;
        }
    
    // üîß B·∫¢N M·ªöI: renderInfoCard v·ªõi skeleton + ki·ªÉm tra null + ƒë·ªïi m√†u tr·∫°ng th√°i
    function renderInfoCard(data){
      const $ = (id) => document.getElementById(id);

      const roomBadge   = $('roomBadge');
      const roomLabel   = $('roomLabel');
      const ownerName   = $('ownerName');
      const ownerCCCD   = $('ownerCCCD');
      const ownerPhone  = $('ownerPhone');

      const contractStatusEl  = $('contractStatus');
      const contractTypeEl    = $('contractType');
      const contractPeriodEl  = $('contractPeriod');
      const contractRentEl    = $('contractRent');
      const contractDepositEl = $('contractDeposit');
      const contractDueDayEl  = $('contractDueDay');
      const contractServices  = $('contractServices');
      const extendBtn         = $('extendContractBtn');

      const membersBody       = $('membersTableBody');

      /********************************************************
       * 1. SKELETON LOADING KHI CH∆ØA C√ì DATA
       ********************************************************/
      const isEmptyData =
        !data ||
        typeof data !== 'object' ||
        Object.keys(data).length === 0;

      if (isEmptyData) {
        const skeletonTargets = [
          roomBadge, roomLabel,
          ownerName, ownerCCCD, ownerPhone,
          contractStatusEl, contractTypeEl,
          contractPeriodEl, contractRentEl,
          contractDepositEl, contractDueDayEl
        ];

        skeletonTargets.forEach(el => {
          if (!el) return;
          el.textContent = '';
          el.classList.add('skeleton');
        });

        if (contractServices) {
          contractServices.innerHTML =
            '<li class="skeleton">ƒêang t·∫£i th√¥ng tin d·ªãch v·ª•...</li>';
        }

        if (membersBody) {
          membersBody.innerHTML =
            '<tr><td colspan="6" class="muted skeleton">ƒêang t·∫£i danh s√°ch ng∆∞·ªùi ·ªü...</td></tr>';
        }

        if (extendBtn) {
          extendBtn.style.display = 'none';
        }

        return; // kh√¥ng render chi ti·∫øt khi ƒëang loading
      }

      // C√≥ data th·∫≠t ‚Üí b·ªè skeleton
      const allTargets = [
        roomBadge, roomLabel,
        ownerName, ownerCCCD, ownerPhone,
        contractStatusEl, contractTypeEl,
        contractPeriodEl, contractRentEl,
        contractDepositEl, contractDueDayEl
      ];
      allTargets.forEach(el => {
        if (el) el.classList.remove('skeleton');
      });
      if (membersBody) membersBody.classList.remove('skeleton');
      if (contractServices) contractServices.classList.remove('skeleton');

      /********************************************************
       * 2. TH√îNG TIN PH√íNG
       ********************************************************/
      const roomCode = (data && data.roomCode) ? data.roomCode : '--';
      if (roomBadge) roomBadge.textContent = 'Ph√≤ng: ' + roomCode;
      if (roomLabel) roomLabel.textContent = roomCode;

      /********************************************************
       * 3. TH√îNG TIN CH·ª¶ PH√íNG
       ********************************************************/
      const chuPhong = (data && data.chuPhong) ? data.chuPhong : {};
      if (ownerName)  ownerName.textContent  = chuPhong.hoTen     || '--';
      if (ownerCCCD)  ownerCCCD.textContent  = chuPhong.cccd      || '--';
      if (ownerPhone) ownerPhone.textContent = chuPhong.dienThoai || '--';

      /********************************************************
       * 4. TH√îNG TIN H·ª¢P ƒê·ªíNG
       ********************************************************/
      const contract = (data && data.contract) ? data.contract : null;
             
        /********************************************************
         * C·∫¢NH B√ÅO S·∫ÆP H·∫æT H·∫†N H·ª¢P ƒê·ªíNG
         ********************************************************/
        let monthsLeft = null;
        if (contract && contract.ngayKT) {
          monthsLeft = monthsBetween(new Date(), contract.ngayKT);
        }
        
        let warningClass = "";
        if (monthsLeft != null) {
          if (monthsLeft <= 1) warningClass = "contract-alert-red";
          else if (monthsLeft <= 2) warningClass = "contract-alert-yellow";
        }
        
        // Th√™m m√†u c·∫£nh b√°o v√†o contractStatusEl
        if (contractStatusEl) {
          contractStatusEl.classList.remove("contract-alert-red","contract-alert-yellow");
          if (warningClass) contractStatusEl.classList.add(warningClass);
        }

      // Map tr·∫°ng th√°i ‚Üí class m√†u
      function getStatusClass(statusText) {
        if (!statusText) return '';
        const s = statusText.toString().toLowerCase();

        if (s.includes('hi·ªáu l·ª±c') || s.includes('ƒëang thu√™')) {
          return 'badge-success';
        }
        if (s.includes('s·∫Øp h·∫øt') || s.includes('ch·ªù gia h·∫°n')) {
          return 'badge-warning';
        }
        if (s.includes('h·∫øt h·∫°n') || s.includes('thanh l√Ω') || s.includes('ng∆∞ng')) {
          return 'badge-danger';
        }
        return 'badge-neutral';
      }

      // Tr·∫°ng th√°i + m√†u
      if (contractStatusEl) {
        const text = contract ? (contract.trangThai || '--') : '--';
        contractStatusEl.textContent = text;

        contractStatusEl.classList.remove(
          'badge-success','badge-warning','badge-danger','badge-neutral'
        );
        const statusClass = getStatusClass(text);
        if (statusClass) contractStatusEl.classList.add(statusClass);
      }

      // Lo·∫°i Hƒê
      if (contractTypeEl) {
        contractTypeEl.textContent = contract ? (contract.loaiHD || '--') : '--';
      }

      // Th·ªùi gian Hƒê
     // Th·ªùi gian Hƒê (format + s·ªë ng√†y c√≤n l·∫°i)
      if (contractPeriodEl) {
        let baseText = '--';
        let daysLeftText = '';
      
        if (contract && (contract.ngayBD || contract.ngayKT)) {
          const startRaw = contract.ngayBD ? contract.ngayBD : '';
          const endRaw   = contract.ngayKT ? contract.ngayKT : '';
      
          const start = startRaw ? formatDateDDMMYYYY(startRaw) : '';
          const end   = endRaw   ? formatDateDDMMYYYY(endRaw)   : '';
      
          baseText = (start && end) ? (start + ' ‚Äì ' + end) : (start || end || '--');
      
          // üî¢ T√≠nh s·ªë ng√†y c√≤n l·∫°i ƒë·∫øn ng√†y KT
          const endDateObj = toDateObject(endRaw);
          if (endDateObj) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const diffMs   = endDateObj.getTime() - today.getTime();
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24)); // l√†m tr√≤n l√™n
      
            if (diffDays >= 0) {
              let cls = '';
              if (diffDays < 30)      cls = 'days-left-red';    // < 1 th√°ng ‚Üí ƒë·ªè
              else if (diffDays < 60) cls = 'days-left-yellow'; // < 2 th√°ng ‚Üí v√†ng
      
              if (cls) {
                daysLeftText =
                  ` <span class="${cls}">(c√≤n ${diffDays} ng√†y)</span>`;
              } else {
                // N·∫øu mu·ªën th√¨ c√≥ th·ªÉ ƒë·ªÉ trung t√≠nh, c√≤n kh√¥ng th√¨ ƒë·ªÉ chu·ªói r·ªóng
                // daysLeftText = ` <span class="days-left-neutral">(c√≤n ${diffDays} ng√†y)</span>`;
              }
            }
          }
        }
      
        // d√πng innerHTML ƒë·ªÉ g·∫Øn th√™m span m√†u
        contractPeriodEl.innerHTML = baseText + daysLeftText;
      }
     
      // Ti·ªÅn thu√™, c·ªçc, ng√†y thu
      if (contractRentEl) {
        contractRentEl.textContent = (contract && contract.tienThue != null)
          ? formatVND(contract.tienThue)
          : '--';
      }

      if (contractDepositEl) {
        contractDepositEl.textContent = (contract && contract.tienCoc != null)
          ? formatVND(contract.tienCoc)
          : '--';
      }

      if (contractDueDayEl) {
        contractDueDayEl.textContent = contract ? (contract.ngayThuTien || '--') : '--';
      }

      /********************************************************
       * 5. D·ªäCH V·ª§ TRONG H·ª¢P ƒê·ªíNG
       ********************************************************/
      if (contractServices) {
        contractServices.innerHTML = '';

        if (contract) {
          ['1','2','3'].forEach(n => {
            const ma = contract['maDV' + n];
            const dg = contract['donGiaDV' + n];
            if (ma) {
              const li = document.createElement('li');
              li.textContent = ma + (dg != null ? (' ‚Äì ' + formatVND(dg)) : '');
              contractServices.appendChild(li);
            }
          });

          if (!contractServices.childElementCount) {
            const li = document.createElement('li');
            li.textContent = 'Ch∆∞a c·∫•u h√¨nh d·ªãch v·ª•.';
            contractServices.appendChild(li);
          }
        } else {
          const li = document.createElement('li');
          li.textContent = 'Kh√¥ng c√≥ h·ª£p ƒë·ªìng ƒë·ªÉ hi·ªÉn th·ªã d·ªãch v·ª•.';
          contractServices.appendChild(li);
        }
      }

      /********************************************************
       * 6. N√öT GIA H·∫†N H·ª¢P ƒê·ªíNG ‚Äì ƒê·ªîI M√ÄU THEO TR·∫†NG TH√ÅI
       ********************************************************/
      if (extendBtn) {
        if (contract && contract.coTheGiaHan) {
          extendBtn.style.display = 'inline-flex';
          extendBtn.textContent = "Gia h·∫°n h·ª£p ƒë·ªìng";  // üî• ƒë·ªïi t√™n n√∫t
          
          extendBtn.classList.remove(
            'btn-disabled','btn-warning','btn-danger','btn-accent'
          );
          
          if (monthsLeft != null) {
            if (monthsLeft <= 1) {
              extendBtn.classList.add("btn-danger"); // ƒë·ªè
            } else if (monthsLeft <= 2) {
              extendBtn.classList.add("btn-warning"); // v√†ng
            } else {
              extendBtn.classList.add("btn-accent"); // m√†u n·ªïi b·∫≠t chung
            }
          }


          const statusText = contract.trangThai ? contract.trangThai.toString().toLowerCase() : '';
          if (statusText.includes('h·∫øt h·∫°n')) {
            extendBtn.classList.add('btn-danger');
          } else if (statusText.includes('s·∫Øp h·∫øt')) {
            extendBtn.classList.add('btn-warning');
          }
        } else {
          extendBtn.style.display = 'none';
        }
      }

      /********************************************************
       * 7. DANH S√ÅCH NG∆Ø·ªúI ·ªû
       ********************************************************/
      if (membersBody) {
        membersBody.innerHTML = '';
        const members = Array.isArray(data.members) ? data.members : [];

        if (!members.length) {
          membersBody.innerHTML =
            '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ ng∆∞·ªùi ·ªü.</td></tr>';
        } else {
          members.forEach(m => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${m.hoTen || ''}</td>
              <td>${m.dienThoai || ''}</td>
              <td>${m.cccd || ''}</td>
              <td>${m.bienSo || ''}</td>
              <td>${m.ngayTamTru ? formatDateDDMMYYYY(m.ngayTamTru) : ''}</td>
              <td>${renderStatusHTML(m.trangThaiTamTru, 'tamtru')}</td>
            `;
            membersBody.appendChild(tr);
          });
        }
      }
    }

    function renderPaymentCard(data){
      const historyBody = document.getElementById('paymentHistoryBody');
      if (!historyBody) return;
      historyBody.innerHTML = '';

      const invoices = (data && Array.isArray(data.invoices)) ? data.invoices : [];

      if (!data || !data.contract || !String(data.contract.trangThai || '').toLowerCase().includes('hi·ªáu l·ª±c')) {
        historyBody.innerHTML = `
          <tr>
            <td colspan="4" class="muted">
              H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.
            </td>
          </tr>`;
        return;
      }

      if (!invoices.length){
        historyBody.innerHTML = `
          <tr>
            <td colspan="4" class="muted">
              Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o cho ph√≤ng n√†y.
            </td>
          </tr>`;
      } else {
        invoices.forEach(inv=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${inv.namThang || ''}</td>
            <td>${formatVND(inv.tongDN_DV)}</td>
            <td>${formatVND(inv.tongPhaiThu)}</td>
            <td>${renderStatusHTML(inv.trangThai, 'invoice')}</td>
          `;
          historyBody.appendChild(tr);
        });
      }

      // Chi ti·∫øt h√≥a ƒë∆°n = b·∫£n ghi m·ªõi nh·∫•t
      const latest = invoices[0];
      if (!latest) return;
      const c = latest.chiTiet || {};

      document.getElementById('invNgayTinh').textContent =     Number.isFinite(Number(c.ngayTinhHD))
      ? `${parseInt(c.ngayTinhHD)} ng√†y`: "--";
      document.getElementById('invTienPhong').textContent  = formatVND(c.tienPhongTT);
      document.getElementById('invTongDV').textContent     = formatVND(c.tongDichVu);
      document.getElementById('invPhatSinh').textContent   = formatVND(c.phatSinhKhac);
      document.getElementById('invGiamTru').textContent    = formatVND(c.giamTruKhac);
      document.getElementById('invThieuTruoc').textContent = formatVND(c.thieuKyTruoc);
      document.getElementById('invPhaiThu').textContent    = formatVND(c.phaiThu);

      const bankInfo = c.bankInfo || {};
      const bankText = [
        bankInfo.soTaiKhoan ? ('STK: ' + bankInfo.soTaiKhoan) : '',
        bankInfo.chuTaiKhoan ? ('Ch·ªß TK: ' + bankInfo.chuTaiKhoan) : '',
        bankInfo.nganHang ? ('Ng√¢n h√†ng: ' + bankInfo.nganHang) : '',
        bankInfo.chiNhanh ? ('Chi nh√°nh: ' + bankInfo.chiNhanh) : ''
      ].filter(Boolean).join(' ‚Ä¢ ');

      document.getElementById('invBankInfo').textContent = bankText || '--';

      const qrContainer = document.getElementById('qrContainer');
      if (!qrContainer) return;
      qrContainer.innerHTML = '';
      if (c.qrCode){
        const img = document.createElement('img');
        img.src = c.qrCode;
        img.alt = 'QR thanh to√°n';
        img.style.maxWidth = '160px';
        img.style.marginTop = '4px';
        qrContainer.appendChild(img);
      } else {
        qrContainer.textContent = 'Ch∆∞a c√≥ QR Code.';
      }
    }

    function renderMaintenance(data){
      const tbody = document.getElementById('maintenanceBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const list = (data && Array.isArray(data.maintenance)) ? data.maintenance : [];
      if (!list.length){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>';
        return;
      }
      list.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.tenTaiSan || ''}</td>
          <td>${m.loaiCongViec || ''}</td>
          <td>${m.ngayDuKien ? formatDateDDMMYYYY(m.ngayDuKien) : ''}</td>
          <td>${m.ngayThucHien ? formatDateDDMMYYYY(m.ngayThucHien) : ''}</td>
          <td>${m.trangThai || ''}</td>
          <td>${m.ghiChu || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderMessages(data){
      const tbody = document.getElementById('messageBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const msgs = (data && Array.isArray(data.messages)) ? data.messages : [];
      if (!msgs.length){
        tbody.innerHTML = '<tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>';
        return;
      }
      msgs.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.type || m.loai || ''}</td>
          <td>${m.createdAt || m.ngay || ''}</td>
          <td>${m.content || m.noiDung || ''}</td>
          <td>${renderStatusHTML(m.status || m.trangThai || '', 'message')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // G·ª≠i y√™u c·∫ßu b√°o h·ªèng / t·∫°m tr√∫ (placeholder)
    function openMaintenanceForm(){
      alert('Form b√°o h·ªèng: b·∫°n c√≥ th·ªÉ d√πng tenantMaintenance API nh∆∞ ƒë√£ c·∫•u h√¨nh ·ªü Apps Script.');
    }
    function openTempStayForm(){
      alert('Form ƒëƒÉng k√Ω t·∫°m tr√∫: d√πng tenantTempStay API.');
    }

    function downloadInvoicePdf(){
      window.print();
    }

    async function fetchTenantPortalData(roomCode, identity){
      const note = document.getElementById('portalStatusNote');
      if (note) note.textContent = 'ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Google Sheet (Apps Script)...';

      // G·ªçi skeleton tr∆∞·ªõc khi fetch
      renderInfoCard(null);

      try{
        const body = new URLSearchParams({
          action:   'tenantPortal',
          roomCode: roomCode,
          identity: identity || ''
        });

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body
        });
        const data = await res.json();

        if (!data || !data.success){
          if (note) note.textContent = (data && data.message) || 'Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu portal.';
          return;
        }

        if (note) note.textContent = 'D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ h·ªá th·ªëng (Google Sheet).';

        renderInfoCard(data);
        renderPaymentCard(data);
        renderMaintenance(data);
        renderMessages(data);

      } catch(err){
        console.error('fetchTenantPortalData error:',err);
        const noteEl = document.getElementById('portalStatusNote');
        if (noteEl) noteEl.textContent = 'L·ªói k·∫øt n·ªëi t·ªõi Apps Script, vui l√≤ng th·ª≠ l·∫°i.';
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Tab handler
      document.querySelectorAll('.tab-btn.tab-info').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          setActiveTab('info', btn.dataset.tab);
        });
      });
      document.querySelectorAll('.tab-btn.tab-pay').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          setActiveTab('pay', btn.dataset.tab);
        });
      });

      // L·∫•y tenant t·ª´ localStorage
      let tenant = null;
      try {
        const saved = localStorage.getItem(TENANT_STORAGE_KEY);
        if (saved) tenant = JSON.parse(saved);
      } catch(e){}

      if (!tenant || !tenant.maPhong){
        window.location.href = 'tenant.html';
        return;
      }
      fetchTenantPortalData(tenant.maPhong, tenant.identity || '');
    });
  </script>
</body>
</html>







