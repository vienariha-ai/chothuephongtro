<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Portal t√†i kho·∫£n ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="yt-home-common.css" />
</head>
<body class="tenant-body">
  <div class="container">
    <header class="header">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn btn-outline">Trang xem ph√≤ng</a>
        <button type="button" class="btn btn-outline" onclick="logoutTenant()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">Xin ch√†o, c∆∞ d√¢n YT Home üè°</div>
      <div class="page-subtitle">
        ƒê√¢y l√† portal n·ªôi b·ªô d√†nh cho t√†i kho·∫£n ph√≤ng. D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ Google Sheet qua Apps Script.
      </div>
      <div id="portalStatusNote" class="portal-status">
        ƒêang t·∫£i d·ªØ li·ªáu ph√≤ng t·ª´ h·ªá th·ªëng...
      </div>

      <div class="grid">
        <!-- C·ªòT TR√ÅI: TH√îNG TIN -->
        <section class="card">
          <div class="card-title">Th√¥ng tin ph√≤ng</div>
          <div class="room-badge-row">
            <span class="badge" id="roomBadge">Ph√≤ng: --</span>
            <span id="contractAlertBadge" class="contract-alert-badge hidden"></span>
          </div>
          <div id="contractDaysLeft" class="contract-days-left hidden">C√≤n -- ng√†y</div>

          <div class="tab-row">
            <button class="tab-btn tab-info active" data-tab="owner">Ch·ªß ph√≤ng</button>
            <button class="tab-btn tab-info" data-tab="contract">T√≥m t·∫Øt h·ª£p ƒë·ªìng</button>
            <button class="tab-btn tab-info" data-tab="assets">Danh s√°ch thi·∫øt b·ªã</button>
          </div>

          <!-- TAB CH·ª¶ PH√íNG -->
          <div class="tab-pane tab-pane-info" id="tab-owner">
            <div class="info-row">
              <span class="info-label">Ph√≤ng:</span>
              <span class="info-value" id="roomLabel">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">T√™n ch·ªß ph√≤ng:</span>
              <span class="info-value owner-name" id="ownerName">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë CCCD:</span>
              <span class="info-value" id="ownerCCCD">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
              <span class="info-value" id="ownerPhone">--</span>
            </div>
            <div class="small-note">
              <!--Th√¥ng tin ƒë∆∞·ª£c l·∫•y t·ª´ sheet <strong>Kh√°ch thu√™</strong> (Lo·∫°i = "Ch·ªß ph√≤ng", Tr·∫°ng th√°i = "ƒêang ·ªü").-->
            </div>
          
            <div class="section-title" style="margin-top:12px;">Danh s√°ch ng∆∞·ªùi trong ph√≤ng</div>
            <table class="table-like table-center">
              <thead>
                <tr>
                  <th>H·ªç t√™n</th>
                  <th>ƒêi·ªán tho·∫°i</th>
                  <th>CCCD</th>
                  <th>Bi·ªÉn s·ªë</th>
                  <th>T·∫°m tr√∫</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="membersTableBody">
                <tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
              </tbody>
            </table>
            <div class="tenant-footer-actions">
              <span class="muted">ƒêƒÉng k√Ω t·∫°m tr√∫ cho ng∆∞·ªùi ·ªü.</span>
              <button class="btn" type="button" onclick="openTempStayForm()">ƒêƒÉng k√Ω t·∫°m tr√∫</button>
            </div>

          </div>

          <!-- TAB H·ª¢P ƒê·ªíNG -->
          <div class="tab-pane tab-pane-info hidden" id="tab-contract">
            <ul class="list">
              <li>Tr·∫°ng th√°i: <strong id="contractStatus">--</strong></li>
              <li>Lo·∫°i Hƒê: <strong id="contractType">--</strong></li>
              <li>Th·ªùi gian: <strong id="contractPeriod">--</strong></li>
              <li>Ti·ªÅn thu√™: <strong id="contractRent">--</strong></li>
              <li>Ti·ªÅn c·ªçc: <strong id="contractDeposit">--</strong></li>
              <li>Ng√†y thu ti·ªÅn: <strong id="contractDueDay">--</strong></li>
              <li>D·ªãch v·ª• k√®m theo:</li>
            </ul>
            <ul class="list" id="contractServices"></ul>

            <button id="extendContractBtn" class="btn" style="margin-top:8px; display:none;">
              K√Ω ti·∫øp h·ª£p ƒë·ªìng
            </button>

            <div class="small-note">
              Hi·ªÉn th·ªã t·ª´ sheet <strong>H·ª£p ƒë·ªìng</strong>. N√∫t "K√Ω ti·∫øp h·ª£p ƒë·ªìng" ch·ªâ hi·ªán khi c√≤n &lt;= 1 th√°ng tr∆∞·ªõc ng√†y k·∫øt th√∫c.
            </div>
          </div>
        

<!-- TAB THI·∫æT B·ªä / T√ÄI S·∫¢N -->
          <div class="tab-pane tab-pane-info hidden" id="tab-assets">
            <table class="table-like table-fixed">
              <thead>
                <tr>
                  <th>T√™n thi·∫øt b·ªã</th>
                  <th>T√¨nh tr·∫°ng</th>
                  <th>B·∫£o h√†nh</th>
                  <th>B·∫£o tr√¨/V·ªá sinh g·∫ßn nh·∫•t</th>
                  <th>B√°o h·ªèng</th>
                </tr>
              </thead>
              <tbody id="assetsTableBody">
                <tr><td colspan="5" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu thi·∫øt b·ªã.</td></tr>
              </tbody>
            </table>
            <div class="small-note">
              D·ªØ li·ªáu l·∫•y t·ª´ sheet <strong>T√†i s·∫£n</strong> theo <strong>M√£ ph√≤ng</strong>. N√∫t "B√°o h·ªèng" s·∫Ω t·∫°o y√™u c·∫ßu g·ª≠i cho ch·ªß nh√†.
            </div>
          </div>

</section>

        
        <!-- C·ªòT PH·∫¢I: THANH TO√ÅN -->
        <section class="card">
          <div class="card-title">Thanh to√°n</div>

          <div class="tab-row">
            <button class="tab-btn tab-pay active" data-tab="history">L·ªãch s·ª≠ thanh to√°n</button>
            <button class="tab-btn tab-pay" data-tab="detail">Chi ti·∫øt h√≥a ƒë∆°n</button>
          </div>

          <!-- TAB (1) L·ªäCH S·ª¨ THANH TO√ÅN -->
          <div class="tab-pane tab-pane-pay" id="tab-history">
            <table class="table-like">
              <thead>
                <tr>
                  <th>K·ª≥ (NƒÉm th√°ng)</th>
                  <th>T·ªïng ph·∫£i thu</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Chi ti·∫øt</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody">
                <tr>
                  <td colspan="4" class="muted">
                    H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="tenant-footer-actions">
              <span class="muted">Ch·ªâ hi·ªÉn th·ªã n·∫øu H·ª£p ƒë·ªìng c√≤n hi·ªáu l·ª±c.</span>
              <button class="btn" type="button" onclick="downloadInvoicePdf()">T·∫£i / In h√≥a ƒë∆°n</button>
            </div>
          </div>

          <!-- TAB (2) CHI TI·∫æT H√ìA ƒê∆†N -->
          <div class="tab-pane tab-pane-pay hidden" id="tab-detail">
            <div class="detail-head">
              <div class="detail-title">
                <div class="muted" id="invKy">K·ª≥: --</div>
              </div>
              <div class="detail-actions">
                <span id="invStatusPill" class="pill pill-neutral">--</span>
                <button id="invPayBtn" type="button" class="btn btn-danger btn-sm" style="display:none;" onclick="openPaymentModal()">
                  Thanh to√°n
                </button>
              </div>
            </div>

            <div id="invoiceSummary">
              <p><span class="inv-label">Ng√†y t√≠nh Hƒê:</span> <span class="inv-value" id="invNgayTinh">--</span></p>
              <p><span class="inv-label">Ti·ªÅn ph√≤ng thanh to√°n:</span> <span class="inv-value" id="invTienPhong">--</span></p>
              <p><span class="inv-label">T·ªïng ti·ªÅn d·ªãch v·ª•:</span> <span class="inv-value" id="invTongDV">--</span></p>
              <p><span class="inv-label">Ph√°t sinh kh√°c:</span> <span class="inv-value" id="invPhatSinh">--</span></p>
              <p><span class="inv-label">Gi·∫£m tr·ª´ kh√°c:</span> <span class="inv-value" id="invGiamTru">--</span></p>
              <p><span class="inv-label">Thi·∫øu k·ª≥ tr∆∞·ªõc:</span> <span class="inv-value" id="invThieuTruoc">--</span></p>
              <p class="inv-total-row">
                <span class="inv-label">Ph·∫£i thu:</span>
                <span class="inv-total" id="invPhaiThu">--</span>
              </p>
            </div>

            <div class="section-title">Chi ti·∫øt d·ªãch v·ª•</div>
            <div class="table-wrap">
              <table class="table-like table-dv">
                <thead>
                  <tr>
                    <th>T√™n d·ªãch v·ª•</th>
                    <th>S·ªë ƒë·∫ßu</th>
                    <th>S·ªë cu·ªëi</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>Th√†nh ti·ªÅn</th>
                  </tr>
                </thead>
                <tbody id="invoiceServiceBody">
                  <tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu d·ªãch v·ª•.</td></tr>
                </tbody>
                <tfoot>
                  <tr class="dv-total-row">
                    <td colspan="5" class="dv-total-label">T·ªïng</td>
                    <td class="dv-total" id="invServiceTotal">--</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- TH√îNG TIN CHUY·ªÇN KHO·∫¢N + QR (lu√¥n n·∫±m b√™n d∆∞·ªõi 2 tab) -->
          <div class="pay-bottom">
            <div class="section-title">Th√¥ng tin chuy·ªÉn kho·∫£n</div>
            <p class="small-note" id="invBankInfo">--</p>

            <div class="section-title">QR thanh to√°n</div>
            <div id="qrContainer" class="gallery-placeholder">Ch∆∞a c√≥ QR Code.</div>
          </div>
        </section>

      </div>

      <!-- H√ÄNG D∆Ø·ªöI: B·∫¢O TR√å + TIN NH·∫ÆN -->
      <div class="grid" style="margin-top:12px;">
        <!-- B·∫£o tr√¨ -->
        <section class="card">
          <div class="card-title">L·ªãch b·∫£o tr√¨</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>T√†i s·∫£n</th>
                <th>Lo·∫°i c√¥ng vi·ªác</th>
                <th>Ng√†y d·ª± ki·∫øn</th>
                <th>Ng√†y th·ª±c hi·ªán</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody id="maintenanceBody">
              <tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>
            </tbody>
          </table>
          <div class="tenant-footer-actions">
            <span class="muted">D·ªØ li·ªáu t·ª´ sheet "L·ªãch b·∫£o tr√¨".</span>
            <button type="button" class="btn" onclick="openMaintenanceForm()">B√°o h·ªèng</button>
          </div>
        </section>

        <!-- Tin nh·∫Øn / y√™u c·∫ßu -->
        <section class="card">
          <div class="card-title">Tin nh·∫Øn & y√™u c·∫ßu</div>
          <table class="table-like">
            <thead>
              <tr>
                <th>Lo·∫°i</th>
                <th>Ng√†y</th>
                <th>N·ªôi dung</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody id="messageBody">
              <tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>
            </tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <!-- POPUP THANH TO√ÅN -->
  <div class="modal hidden" id="paymentModal" role="dialog" aria-modal="true" aria-labelledby="paymentModalTitle">
    <div class="modal-backdrop" onclick="closePaymentModal()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="paymentModalTitle">X√°c nh·∫≠n thanh to√°n</div>
        <button class="modal-x" type="button" onclick="closePaymentModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="small-note" id="paymentModalMeta">H√≥a ƒë∆°n: --</div>

        <label class="field">
          <div class="field-label">ƒê√≠nh k√®m phi·∫øu chuy·ªÉn kho·∫£n (·∫£nh)</div>
          <input type="file" id="paymentProofFile" accept="image/*" />
          <div class="field-help">C√≥ th·ªÉ ch·ª•p m√†n h√¨nh/·∫£nh bi√™n lai chuy·ªÉn kho·∫£n.</div>
        </label>

        <label class="field">
          <div class="field-label">Ghi ch√∫ cho ch·ªß nh√† (tu·ª≥ ch·ªçn)</div>
          <textarea id="paymentNote" rows="3" placeholder="V√≠ d·ª•: Em ƒë√£ chuy·ªÉn kho·∫£n l√∫c 20:15, nh·ªù ch·ªß nh√† ki·ªÉm tra gi√∫p ·∫°."></textarea>
        </label>

        <div id="paymentPreview" class="payment-preview muted">Ch∆∞a ch·ªçn ·∫£nh.</div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" type="button" onclick="closePaymentModal()">H·ªßy</button>
        <button class="btn btn-danger" type="button" onclick="submitPaymentProof()">G·ª≠i x√°c nh·∫≠n</button>
      </div>
    </div>
  </div>


<script>
  const TENANT_STORAGE_KEY = "ytHomeTenant";
  const API_URL = "https://script.google.com/macros/s/AKfycbwJ6i5jZRwhwSohFTU46ZRFAYUE8_5vQ5gvVwCuK0n_h-r0lobn9or39u6jlo1SjYzg/exec";
  let CURRENT_INVOICES = [];
  let CURRENT_SELECTED_INVOICE = null;

  // ‚úÖ FIX: b·∫°n ƒëang g·ªçi fetchTenantPortalData nh∆∞ng ch∆∞a ƒë·ªãnh nghƒ©a
  async function fetchTenantPortalData(roomCode, identity){
    return fetchData(roomCode, identity);
  }

  function logoutTenant() {
    try { localStorage.removeItem(TENANT_STORAGE_KEY); } catch(e){}
    window.location.href = "tenant.html";
  }
  function renderRegisterStatus(statusText) {
    const s = String(statusText || '').toLowerCase();
    if (s.includes('ƒë√£')) {
      return `<span class="status-registered">ƒê√£ ƒëƒÉng k√Ω</span>`;
    }
    return `<span class="status-unregistered">Ch∆∞a ƒëƒÉng k√Ω</span>`;
  }

  function formatVND(amount){
    if(amount===null||amount===undefined||amount==='') return '--';
    const num = Number(String(amount).replace(/[^\d.-]/g,''));
    if(isNaN(num)) return String(amount);
    return num.toLocaleString('vi-VN') + ' ƒë';
  }

  function maskLast4Digits(v){
    const s = String(v || '').replace(/\s+/g,'').trim();
    if (!s) return '--';
    const last4 = s.slice(-4);
    return '****' + last4;
  }

  function setActiveTab(group, tabName){
    document.querySelectorAll('.tab-btn.tab-' + group).forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.tab === tabName);
    });
    document.querySelectorAll('.tab-pane-' + group).forEach(pane=>{
      pane.classList.toggle('hidden', pane.id !== 'tab-' + tabName);
    });
  }

  function toDateObject(value) {
    if (!value) return null;
    if (value instanceof Date) return value;
    const d = new Date(value);
    return isNaN(d) ? null : d;
  }

  function formatDateDDMMYYYY(value) {
    const d = toDateObject(value);
    if (!d) return value || '';
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

 function renderStatusHTML(text, context) {
  const raw = (text == null) ? '' : String(text).trim();
  if (!raw) return '<span class="status-text muted">--</span>';

  const lower = raw.toLowerCase();

  /* ===== ƒê√É ƒêƒÇNG K√ù / ƒê√É HO√ÄN T·∫§T ===== */
  const isCompleted =
    lower.includes('ƒë√£') ||
    lower.includes('da ') ||
    lower === 'ok' ||
    lower === 'h·ª£p l·ªá' ||
    lower === 'hop le';

  if (isCompleted) {
    return `<span class="status-text status-text-success">${raw}</span>`;
  }

  /* ===== CH∆ØA / C√íN THI·∫æU ===== */
  const isIncomplete =
    lower.includes('ch∆∞a') ||
    lower.includes('chua') ||
    lower.includes('c√≤n thi·∫øu') ||
    lower.includes('con thieu');

  if (!isIncomplete) {
    return `<span class="status-text">${raw}</span>`;
  }

  /* ===== CHIP C·∫¢NH B√ÅO CLICK ===== */
  const safeStatus = raw.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  const safeContext = (context || '')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  return `
    <button type="button"
      class="status-chip status-chip-warning"
      onclick="openStatusDetail('${safeContext}','${safeStatus}')">
      ${raw}
    </button>`;
}


  function openStatusDetail(context, statusText) {
    const ctx = context ? `Ng·ªØ c·∫£nh: ${context}\n` : '';
    alert(ctx + 'Tr·∫°ng th√°i: ' + statusText);
  }

  function monthsBetween(from, to) {
    const d1 = new Date(from);
    const d2 = new Date(to);
    if (isNaN(d1) || isNaN(d2)) return null;

    let months =
      (d2.getFullYear() - d1.getFullYear()) * 12 +
      (d2.getMonth() - d1.getMonth());

    if (d2.getDate() < d1.getDate()) months -= 1;
    return months;
  }

  function getInvoiceStatusMode(inv){
    const txt = (inv && inv.trangThai ? String(inv.trangThai) : '').toLowerCase();
    if (!txt) return 'unknown';
    if (txt.includes('thi·∫øu') || txt.includes('con thieu')) return 'need-pay';
    if (txt.includes('thu ƒë·ªß') || txt.includes('thu du') || txt.includes('ƒë√£ thanh to√°n') || txt.includes('da thanh toan')) return 'paid';
    return 'unknown';
  }

  // =========================
  // INFO CARD (gi·ªØ nguy√™n code b·∫°n)
  // =========================
  function renderInfoCard(data){
    const $ = (id) => document.getElementById(id);

    const roomBadge   = $('roomBadge');
    const roomLabel   = $('roomLabel');
    const ownerName   = $('ownerName');
    const ownerCCCD   = $('ownerCCCD');
    const ownerPhone  = $('ownerPhone');

    const contractStatusEl  = $('contractStatus');
    const contractTypeEl    = $('contractType');
    const contractPeriodEl  = $('contractPeriod');
    const contractRentEl    = $('contractRent');
    const contractDepositEl = $('contractDeposit');
    const contractDueDayEl  = $('contractDueDay');
    const contractServices  = $('contractServices');
    const extendBtn         = $('extendContractBtn');

    const membersBody       = $('membersTableBody');

    const isEmptyData =
      !data || typeof data !== 'object' || Object.keys(data).length === 0;

    if (isEmptyData) {
      const skeletonTargets = [
        roomBadge, roomLabel,
        ownerName, ownerCCCD, ownerPhone,
        contractStatusEl, contractTypeEl,
        contractPeriodEl, contractRentEl,
        contractDepositEl, contractDueDayEl
      ];

      skeletonTargets.forEach(el => {
        if (!el) return;
        el.textContent = '';
        el.classList.add('skeleton');
      });

      if (contractServices) {
        contractServices.innerHTML = '<li class="skeleton">ƒêang t·∫£i th√¥ng tin d·ªãch v·ª•...</li>';
      }

      if (membersBody) {
        membersBody.innerHTML = '<tr><td colspan="6" class="muted skeleton">ƒêang t·∫£i danh s√°ch ng∆∞·ªùi ·ªü...</td></tr>';
      }

      if (extendBtn) extendBtn.style.display = 'none';
      return;
    }

    const allTargets = [
      roomBadge, roomLabel,
      ownerName, ownerCCCD, ownerPhone,
      contractStatusEl, contractTypeEl,
      contractPeriodEl, contractRentEl,
      contractDepositEl, contractDueDayEl
    ];
    allTargets.forEach(el => { if (el) el.classList.remove('skeleton'); });
    if (membersBody) membersBody.classList.remove('skeleton');
    if (contractServices) contractServices.classList.remove('skeleton');

    const roomCode = (data && data.roomCode) ? data.roomCode : '--';
    if (roomBadge) roomBadge.textContent = 'Ph√≤ng: ' + roomCode;
    if (roomLabel) roomLabel.textContent = roomCode;

    const chuPhong = (data && data.chuPhong) ? data.chuPhong : {};
    if (ownerName)  ownerName.textContent  = chuPhong.hoTen     || '--';
    if (ownerCCCD)  ownerCCCD.textContent  = chuPhong.cccd ? maskLast4Digits(chuPhong.cccd) : '--';
    if (ownerPhone) ownerPhone.textContent = chuPhong.dienThoai ? maskLast4Digits(chuPhong.dienThoai) : '--';

    const contract = (data && data.contract) ? data.contract : null;

    let monthsLeft = null;
    if (contract && contract.ngayKT) monthsLeft = monthsBetween(new Date(), contract.ngayKT);

    let warningClass = "";
    if (monthsLeft != null) {
      if (monthsLeft <= 1) warningClass = "contract-alert-red";
      else if (monthsLeft <= 2) warningClass = "contract-alert-yellow";
    }

    if (contractStatusEl) {
      contractStatusEl.classList.remove("contract-alert-red","contract-alert-yellow");
      if (warningClass) contractStatusEl.classList.add(warningClass);
    }

    function getStatusClass(statusText) {
      if (!statusText) return '';
      const s = statusText.toString().toLowerCase();
      if (s.includes('hi·ªáu l·ª±c') || s.includes('ƒëang thu√™')) return 'badge-success';
      if (s.includes('s·∫Øp h·∫øt') || s.includes('ch·ªù gia h·∫°n')) return 'badge-warning';
      if (s.includes('h·∫øt h·∫°n') || s.includes('thanh l√Ω') || s.includes('ng∆∞ng')) return 'badge-danger';
      return 'badge-neutral';
    }

    if (contractStatusEl) {
      const text = contract ? (contract.trangThai || '--') : '--';
      contractStatusEl.textContent = text;

      contractStatusEl.classList.remove('badge-success','badge-warning','badge-danger','badge-neutral');
      const statusClass = getStatusClass(text);
      if (statusClass) contractStatusEl.classList.add(statusClass);
    }

    if (contractTypeEl) contractTypeEl.textContent = contract ? (contract.loaiHD || '--') : '--';

    if (contractPeriodEl) {
      let baseText = '--';
      let daysLeftText = '';

      if (contract && (contract.ngayBD || contract.ngayKT)) {
        const startRaw = contract.ngayBD ? contract.ngayBD : '';
        const endRaw   = contract.ngayKT ? contract.ngayKT : '';

        const start = startRaw ? formatDateDDMMYYYY(startRaw) : '';
        const end   = endRaw   ? formatDateDDMMYYYY(endRaw)   : '';

        baseText = (start && end) ? (start + ' ‚Äì ' + end) : (start || end || '--');

        const endDateObj = toDateObject(endRaw);
        if (endDateObj) {
          const today = new Date();
          today.setHours(0,0,0,0);
          const diffMs   = endDateObj.getTime() - today.getTime();
          const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

          if (diffDays >= 0) {
            let cls = '';
            if (diffDays < 30) cls = 'days-left-red';
            else if (diffDays < 60) cls = 'days-left-yellow';
            if (cls) daysLeftText = ` <span class="${cls}">(c√≤n ${diffDays} ng√†y)</span>`;
          }
        }
      }
      const alertBadge = document.getElementById('contractAlertBadge');
      if (alertBadge) {
        alertBadge.classList.add('hidden');
        alertBadge.classList.remove('contract-alert-yellow','contract-alert-red');
      
        if (diffDays != null && diffDays >= 0) {
          if (diffDays <= 30) {
            alertBadge.textContent = `‚ö† S·∫Øp h·∫øt h·∫°n (${diffDays} ng√†y)`;
            alertBadge.classList.remove('hidden');
            alertBadge.classList.add('contract-alert-red');
          } else if (diffDays <= 60) {
            alertBadge.textContent = `‚è≥ C√≤n ${diffDays} ng√†y`;
            alertBadge.classList.remove('hidden');
            alertBadge.classList.add('contract-alert-yellow');
          }
        }
      }

      contractPeriodEl.innerHTML = baseText + daysLeftText;
    }

    if (contractRentEl) {
      contractRentEl.textContent = (contract && contract.tienThue != null) ? formatVND(contract.tienThue) : '--';
    }
    if (contractDepositEl) {
      contractDepositEl.textContent = (contract && contract.tienCoc != null) ? formatVND(contract.tienCoc) : '--';
    }
    if (contractDueDayEl) contractDueDayEl.textContent = contract ? (contract.ngayThuTien || '--') : '--';

    if (contractServices) {
      contractServices.innerHTML = '';
      if (contract) {
        ['1','2','3'].forEach(n => {
          const ma = contract['maDV' + n];
          const dg = contract['donGiaDV' + n];
          if (ma) {
            const li = document.createElement('li');
            li.textContent = ma + (dg != null ? (' ‚Äì ' + formatVND(dg)) : '');
            contractServices.appendChild(li);
          }
        });

        if (!contractServices.childElementCount) {
          const li = document.createElement('li');
          li.textContent = 'Ch∆∞a c·∫•u h√¨nh d·ªãch v·ª•.';
          contractServices.appendChild(li);
        }
      } else {
        const li = document.createElement('li');
        li.textContent = 'Kh√¥ng c√≥ h·ª£p ƒë·ªìng ƒë·ªÉ hi·ªÉn th·ªã d·ªãch v·ª•.';
        contractServices.appendChild(li);
      }
    }

    if (extendBtn) {
      if (contract && contract.coTheGiaHan) {
        extendBtn.style.display = 'inline-flex';
        extendBtn.textContent = "Gia h·∫°n h·ª£p ƒë·ªìng";

        extendBtn.classList.remove('btn-disabled','btn-warning','btn-danger','btn-accent');

        if (monthsLeft != null) {
          if (monthsLeft <= 1) extendBtn.classList.add("btn-danger");
          else if (monthsLeft <= 2) extendBtn.classList.add("btn-warning");
          else extendBtn.classList.add("btn-accent");
        }

        const statusText = contract.trangThai ? contract.trangThai.toString().toLowerCase() : '';
        if (statusText.includes('h·∫øt h·∫°n')) extendBtn.classList.add('btn-danger');
        else if (statusText.includes('s·∫Øp h·∫øt')) extendBtn.classList.add('btn-warning');
      } else {
        extendBtn.style.display = 'none';
      }
    }

    if (membersBody) {
      membersBody.innerHTML = '';
      const members = Array.isArray(data.members) ? data.members : [];

      if (!members.length) {
        membersBody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ ng∆∞·ªùi ·ªü.</td></tr>';
      } else {
        members.forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${m.hoTen || ''}</td>
            <td>${m.dienThoai || ''}</td>
            <td>${m.cccd || ''}</td>
            <td>${m.bienSo || ''}</td>
            <td>${m.ngayTamTru ? formatDateDDMMYYYY(m.ngayTamTru) : ''}</td>
            <td>${renderStatusHTML(m.trangThaiTamTru, 'tamtru')}</td>
          `;
          membersBody.appendChild(tr);
        });
      }
    }

    // 8. Danh s√°ch thi·∫øt b·ªã / t√†i s·∫£n trong ph√≤ng
    const assetsBody = $('assetsTableBody');
    if (assetsBody) {
      assetsBody.innerHTML = '';
      const assets = Array.isArray(data.assets) ? data.assets : [];

      if (!assets.length) {
        assetsBody.innerHTML = '<tr><td colspan="5" class="muted">Ch∆∞a c√≥ thi·∫øt b·ªã / t√†i s·∫£n cho ph√≤ng.</td></tr>';
      } else {
        assets.forEach((a, i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="assets-name">${a.tenThietBi || a.tenTaiSan || ''}</td>
            <td>${a.tinhTrang || ''}</td>
            <td>${a.baoHanh || ''}</td>
            <td>${a.baoTriGanNhat ? formatDateDDMMYYYY(a.baoTriGanNhat) : ''}</td>
            <td>
              <button type="button" class="btn btn-outline btn-sm" onclick="openAssetReportModal('${String(a.id||'').replace(/'/g,"&#39;")}')">B√°o h·ªèng</button>
            </td>
          `;
          assetsBody.appendChild(tr);
        });
      }
    }
  }

  // =========================
  // THANH TO√ÅN (gi·ªØ nguy√™n logic)
  // =========================
  let __selectedInvoiceIndex = 0;
  let __portalDataCache = null;

  function isInvoicePaid_(inv){
    const st = String(inv && inv.trangThai || '').toLowerCase();
    return (
      st.includes('ƒë·ªß') || st.includes('da du') ||
      st.includes('ƒë√£ thu') || st.includes('da thu') ||
      st.includes('ƒë√£ thanh to√°n') || st.includes('da thanh toan') ||
      st.includes('ho√†n t·∫•t') || st.includes('hoan tat')
    );
  }

  function renderInvoiceStatusCell_(inv, index){
    if (!inv) return '<span class="pill pill-neutral">--</span>';
    const paid = isInvoicePaid_(inv);
    if (paid) return '<span class="pill pill-success">ƒê√£ thanh to√°n</span>';
    return `<button type="button" class="btn btn-danger btn-sm" onclick="openPaymentModal(${index})">Thanh to√°n</button>`;
  }

  function renderPaymentCard(data){
    __portalDataCache = data || null;

    const historyBody = document.getElementById('paymentHistoryBody');
    if (!historyBody) return;
    historyBody.innerHTML = '';

    const invoices = (data && Array.isArray(data.invoices)) ? data.invoices : [];

    const isContractActive =
      !!(data && data.contract && String(data.contract.trangThai || '').toLowerCase().includes('hi·ªáu l·ª±c'));

    if (!isContractActive) {
      historyBody.innerHTML = `
        <tr><td colspan="4" class="muted">H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.</td></tr>`;
      renderInvoiceDetail_(null);
      return;
    }

    if (!invoices.length){
      historyBody.innerHTML = `
        <tr><td colspan="4" class="muted">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o cho ph√≤ng n√†y.</td></tr>`;
      renderInvoiceDetail_(null);
      return;
    }

    invoices.forEach((inv, i)=>{
      const tr = document.createElement('tr');
      tr.classList.toggle('row-active', i === __selectedInvoiceIndex);
      tr.innerHTML = `
        <td>${inv.namThang || ''}</td>
        <td>${formatVND(inv.tongPhaiThu)}</td>
        <td>${renderInvoiceStatusCell_(inv, i)}</td>
        <td>
          <button type="button" class="btn btn-outline btn-sm" onclick="selectInvoice(${i})">
            Chi ti·∫øt
          </button>
        </td>
      `;
      historyBody.appendChild(tr);
    });

    if (__selectedInvoiceIndex >= invoices.length) __selectedInvoiceIndex = 0;
    renderInvoiceDetail_(invoices[__selectedInvoiceIndex]);
  }

  function selectInvoice(index){
    __selectedInvoiceIndex = Number(index) || 0;

    const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
      ? __portalDataCache.invoices : [];

    const rows = document.querySelectorAll('#paymentHistoryBody tr');
    rows.forEach((r, i)=> r.classList.toggle('row-active', i === __selectedInvoiceIndex));

    const inv = invoices[__selectedInvoiceIndex] || null;
    renderInvoiceDetail_(inv);
    setActiveTab('pay', 'detail');
  }

  function renderInvoiceDetail_(inv){
    const kyEl = document.getElementById('invKy');
    const pillEl = document.getElementById('invStatusPill');
    const payBtn = document.getElementById('invPayBtn');

    if (!inv){
      if (kyEl) kyEl.textContent = 'K·ª≥: --';
      if (pillEl){ pillEl.className = 'pill pill-neutral'; pillEl.textContent = '--'; }
      if (payBtn) payBtn.style.display = 'none';

      ['invNgayTinh','invTienPhong','invTongDV','invPhatSinh','invGiamTru','invThieuTruoc','invPhaiThu','invServiceTotal'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.textContent = '--';
      });
      const dvBody = document.getElementById('invoiceServiceBody');
      if (dvBody) dvBody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu d·ªãch v·ª•.</td></tr>';

      updateBankAndQr_(null);
      return;
    }

    if (kyEl) kyEl.textContent = 'K·ª≥: ' + (inv.namThang || '--');

    const paid = isInvoicePaid_(inv);
    if (pillEl){
      pillEl.className = paid ? 'pill pill-success' : 'pill pill-danger';
      pillEl.textContent = paid ? 'ƒê√£ thanh to√°n' : 'C√≤n thi·∫øu';
    }
    if (payBtn) payBtn.style.display = paid ? 'none' : 'inline-flex';

    const c = inv.chiTiet || {};
    document.getElementById('invNgayTinh').textContent =
      (c.ngayTinhHD != null && c.ngayTinhHD !== '') ? (parseInt(c.ngayTinhHD,10) + ' ng√†y') : '--';
    document.getElementById('invTienPhong').textContent  = formatVND(c.tienPhongTT);
    document.getElementById('invTongDV').textContent     = formatVND(
      (c.tongDichVu != null && c.tongDichVu !== '') ? c.tongDichVu : (inv.tongDN_DV || 0)
    );
    document.getElementById('invPhatSinh').textContent   = formatVND(c.phatSinhKhac);
    document.getElementById('invGiamTru').textContent    = formatVND(c.giamTruKhac);
    document.getElementById('invThieuTruoc').textContent = formatVND(c.thieuKyTruoc);
    document.getElementById('invPhaiThu').textContent    = formatVND(c.phaiThu);

    const dvBody = document.getElementById('invoiceServiceBody');
    const dvTotalEl = document.getElementById('invServiceTotal');

    if (dvBody){
      dvBody.innerHTML = '';

      const services = Array.isArray(inv.services) ? inv.services : [];
      const serviceMap =
        (__portalDataCache && (__portalDataCache.serviceMap || __portalDataCache.servicesMap || __portalDataCache.serviceMetaMap))
          ? (__portalDataCache.serviceMap || __portalDataCache.servicesMap || __portalDataCache.serviceMetaMap)
          : {};

      let total = 0;

      const filtered = services.filter(s=>{
        const maDV = String(s.maDV || s.tenDichVu || '').trim();
        const thanhTien = Number(s.thanhTien || 0);
        if (!maDV) return false;
        if (thanhTien === 0) return false;
        return true;
      });

      if (!filtered.length){
        dvBody.innerHTML = '<tr><td colspan="6" class="muted">Kh√¥ng c√≥ d·ªãch v·ª• ph√°t sinh.</td></tr>';
        if (dvTotalEl) dvTotalEl.textContent = formatVND(0);
      } else {
        filtered.forEach(s=>{
          const thanhTien = Number(s.thanhTien || 0) || 0;
          total += thanhTien;

          const idDV = String(s.idDV || '').trim();
          const maDV = String(s.maDV || s.tenDichVu || '').trim();

          const metaById = idDV && serviceMap[idDV] ? serviceMap[idDV] : null;
          const metaByMa = !metaById && maDV && serviceMap[maDV] ? serviceMap[maDV] : null;
          const meta = metaById || metaByMa || {};
          const loai = String(meta.loai || meta['Lo·∫°i'] || meta.type || '').trim().toLowerCase();

          const isTheoSoLuong = loai === 'theo s·ªë l∆∞·ª£ng' || loai === 'theo so luong';

          const soDau  = (s.soDau == null ? '' : s.soDau);
          const soCuoi = (s.soCuoi == null ? '' : s.soCuoi);
          const soLuong = (s.soLuong == null ? '' : s.soLuong);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="dv-name">${maDV}</td>
            <td>${isTheoSoLuong ? '-' : soDau}</td>
            <td>${isTheoSoLuong ? '-' : soCuoi}</td>
            <td>${soLuong}</td>
            <td class="dv-money">${formatVND(s.donGia)}</td>
            <td class="dv-money">${formatVND(thanhTien)}</td>
          `;
          dvBody.appendChild(tr);
        });

        if (dvTotalEl) dvTotalEl.textContent = formatVND(total);
      }
    }

    // ‚úÖ BANK + QR theo h√≥a ƒë∆°n ƒëang ch·ªçn
    updateBankAndQr_(inv);
  }

  // ‚úÖ CLEAN: b·ªè fetch ownerBank ri√™ng, d√πng bankInfo ƒë√£ ƒë∆∞·ª£c Apps Script b∆°m v√†o invoice
  function updateBankAndQr_(inv){
    const bankInfoEl = document.getElementById('invBankInfo');
    const qrContainer = document.getElementById('qrContainer');

    // BANK ∆∞u ti√™n t·ª´ inv.chiTiet.bankInfo
    const bankInfo =
      (inv && inv.chiTiet && inv.chiTiet.bankInfo) ? inv.chiTiet.bankInfo :
      null;

    if (bankInfoEl){
      const bankText = [
        bankInfo?.soTaiKhoan ? ('S·ªë t√†i kho·∫£n: ' + bankInfo.soTaiKhoan) : '',
        bankInfo?.chuTaiKhoan ? ('Ch·ªß t√†i kho·∫£n: ' + bankInfo.chuTaiKhoan) : '',
        bankInfo?.nganHang ? ('Ng√¢n h√†ng: ' + bankInfo.nganHang) : '',
        bankInfo?.chiNhanh ? ('CN ng√¢n h√†ng: ' + bankInfo.chiNhanh) : ''
      ].filter(Boolean).join('<br>');

      bankInfoEl.innerHTML = bankText || '--';
    }

    // QR gi·ªØ nguy√™n
    if (!qrContainer) return;
    qrContainer.innerHTML = '';

    const c = (inv && inv.chiTiet) ? inv.chiTiet : {};
    const qr =
      (c && (c.qrCode || c.qr || c.qr_code || c["QR Code"])) ||
      (inv && (inv.qrCode || inv.qr || inv.qr_code || inv["QR Code"])) ||
      '';

    if (qr){
      const img = document.createElement('img');
      img.src = qr;
      img.alt = 'QR thanh to√°n';
      img.style.maxWidth = '160px';
      img.style.marginTop = '4px';
      qrContainer.appendChild(img);
    } else {
      qrContainer.textContent = 'Ch∆∞a c√≥ QR Code.';
    }
  }

  function renderMaintenance(data){
    const tbody = document.getElementById('maintenanceBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const list = (data && Array.isArray(data.maintenance)) ? data.maintenance : [];
    if (!list.length){
      tbody.innerHTML = '<tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng.</td></tr>';
      return;
    }
    list.forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.tenTaiSan || ''}</td>
        <td>${m.loaiCongViec || ''}</td>
        <td>${m.ngayDuKien ? formatDateDDMMYYYY(m.ngayDuKien) : ''}</td>
        <td>${m.ngayThucHien ? formatDateDDMMYYYY(m.ngayThucHien) : ''}</td>
        <td>${m.trangThai || ''}</td>
        <td>${m.ghiChu || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderMessages(data){
    const tbody = document.getElementById('messageBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const msgs = (data && Array.isArray(data.messages)) ? data.messages : [];
    if (!msgs.length){
      tbody.innerHTML = '<tr><td colspan="4" class="muted">Ch∆∞a c√≥ b√°o h·ªèng / t·∫°m tr√∫ n√†o.</td></tr>';
      return;
    }
    msgs.forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.type || m.loai || ''}</td>
        <td>${m.createdAt || m.ngay || ''}</td>
        <td>${m.content || m.noiDung || ''}</td>
        <td>${renderStatusHTML(m.status || m.trangThai || '', 'message')}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openMaintenanceForm(){ alert('Form b√°o h·ªèng: b·∫°n c√≥ th·ªÉ d√πng tenantMaintenance API nh∆∞ ƒë√£ c·∫•u h√¨nh ·ªü Apps Script.'); }
  function openAssetReport(assetId, assetName){
      alert('B√°o h·ªèng thi·∫øt b·ªã: ' + (assetName || '') + '\n(ID: ' + (assetId || '-') + ')');
    }

    function openTempStayForm(){ alert('Form ƒëƒÉng k√Ω t·∫°m tr√∫: d√πng tenantTempStay API.'); }

  // =========================
  // POPUP THANH TO√ÅN (gi·ªØ nguy√™n)
  // =========================
  function openPaymentModal(index){
    if (index !== undefined && index !== null) __selectedInvoiceIndex = Number(index) || 0;

    const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
      ? __portalDataCache.invoices : [];
    const inv = invoices[__selectedInvoiceIndex] || null;

    const modal = document.getElementById('paymentModal');
    if (!modal) return;

    const meta = document.getElementById('paymentModalMeta');
    if (meta) meta.textContent = 'H√≥a ƒë∆°n: ' + (inv ? (inv.namThang || '--') : '--');

    const fileInput = document.getElementById('paymentProofFile');
    const noteInput = document.getElementById('paymentNote');
    const preview = document.getElementById('paymentPreview');

    if (fileInput) fileInput.value = '';
    if (noteInput) noteInput.value = '';
    if (preview) preview.textContent = 'Ch∆∞a ch·ªçn ·∫£nh.';

    modal.classList.remove('hidden');
  }

  function closePaymentModal(){
    const modal = document.getElementById('paymentModal');
    if (modal) modal.classList.add('hidden');
  }

  document.addEventListener('change', (e)=>{
    if (e.target && e.target.id === 'paymentProofFile'){
      const file = e.target.files && e.target.files[0];
      const preview = document.getElementById('paymentPreview');
      if (!preview) return;

      if (!file){
        preview.textContent = 'Ch∆∞a ch·ªçn ·∫£nh.';
        preview.classList.add('muted');
        return;
      }

      preview.classList.remove('muted');
      preview.innerHTML = '';
      const img = document.createElement('img');
      img.alt = 'Phi·∫øu chuy·ªÉn kho·∫£n';
      img.className = 'payment-proof-img';
      img.src = URL.createObjectURL(file);
      preview.appendChild(img);
    }
  });

  async function submitPaymentProof(){
    const invoices = (__portalDataCache && Array.isArray(__portalDataCache.invoices))
      ? __portalDataCache.invoices : [];
    const inv = invoices[__selectedInvoiceIndex] || null;

    const fileInput = document.getElementById('paymentProofFile');
    const noteInput = document.getElementById('paymentNote');

    const file = fileInput && fileInput.files ? fileInput.files[0] : null;
    const note = noteInput ? (noteInput.value || '') : '';

    let base64 = '';
    if (file){
      base64 = await new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ''));
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    try{
      const body = new URLSearchParams({
        action: 'tenantPaymentProof',
        roomCode: (__portalDataCache && __portalDataCache.roomCode) ? __portalDataCache.roomCode : '',
        invoiceId: inv && (inv.id || inv.invoiceId || inv.maHoaDon) ? (inv.id || inv.invoiceId || inv.maHoaDon) : '',
        namThang: inv && inv.namThang ? inv.namThang : '',
        note: note,
        proofBase64: base64
      });

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body
      });

      let out = null;
      try { out = await res.json(); } catch(e){}

      if (out && out.success){
        alert('ƒê√£ g·ª≠i x√°c nh·∫≠n thanh to√°n cho ch·ªß nh√†.');
        closePaymentModal();

        const tenant = JSON.parse(localStorage.getItem(TENANT_STORAGE_KEY) || '{}');
        if (tenant && tenant.maPhong){
          fetchData(tenant.maPhong, tenant.identity || '');
        }
      } else {
        alert((out && out.message) || 'ƒê√£ ghi nh·∫≠n. N·∫øu ch∆∞a th·∫•y c·∫≠p nh·∫≠t, ch·ªß nh√† s·∫Ω ki·ªÉm tra v√† x√°c nh·∫≠n sau.');
        closePaymentModal();
      }
    } catch(err){
      console.error('submitPaymentProof error:', err);
      alert('Kh√¥ng g·ª≠i ƒë∆∞·ª£c x√°c nh·∫≠n (l·ªói k·∫øt n·ªëi). Vui l√≤ng th·ª≠ l·∫°i.');
    }
  }

  function downloadInvoicePdf(){ window.print(); }

  async function fetchData(roomCode, identity){
    const note = document.getElementById('portalStatusNote');
    if (note) note.textContent = 'ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Google Sheet (Apps Script)...';

    renderInfoCard(null);

    try{
      const body = new URLSearchParams({
        action:   'tenantPortal',
        roomCode: roomCode,
        identity: identity || ''
      });

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body
      });

      const data = await res.json();

      if (!data || !data.success){
        if (note) note.textContent = (data && data.message) || 'Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu portal.';
        return;
      }

      if (note) note.textContent = 'D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ h·ªá th·ªëng (Google Sheet).';

      renderInfoCard(data);
      renderPaymentCard(data);
      renderMaintenance(data);
      renderMessages(data);

      // ‚úÖ n·∫øu ho√° ƒë∆°n ƒëang ch·ªçn c√≥ bankInfo th√¨ hi·ªÉn th·ªã lu√¥n (tr√°nh l√∫c ch∆∞a click tab detail)
      const invoices = Array.isArray(data.invoices) ? data.invoices : [];
      if (invoices.length) updateBankAndQr_(invoices[__selectedInvoiceIndex] || invoices[0]);

    } catch(err){
      console.error('fetchTenantPortalData error:',err);
      const noteEl = document.getElementById('portalStatusNote');
      if (noteEl) noteEl.textContent = 'L·ªói k·∫øt n·ªëi t·ªõi Apps Script, vui l√≤ng th·ª≠ l·∫°i.';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.tab-btn.tab-info').forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveTab('info', btn.dataset.tab));
    });
    document.querySelectorAll('.tab-btn.tab-pay').forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveTab('pay', btn.dataset.tab));
    });

    let tenant = null;
    try {
      const saved = localStorage.getItem(TENANT_STORAGE_KEY);
      if (saved) tenant = JSON.parse(saved);
    } catch(e){}

    if (!tenant || !tenant.maPhong){
      window.location.href = 'tenant.html';
      return;
    }

    // ‚úÖ g·ªçi ƒë√∫ng h√†m (ƒë√£ define)
    fetchData(tenant.maPhong, tenant.identity || '');
  });
</script>

</body>
</html>











