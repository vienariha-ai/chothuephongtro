<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Portal t√†i kho·∫£n ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS chung -->
  <link rel="stylesheet" href="yt-home-common.css" />

  <!-- CSS layout 2 c·ªôt + tab -->
  <style>
    body.portal-body .portal-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 12px;
      margin-top: 14px;
    }

    .portal-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Tab */
    .tab-nav {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(148,163,184,0.5);
    }

    .tab-btn {
      padding: 6px 14px;
      font-size: 0.8rem;
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: rgba(229,231,235,0.94);
      white-space: nowrap;
      transition: 0.18s;
    }

    .tab-btn.active {
      background: #38bdf8;
      border-color: #38bdf8;
      color: #0b1120;
      font-weight: 600;
    }

    .tab-content {
      margin-top: 10px;
      display: none;
    }
    .tab-content.active { display: block; }

    /* M·ªôt s·ªë table nh·ªè */
    .table-small th, .table-small td {
      padding: 4px 6px !important;
      font-size: 0.8rem;
    }

    .badge-soft {
      display: inline-block;
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      margin-left: 4px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.7);
    }
    .status-pill.ok { border-color:#22c55e; color:#bbf7d0; }
    .status-pill.warn { border-color:#eab308; color:#fef9c3; }
    .status-pill.expired { border-color:#f97316; color:#fed7aa; }

    @media (max-width: 768px) {
      body.portal-body .portal-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="portal-body">
  <div class="container">
    <!-- HEADER -->
    <header class="header">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn-outline">Trang xem ph√≤ng</a>
        <button type="button" class="btn-outline" onclick="logoutTenant()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">Xin ch√†o, c∆∞ d√¢n YT Home üè°</div>
      <div class="page-subtitle">
        Portal n·ªôi b·ªô t√†i kho·∫£n ph√≤ng. D·ªØ li·ªáu l·∫•y t·ª´ Google Sheet qua Apps Script.
      </div>
      <div id="portalStatusNote" class="portal-status">ƒêang t·∫£i d·ªØ li·ªáu ph√≤ng...</div>

      <!-- ===== LAYOUT 2 C·ªòT ===== -->
      <div class="portal-grid">

        <!-- ================= C·ªòT TR√ÅI ================= -->
        <div class="portal-card">
          <!-- CARD 1: TH√îNG TIN PH√íNG -->
          <section class="card">
            <div class="card-title">
              Th√¥ng tin ph√≤ng
              <span id="roomBadge" class="badge-soft">Ph√≤ng: --</span>
            </div>

            <div class="tab-nav">
              <button class="tab-btn active" data-tab="info-owner">Ch·ªß ph√≤ng</button>
              <button class="tab-btn" data-tab="info-contract">H·ª£p ƒë·ªìng</button>
              <button class="tab-btn" data-tab="info-members">Ng∆∞·ªùi &amp; xe</button>
            </div>

            <!-- TAB: CH·ª¶ PH√íNG -->
            <div class="tab-content active" id="info-owner">
              <div class="info-row">
                <span class="info-label">T√™n ch·ªß ph√≤ng:</span>
                <span class="info-value" id="ownerName">--</span>
              </div>
              <div class="info-row">
                <span class="info-label">S·ªë CCCD:</span>
                <span class="info-value" id="ownerCccd">--</span>
              </div>
              <div class="info-row">
                <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                <span class="info-value" id="ownerPhone">--</span>
              </div>
              <div class="small-note">
                Th√¥ng tin l·∫•y t·ª´ sheet <strong>H·ª£p ƒë·ªìng</strong> (c·ªôt ‚ÄúT√™n kh√°ch‚Äù) 
                v√† sheet <strong>Kh√°ch thu√™</strong> v·ªõi h√†ng c√≥ <code>Tr·∫°ng th√°i = "ƒêang ·ªü"</code>,
                <code>Lo·∫°i = "Ch·ªß ph√≤ng"</code>.
              </div>
            </div>

            <!-- TAB: H·ª¢P ƒê·ªíNG -->
            <div class="tab-content" id="info-contract">
              <div class="info-row">
                <span class="info-label">Tr·∫°ng th√°i:</span>
                <span class="info-value" id="contractStatus">--</span>
              </div>
              <div class="info-row">
                <span class="info-label">Lo·∫°i Hƒê:</span>
                <span class="info-value" id="contractType">--</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ng√†y Bƒê - KT:</span>
                <span class="info-value" id="contractPeriod">--</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ti·ªÅn thu√™:</span>
                <span class="info-value" id="contractRent">--</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ti·ªÅn c·ªçc:</span>
                <span class="info-value" id="contractDeposit">--</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ng√†y thu ti·ªÅn:</span>
                <span class="info-value" id="contractPayDate">--</span>
              </div>

              <hr style="margin:8px 0;border-color:rgba(55,65,81,0.8);" />

              <div class="section-title" style="font-size:0.85rem;margin-bottom:4px;">D·ªãch v·ª• theo h·ª£p ƒë·ªìng</div>
              <table class="table-like table-small">
                <thead>
                  <tr>
                    <th>D·ªãch v·ª•</th>
                    <th>M√£</th>
                    <th>ƒê∆°n gi√°</th>
                  </tr>
                </thead>
                <tbody id="contractServicesBody">
                  <tr><td colspan="3" class="muted">Ch∆∞a c·∫•u h√¨nh DV.</td></tr>
                </tbody>
              </table>

              <div style="margin-top:8px;">
                <button id="extendContractBtn" class="btn" style="display:none;width:auto;">
                  K√Ω ti·∫øp h·ª£p ƒë·ªìng
                </button>
                <span id="extendHint" class="small-note">
                  N√∫t ‚ÄúK√Ω ti·∫øp h·ª£p ƒë·ªìng‚Äù s·∫Ω xu·∫•t hi·ªán n·∫øu c√≤n ‚â§ 30 ng√†y ƒë·∫øn Ng√†y KT.
                </span>
              </div>
            </div>

            <!-- TAB: NG∆Ø·ªúI & XE -->
            <div class="tab-content" id="info-members">
              <table class="table-like table-small">
                <thead>
                  <tr>
                    <th>H·ªç t√™n</th>
                    <th>CCCD</th>
                    <th>ƒêi·ªán tho·∫°i</th>
                    <th>Bi·ªÉn s·ªë</th>
                    <th>Ng√†y t·∫°m tr√∫</th>
                    <th>TT t·∫°m tr√∫</th>
                  </tr>
                </thead>
                <tbody id="memberTableBody">
                  <tr><td colspan="6" class="muted">ƒêang t·∫£i danh s√°ch c∆∞ d√¢n...</td></tr>
                </tbody>
              </table>
              <div class="small-note">
                D·ªØ li·ªáu t·ª´ sheet <strong>Kh√°ch thu√™</strong> (H·ªç v√† t√™n, S·ªë ƒëi·ªán tho·∫°i, S·ªë CCCD, Bi·ªÉn s·ªë, Ng√†y t·∫°m tr√∫).  
                N·∫øu kh√¥ng c√≥ Ng√†y t·∫°m tr√∫ ‚Üí tr·∫°ng th√°i t·∫°m tr√∫ hi·ªÉn th·ªã ‚ÄúCh∆∞a ƒëƒÉng k√Ω‚Äù.
              </div>
            </div>
          </section>

          <!-- CARD 2: THANH TO√ÅN -->
          <section class="card">
            <div class="card-title">Thanh to√°n</div>

            <div class="tab-nav">
              <button class="tab-btn active" data-tab="pay-history">L·ªãch s·ª≠ thanh to√°n</button>
              <button class="tab-btn" data-tab="pay-detail">Chi ti·∫øt h√≥a ƒë∆°n</button>
            </div>

            <!-- TAB: L·ªäCH S·ª¨ THANH TO√ÅN -->
            <div class="tab-content active" id="pay-history">
              <table class="table-like table-small">
                <thead>
                  <tr>
                    <th style="width:80px;">K·ª≥</th>
                    <th>T·ªïng ƒêN + DV</th>
                    <th>T·ªïng ph·∫£i thu</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th style="width:90px;"></th>
                  </tr>
                </thead>
                <tbody id="paymentHistoryBody">
                  <tr><td colspan="5" class="muted">ƒêang t·∫£i l·ªãch s·ª≠ thanh to√°n...</td></tr>
                </tbody>
              </table>
              <div class="small-note">
                Ch·ªâ hi·ªÉn th·ªã n·∫øu H·ª£p ƒë·ªìng c√≤n hi·ªáu l·ª±c.  
                M·ªói d√≤ng t∆∞∆°ng ·ª©ng m·ªôt k·ª≥ <strong>NƒÉm th√°ng</strong> trong sheet <strong>H√≥a ƒë∆°n</strong>.
              </div>
            </div>

            <!-- TAB: CHI TI·∫æT H√ìA ƒê∆†N -->
            <div class="tab-content" id="pay-detail">
              <div id="invoiceSummary">
                <div class="info-row">
                  <span class="info-label">Ng√†y t√≠nh Hƒê:</span>
                  <span class="info-value" id="invNgayTinh">--</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Ti·ªÅn ph√≤ng TT:</span>
                  <span class="info-value" id="invTienPhongTT">--</span>
                </div>
                <div class="info-row">
                  <span class="info-label">T·ªïng DV (ƒêN + DV):</span>
                  <span class="info-value" id="invTongDv">--</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Ph√°t sinh kh√°c:</span>
                  <span class="info-value" id="invPhatSinh">--</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Gi·∫£m tr·ª´ kh√°c:</span>
                  <span class="info-value" id="invGiamTru">--</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Thi·∫øu k·ª≥ tr∆∞·ªõc:</span>
                  <span class="info-value" id="invThieuTruoc">--</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Ph·∫£i thu k·ª≥ n√†y:</span>
                  <span class="info-value" id="invPhaiThu">--</span>
                </div>
              </div>

              <hr style="margin:8px 0;border-color:rgba(55,65,81,0.8);" />

              <div class="section-title" style="font-size:0.85rem;margin-bottom:4px;">Chi ti·∫øt d·ªãch v·ª•</div>
              <table class="table-like table-small">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>D·ªãch v·ª•</th>
                    <th>S·ªë ƒë·∫ßu</th>
                    <th>S·ªë cu·ªëi</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>Th√†nh ti·ªÅn</th>
                  </tr>
                </thead>
                <tbody id="serviceTableBody">
                  <tr><td colspan="7" class="muted">Ch∆∞a c√≥ chi ti·∫øt h√≥a ƒë∆°n.</td></tr>
                </tbody>
              </table>

              <div class="section-title" style="font-size:0.85rem;margin:8px 0 4px;">Th√¥ng tin chuy·ªÉn kho·∫£n</div>
              <div id="bankInfoBlock" class="small-note">
                <div>S·ªë TK: <strong id="bankSoTk">--</strong></div>
                <div>Ch·ªß TK: <strong id="bankChuTk">--</strong></div>
                <div>Ng√¢n h√†ng: <strong id="bankNganHang">--</strong></div>
                <div>Chi nh√°nh: <strong id="bankChiNhanh">--</strong></div>
                <div id="bankQrWrapper" style="margin-top:6px;display:none;">
                  QR Code:
                  <img id="bankQrImg" src="" alt="QR Code" style="max-width:130px;margin-top:4px;border-radius:6px;border:1px solid rgba(148,163,184,0.5);" />
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- ================= C·ªòT PH·∫¢I ================= -->
        <div class="portal-card">
          <!-- CARD 3: B·∫¢O TR√å -->
          <section class="card">
            <div class="card-title">B·∫£o tr√¨ &amp; b·∫£o d∆∞·ª°ng</div>
            <button class="btn" style="width:auto;margin-bottom:8px;" onclick="onReportIssue()">
              üì¢ B√°o h·ªèng
            </button>

            <table class="table-like table-small">
              <thead>
                <tr>
                  <th>Ng√†y d·ª± ki·∫øn</th>
                  <th>Ng√†y th·ª±c hi·ªán</th>
                  <th>T√™n t√†i s·∫£n</th>
                  <th>Lo·∫°i CV</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Ghi ch√∫</th>
                </tr>
              </thead>
              <tbody id="maintenanceTableBody">
                <tr><td colspan="6" class="muted">ƒêang t·∫£i l·ªãch b·∫£o tr√¨...</td></tr>
              </tbody>
            </table>
            <div class="small-note">
              Map t·ª´ sheet <strong>L·ªãch b·∫£o tr√¨</strong>: Ng√†y d·ª± ki·∫øn, Ng√†y th·ª±c hi·ªán, T√™n t√†i s·∫£n,
              Lo·∫°i c√¥ng vi·ªác, Tr·∫°ng th√°i, Ghi ch√∫.
            </div>
          </section>

          <!-- CARD 4: TIN NH·∫ÆN -->
          <section class="card">
            <div class="card-title">Tin nh·∫Øn &amp; th√¥ng b√°o</div>
            <ul id="messagesList" class="list">
              <li class="muted">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</li>
            </ul>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script>
    const TENANT_STORAGE_KEY = "ytHomeTenant";
    const API_URL = "https://script.google.com/macros/s/AKfycbwyqskjnUjwkn95TqRmcFjLem2eSMfKBuh23PHDD0QcL0gCwEnqNLYxd6vmi7xqDzUoow/exec";

    function logoutTenant() {
      try { localStorage.removeItem(TENANT_STORAGE_KEY); } catch (e) {}
      window.location.href = "tenant.html";
    }

    function onReportIssue() {
      alert("Ch·ª©c nƒÉng b√°o h·ªèng: b·∫°n c√≥ th·ªÉ l√†m form popup + ghi v√†o sheet L·ªãch b·∫£o tr√¨.\nHi·ªán t·∫°i ch·ªâ l√† n√∫t minh h·ªça.");
    }

    function maskIdentity(identity) {
      if (!identity) return "--";
      const s = String(identity);
      if (s.length <= 4) return "***" + s;
      return "**** " + s.slice(-4);
    }

    function formatVND(amount) {
      if (amount === null || amount === undefined || amount === "") return "--";
      const num = Number(String(amount).replace(/[^\d.-]/g, ""));
      if (isNaN(num)) return String(amount);
      return num.toLocaleString("vi-VN") + " ƒë";
    }

    // ====== SET OWNER INFO ======
    function setOwnerInfo(owner, tenant) {
      const nameEl  = document.getElementById("ownerName");
      const cccdEl  = document.getElementById("ownerCccd");
      const phoneEl = document.getElementById("ownerPhone");

      const name  = owner?.name || owner?.tenKhach || owner?.hoTen || tenant?.name || "Ch·ªß ph√≤ng";
      const cccd  = owner?.cccd || owner?.soCccd || tenant?.identity || "";
      const phone = owner?.phone || owner?.soDienThoai || owner?.dienThoai || "--";

      if (nameEl) nameEl.textContent  = name;
      if (cccdEl) cccdEl.textContent  = cccd ? maskIdentity(cccd) : "--";
      if (phoneEl) phoneEl.textContent = phone;
    }

    // ====== CONTRACT SUMMARY & EXTEND BUTTON ======
    function setContractSummary(contract) {
      const statusEl  = document.getElementById("contractStatus");
      const typeEl    = document.getElementById("contractType");
      const periodEl  = document.getElementById("contractPeriod");
      const rentEl    = document.getElementById("contractRent");
      const depositEl = document.getElementById("contractDeposit");
      const payDateEl = document.getElementById("contractPayDate");
      const svBody    = document.getElementById("contractServicesBody");
      const extendBtn = document.getElementById("extendContractBtn");

      if (!contract) {
        if (statusEl)  statusEl.textContent  = "Ch∆∞a c√≥ h·ª£p ƒë·ªìng trong h·ªá th·ªëng";
        if (typeEl)    typeEl.textContent    = "--";
        if (periodEl)  periodEl.textContent  = "--";
        if (rentEl)    rentEl.textContent    = "--";
        if (depositEl) depositEl.textContent = "--";
        if (payDateEl) payDateEl.textContent = "--";
        if (svBody) svBody.innerHTML = `<tr><td colspan="3" class="muted">Ch∆∞a c·∫•u h√¨nh DV.</td></tr>`;
        if (extendBtn) extendBtn.style.display = "none";
        return;
      }

      const status = contract.trangThai || contract.status || "ƒêang hi·ªáu l·ª±c";
      const type   = contract.loaiHD || contract.loaiHopDong || contract.type || "--";
      const start  = contract.ngayBD || contract.ngayBatDau || contract.startDate || "";
      const end    = contract.ngayKT || contract.ngayKetThuc || contract.endDate || "";

      if (statusEl)  statusEl.textContent  = status;
      if (typeEl)    typeEl.textContent    = type;
      if (periodEl)  periodEl.textContent  = start && end ? `${start} ‚Äì ${end}` : (start || end || "--");
      if (rentEl)    rentEl.textContent    = formatVND(contract.tienThue || contract.rentAmount);
      if (depositEl) depositEl.textContent = formatVND(contract.tienCoc || contract.deposit);
      if (payDateEl) payDateEl.textContent = contract.ngayThuTien || contract.paymentDate || "--";

      if (svBody) {
        const rows = [];
        const svc = [
          { label: "DV1", code: contract.maDV1 || contract.maDv1, price: contract.donGiaDV1 || contract.donGiaDv1 },
          { label: "DV2", code: contract.maDV2 || contract.maDv2, price: contract.donGiaDV2 || contract.donGiaDv2 },
          { label: "DV3", code: contract.maDV3 || contract.maDv3, price: contract.donGiaDV3 || contract.donGiaDv3 }
        ];
        svc.forEach(s => {
          if (s.code) {
            rows.push(`
              <tr>
                <td>${s.label}</td>
                <td>${s.code}</td>
                <td>${formatVND(s.price)}</td>
              </tr>
            `);
          }
        });
        svBody.innerHTML = rows.length
          ? rows.join("")
          : `<tr><td colspan="3" class="muted">Ch∆∞a c·∫•u h√¨nh DV.</td></tr>`;
      }

      // Hi·ªán n√∫t K√Ω ti·∫øp n·∫øu c√≤n <= 30 ng√†y ƒë·∫øn Ng√†y KT
      if (extendBtn && end) {
        const parts = end.split(/[\/\-]/); // dd/MM/yyyy ho·∫∑c yyyy-MM-dd
        let endDate = null;
        if (parts.length === 3) {
          if (parts[2].length === 4) {
            // dd/MM/yyyy
            endDate = new Date(+parts[2], +parts[1]-1, +parts[0]);
          } else {
            // yyyy-MM-dd
            endDate = new Date(+parts[0], +parts[1]-1, +parts[2]);
          }
        }
        if (endDate) {
          const today = new Date();
          const diffMs = endDate - today;
          const diffDays = diffMs / (1000*60*60*24);
          if (diffDays <= 30 && diffDays >= -5) {
            extendBtn.style.display = "inline-flex";
            extendBtn.onclick = () => {
              alert("N√∫t 'K√Ω ti·∫øp h·ª£p ƒë·ªìng' ‚Äì b·∫°n c√≥ th·ªÉ m·ªü form chi ti·∫øt ho·∫∑c chuy·ªÉn sang link k√Ω Hƒê m·ªõi.");
            };
          } else {
            extendBtn.style.display = "none";
          }
        }
      }
    }

    // ====== NG∆Ø·ªúI & XE ======
    function setMembersTable(members) {
      const body = document.getElementById("memberTableBody");
      if (!body) return;
      body.innerHTML = "";

      if (!Array.isArray(members) || !members.length) {
        body.innerHTML = `<tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu c∆∞ d√¢n cho ph√≤ng n√†y.</td></tr>`;
        return;
      }

      members.forEach((m, idx) => {
        const name  = m.hoTen || m.tenKhach || m.name || "--";
        const cccd  = m.soCccd || m.cccd || "";
        const phone = m.soDienThoai || m.dienThoai || m.phone || "--";
        const plate = m.bienSo || m.bienSoXe || "--";
        const ngayTamTru = m.ngayTamTru || m.ngayDangKyTamTru || "";
        let ttTamTru = m.trangThaiTamTru || "";

        if (!ngayTamTru) {
          ttTamTru = "Ch∆∞a ƒëƒÉng k√Ω";
        } else if (!ttTamTru) {
          ttTamTru = "ƒê√£ ƒëƒÉng k√Ω";
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>${cccd ? maskIdentity(cccd) : "--"}</td>
          <td>${phone}</td>
          <td>${plate}</td>
          <td>${ngayTamTru || "--"}</td>
          <td>${ttTamTru}</td>
        `;
        body.appendChild(tr);
      });
    }

    // ====== L·ªäCH S·ª¨ THANH TO√ÅN ======
    function setPaymentHistory(payments, contractStatus) {
      const body = document.getElementById("paymentHistoryBody");
      if (!body) return;
      body.innerHTML = "";

      const isActive = contractStatus && /ƒëang/i.test(contractStatus);
      if (!isActive) {
        body.innerHTML = `<tr><td colspan="5" class="muted">H·ª£p ƒë·ªìng kh√¥ng c√≤n hi·ªáu l·ª±c, kh√¥ng c√≤n k·ª≥ thanh to√°n m·ªõi.</td></tr>`;
        return;
      }

      if (!Array.isArray(payments) || !payments.length) {
        body.innerHTML = `<tr><td colspan="5" class="muted">Ch∆∞a c√≥ k·ª≥ thanh to√°n n√†o.</td></tr>`;
        return;
      }

      payments.forEach(p => {
        const period  = p.namThang || p.period || p.ky || "--";
        const tongDv  = formatVND(p.tongDienNuocDv || p.tongDichVu || p.totalService);
        const tong    = formatVND(p.phaiThu || p.tongTien || p.total);
        const status  = p.trangThai || p.status || "Ch∆∞a ƒë√≥ng";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${period}</td>
          <td>${tongDv}</td>
          <td>${tong}</td>
          <td>${status}</td>
          <td>
            <button class="room-btn-secondary" style="font-size:0.72rem;padding:3px 8px;"
                    onclick="onSendInvoice('${encodeURIComponent(period)}')">
              G·ª≠i Hƒê
            </button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    function onSendInvoice(period) {
      const real = decodeURIComponent(period || "");
      alert("N√∫t 'G·ª≠i h√≥a ƒë∆°n thanh to√°n' ‚Äì b·∫°n c√≥ th·ªÉ d√πng Apps Script g·ª≠i email/Zalo.\nK·ª≥: " + real);
    }

    // ====== CHI TI·∫æT H√ìA ƒê∆†N ======
    function setInvoiceDetail(detail) {
      if (!detail) detail = {};

      const ngayTinh   = detail.ngayTinhHD || detail.ngayTinh || "--";
      const tienPhong  = formatVND(detail.tienPhongTT || detail.tienPhongThanhToan);
      const tongDv     = formatVND(detail.tongDichVu || detail.tongDv || detail.tongDienNuocDv);
      const phatSinh   = formatVND(detail.phatSinhKhac || detail.phatSinh);
      const giamTru    = formatVND(detail.giamTruKhac || detail.giamTru);
      const thieuTruoc = formatVND(detail.thieuKyTruoc || detail.conThieuKyTruoc);
      const phaiThu    = formatVND(detail.phaiThu || detail.tongPhaiThu);

      document.getElementById("invNgayTinh").textContent   = ngayTinh;
      document.getElementById("invTienPhongTT").textContent= tienPhong;
      document.getElementById("invTongDv").textContent     = tongDv;
      document.getElementById("invPhatSinh").textContent   = phatSinh;
      document.getElementById("invGiamTru").textContent    = giamTru;
      document.getElementById("invThieuTruoc").textContent = thieuTruoc;
      document.getElementById("invPhaiThu").textContent    = phaiThu;

      // D·ªãch v·ª• chi ti·∫øt
      const svBody = document.getElementById("serviceTableBody");
      svBody.innerHTML = "";
      const services = detail.services || detail.chiTietDichVu || [];

      if (!services.length) {
        svBody.innerHTML = `<tr><td colspan="7" class="muted">Kh√¥ng c√≥ chi ti·∫øt d·ªãch v·ª• cho k·ª≥ ƒëang ch·ªçn.</td></tr>`;
      } else {
        services.forEach((s, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.stt || idx+1}</td>
            <td>${s.tenDichVu || s.tenDV || s.serviceName || ""}</td>
            <td>${s.soDau   ?? s.chiSoDau   ?? ""}</td>
            <td>${s.soCuoi  ?? s.chiSoCuoi  ?? ""}</td>
            <td>${s.soLuong ?? s.quantity   ?? ""}</td>
            <td>${formatVND(s.donGia)}</td>
            <td>${formatVND(s.thanhTien)}</td>
          `;
          svBody.appendChild(tr);
        });
      }

      // Th√¥ng tin ng√¢n h√†ng
      const bank = detail.bankInfo || detail.bank || {};
      document.getElementById("bankSoTk").textContent      = bank.soTk || bank.soTaiKhoan || "--";
      document.getElementById("bankChuTk").textContent     = bank.chuTk || bank.chuTaiKhoan || "--";
      document.getElementById("bankNganHang").textContent  = bank.nganHang || "--";
      document.getElementById("bankChiNhanh").textContent  = bank.chiNhanh || "--";

      const qrWrapper = document.getElementById("bankQrWrapper");
      const qrImg     = document.getElementById("bankQrImg");
      if (bank.qrCodeUrl || bank.qrImage) {
        qrImg.src = bank.qrCodeUrl || bank.qrImage;
        qrWrapper.style.display = "block";
      } else {
        qrWrapper.style.display = "none";
      }
    }

    // ====== B·∫¢O TR√å ======
    function setMaintenanceTable(rows) {
      const body = document.getElementById("maintenanceTableBody");
      if (!body) return;
      body.innerHTML = "";

      if (!Array.isArray(rows) || !rows.length) {
        body.innerHTML = `<tr><td colspan="6" class="muted">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ cho ph√≤ng n√†y.</td></tr>`;
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.ngayDuKien   || r.ngayDuKienBaoTri   || ""}</td>
          <td>${r.ngayThucHien || r.ngayBaoTri         || ""}</td>
          <td>${r.tenTaiSan    || r.taiSan             || ""}</td>
          <td>${r.loaiCongViec || r.loaiCV             || ""}</td>
          <td>${r.trangThai    || ""}</td>
          <td>${r.ghiChu       || ""}</td>
        `;
        body.appendChild(tr);
      });
    }

    // ====== TIN NH·∫ÆN ======
    function setMessages(messages) {
      const ul = document.getElementById("messagesList");
      if (!ul) return;
      ul.innerHTML = "";

      if (!Array.isArray(messages) || !messages.length) {
        ul.innerHTML = `<li class="muted">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</li>`;
        return;
      }

      messages.forEach(msg => {
        const li = document.createElement("li");
        li.style.marginBottom = "4px";
        const status = msg.status || msg.trangThai || "";
        li.innerHTML = `
          <strong>${msg.title || msg.chuDe || "Th√¥ng b√°o"}</strong>
          ${status ? `<span class="badge-soft">${status}</span>` : ""}
          <div style="font-size:0.8rem;color:rgba(148,163,184,0.9);">
            ${msg.content || msg.noiDung || ""}
          </div>
        `;
        ul.appendChild(li);
      });
    }

    // ====== FETCH DATA T·ª™ APPS SCRIPT ======
    async function fetchTenantPortalData(tenant) {
      const statusNote = document.getElementById("portalStatusNote");
      if (statusNote) {
        statusNote.textContent = "ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Google Sheet (Apps Script)...";
      }

      try {
        const body = new URLSearchParams({
          action:   "tenantPortal",
          roomCode: tenant.maPhong,
          identity: tenant.identity || ""
        });

        const res  = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        });

        const data = await res.json();

        if (!data || !data.success) {
          if (statusNote) statusNote.textContent =
            (data && data.message) || "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu portal. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã.";
          setContractSummary(null);
          setMembersTable([]);
          setPaymentHistory([], null);
          setInvoiceDetail(null);
          setMaintenanceTable([]);
          setMessages([]);
          return;
        }

        if (statusNote) {
          statusNote.textContent = "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ h·ªá th·ªëng.";
        }

        // G·ª¢I √ù JSON:
        // data.contract       : t·ª´ sheet H·ª£p ƒë·ªìng (Tr·∫°ng th√°i, Lo·∫°i Hƒê, Ng√†y Bƒê, Ng√†y KT, Ti·ªÅn thu√™, Ti·ªÅn c·ªçc, Ng√†y thu ti·ªÅn, M√£ DV1-3, ƒê∆°n gi√° DV1-3)
        // data.owner          : t·ª´ H·ª£p ƒë·ªìng + Kh√°ch thu√™ (Ch·ªß ph√≤ng)
        // data.members        : t·ª´ sheet Kh√°ch thu√™ (H·ªç v√† t√™n, S·ªë CCCD, S·ªë ƒëi·ªán tho·∫°i, Bi·ªÉn s·ªë, Ng√†y t·∫°m tr√∫, Tr·∫°ng th√°i t·∫°m tr√∫)
        // data.payments       : l·ªãch s·ª≠ thanh to√°n t·ªïng h·ª£p theo "NƒÉm th√°ng"
        // data.invoiceDetail  : chi ti·∫øt h√≥a ƒë∆°n k·ª≥ m·ªõi nh·∫•t ho·∫∑c k·ª≥ ƒë∆∞·ª£c ch·ªçn
        // data.maintenance    : t·ª´ sheet L·ªãch b·∫£o tr√¨
        // data.messages       : tin nh·∫Øn/th√¥ng b√°o

        setOwnerInfo(data.owner || null, tenant);
        setContractSummary(data.contract || null);
        setMembersTable(data.members || []);

        const contractStatus = (data.contract && (data.contract.trangThai || data.contract.status)) || "";
        setPaymentHistory(data.payments || data.invoices || [], contractStatus);

        setInvoiceDetail(data.invoiceDetail || null);
        setMaintenanceTable(data.maintenance || []);
        setMessages(data.messages || []);
      } catch (err) {
        console.error("fetchTenantPortalData error:", err);
        const statusNote = document.getElementById("portalStatusNote");
        if (statusNote) statusNote.textContent =
          "C√≥ l·ªói k·∫øt n·ªëi t·ªõi Apps Script. Vui l√≤ng ki·ªÉm tra API_URL ho·∫∑c th·ª≠ l·∫°i sau.";
      }
    }

    // ====== INIT ======
    document.addEventListener("DOMContentLoaded", () => {
      // X·ª≠ l√Ω tab click (upline v√¨ HTML ƒë√£ s·∫µn)
      document.querySelectorAll(".tab-nav").forEach(nav => {
        nav.addEventListener("click", (e) => {
          const btn = e.target.closest(".tab-btn");
          if (!btn) return;
          const tabId = btn.dataset.tab;
          const card = btn.closest(".card");
          if (!card) return;

          card.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          card.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
          const target = card.querySelector("#" + tabId);
          if (target) target.classList.add("active");
        });
      });

      // L·∫•y tenant t·ª´ localStorage
      const params = new URLSearchParams(window.location.search);
      const roomParam = params.get("room");

      let tenant = null;
      try {
        const saved = localStorage.getItem(TENANT_STORAGE_KEY);
        if (saved) tenant = JSON.parse(saved);
      } catch (e) {
        console.error("read tenant error:", e);
      }

      if (!tenant || !tenant.maPhong) {
        window.location.href = "tenant.html";
        return;
      }

      // ƒê·ªìng b·ªô room tr√™n URL
      if (!roomParam || roomParam !== tenant.maPhong) {
        const newUrl = "portal.html?room=" + encodeURIComponent(tenant.maPhong);
        window.history.replaceState({}, "", newUrl);
      }

      const roomBadge = document.getElementById("roomBadge");
      if (roomBadge) roomBadge.textContent = "Ph√≤ng: " + tenant.maPhong;

      // G·ªçi Apps Script
      fetchTenantPortalData(tenant);
    });
  </script>
</body>
</html>
