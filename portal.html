<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Portal t√†i kho·∫£n ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CSS d√πng chung -->
  <link rel="stylesheet" href="yt-home-common.css" />

  <!-- CSS layout ri√™ng cho portal -->
  <style>
    /* L∆∞·ªõi 2 c·ªôt cho c√°c card portal */
    body.portal-body .portal-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 12px;
      align-items: flex-start;
      margin-top: 12px;
    }

    body.portal-body .portal-col,
    body.portal-body .portal-col-main {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Tablet / mobile ‚Üí 1 c·ªôt */
    @media (max-width: 768px) {
      body.portal-body .portal-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="portal-body">
  <div class="container">
    <header class="header">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn-outline" style="text-decoration:none;">Trang xem ph√≤ng</a>
        <button type="button" class="btn-outline" onclick="logoutTenant()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">Xin ch√†o, c∆∞ d√¢n YT Home üè°</div>
      <div class="page-subtitle">
        ƒê√¢y l√† portal n·ªôi b·ªô d√†nh cho t√†i kho·∫£n ph√≤ng. D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ Google Sheet qua Apps Script.
      </div>
      <div id="portalStatusNote" class="portal-status">
        ƒêang t·∫£i d·ªØ li·ªáu ph√≤ng t·ª´ h·ªá th·ªëng...
      </div>

      <!-- L∆Ø·ªöI 2 C·ªòT CH·ª®A 6 CARD -->
      <div class="portal-grid">
        <!-- C·ªòT TR√ÅI: (1) Th√¥ng tin ph√≤ng, (2) T√≥m t·∫Øt Hƒê, (3) H√≥a ƒë∆°n g·∫ßn ƒë√¢y -->
        <div class="portal-col portal-col-main">
          <!-- (1) Th√¥ng tin t√†i kho·∫£n ph√≤ng -->
          <section class="card">
            <div class="card-title">Th√¥ng tin t√†i kho·∫£n ph√≤ng</div>
            <div class="badge" id="roomBadge">Ph√≤ng: --</div>

            <div class="info-row">
              <span class="info-label">Ph√≤ng:</span>
              <span class="info-value" id="roomLabel">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">T√™n ch·ªß ph√≤ng:</span>
              <span class="info-value" id="tenantName">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">ƒê·ªãnh danh (·∫©n b·ªõt):</span>
              <span class="info-value" id="tenantIdentity">--</span>
            </div>

            <div class="small-note">
              Th√¥ng tin n√†y ƒë∆∞·ª£c l·∫•y t·ª´ l·∫ßn ƒëƒÉng nh·∫≠p g·∫ßn nh·∫•t. C√≥ th·ªÉ m·ªü r·ªông ƒë·ªÉ load th√™m d·ªØ li·ªáu h·ª£p ƒë·ªìng t·ª´ sheet.
            </div>
          </section>

          <!-- (2) T√≥m t·∫Øt h·ª£p ƒë·ªìng -->
          <section class="card">
            <div class="card-title">T√≥m t·∫Øt h·ª£p ƒë·ªìng</div>
            <ul class="list">
              <li>Tr·∫°ng th√°i h·ª£p ƒë·ªìng: <strong id="contractStatus">ƒêang t·∫£i...</strong></li>
              <li>K·ª≥ thanh to√°n: <strong id="billingCycle">--</strong></li>
              <li>H√¨nh th·ª©c thanh to√°n: <strong id="paymentMethod">--</strong></li>
              <li>Th·ªùi h·∫°n h·ª£p ƒë·ªìng: <strong id="contractPeriod">--</strong></li>
              <li>Ti·ªÅn ph√≤ng/th√°ng: <strong id="contractRent">--</strong></li>
              <li>Ti·ªÅn c·ªçc: <strong id="contractDeposit">--</strong></li>
              <li>C√¥ng n·ª£ hi·ªán t·∫°i: <strong id="contractDebt">--</strong></li>
            </ul>
            <div class="small-note">
              C√°c gi√° tr·ªã tr√™n ƒë∆∞·ª£c map tr·ª±c ti·∫øp t·ª´ JSON <code>contract</code> Apps Script tr·∫£ v·ªÅ (sheet H·ª£p ƒë·ªìng).
            </div>
          </section>

          <!-- (3) H√≥a ƒë∆°n g·∫ßn ƒë√¢y -->
          <section class="card">
            <div class="section-title">H√≥a ƒë∆°n g·∫ßn ƒë√¢y</div>
            <table class="table-like">
              <thead>
                <tr>
                  <th style="width:80px;">K·ª≥</th>
                  <th>M√¥ t·∫£</th>
                  <th style="width:120px;">S·ªë ti·ªÅn</th>
                  <th style="width:120px;">Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="invoiceTableBody">
                <tr>
                  <td colspan="4" class="muted">ƒêang t·∫£i d·ªØ li·ªáu h√≥a ƒë∆°n...</td>
                </tr>
              </tbody>
            </table>
            <div class="small-note">
              Map v·ªõi sheet H√≥a ƒë∆°n: m·ªói d√≤ng c√≥ th·ªÉ t∆∞∆°ng ·ª©ng c√°c c·ªôt nh∆∞
              <code>K·ª≥</code>, <code>M√¥ t·∫£</code>, <code>S·ªë ti·ªÅn</code>, <code>Tr·∫°ng th√°i</code>, ƒë√£ ƒë∆∞·ª£c l·ªçc theo m√£ ph√≤ng.
            </div>
          </section>
        </div>

        <!-- C·ªòT PH·∫¢I: (4) Chi ti·∫øt h√≥a ƒë∆°n, (5) L·ªãch b·∫£o tr√¨, (6) Tin nh·∫Øn -->
        <div class="portal-col">
          <!-- (4) Chi ti·∫øt h√≥a ƒë∆°n / ch·ªâ s·ªë ƒëi·ªán n∆∞·ªõc -->
          <section class="card">
            <div class="section-title">Chi ti·∫øt h√≥a ƒë∆°n (ch·ªâ s·ªë ƒëi·ªán n∆∞·ªõc)</div>
            <table class="table-like">
              <thead>
                <tr>
                  <th style="width:80px;">K·ª≥</th>
                  <th>ƒêi·ªán (ƒê·∫ßu - Cu·ªëi - kWh)</th>
                  <th>N∆∞·ªõc (ƒê·∫ßu - Cu·ªëi - m¬≥)</th>
                  <th style="width:120px;">Ti·ªÅn ƒëi·ªán</th>
                  <th style="width:120px;">Ti·ªÅn n∆∞·ªõc</th>
                  <th style="width:120px;">T·ªïng</th>
                </tr>
              </thead>
              <tbody id="utilitiesTableBody">
                <tr>
                  <td colspan="6" class="muted">ƒêang t·∫£i d·ªØ li·ªáu ƒëi·ªán n∆∞·ªõc...</td>
                </tr>
              </tbody>
            </table>
            <div class="small-note">
              Map v·ªõi sheet ƒêi·ªán n∆∞·ªõc: m·ªói d√≤ng c√≥ th·ªÉ t∆∞∆°ng ·ª©ng c√°c c·ªôt nh∆∞
              <code>K·ª≥</code>, <code>CS ƒëi·ªán ƒë·∫ßu/cu·ªëi</code>, <code>kWh</code>, <code>CS n∆∞·ªõc ƒë·∫ßu/cu·ªëi</code>, <code>m¬≥</code>, <code>Ti·ªÅn ƒëi·ªán</code>, <code>Ti·ªÅn n∆∞·ªõc</code>, <code>T·ªïng</code>.
            </div>
          </section>

          <!-- (5) L·ªãch b·∫£o tr√¨ -->
          <section class="card">
            <div class="section-title">L·ªãch b·∫£o tr√¨</div>
            <table class="table-like" id="maintenanceTable">
              <thead>
                <tr>
                  <th style="width:110px;">Ng√†y</th>
                  <th>H·∫°ng m·ª•c</th>
                  <th style="width:110px;">Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="muted">
                    Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ n√†o. Ph·∫ßn n√†y s·∫Ω hi·ªÉn th·ªã c√°c l·∫ßn b·∫£o tr√¨ li√™n quan ƒë·∫øn ph√≤ng (v·ªá sinh m√°y l·∫°nh, ki·ªÉm tra thi·∫øt b·ªã,...).
                  </td>
                </tr>
              </tbody>
            </table>
          </section>

          <!-- (6) Tin nh·∫Øn -->
          <section class="card">
            <div class="section-title">Tin nh·∫Øn</div>
            <div id="messagesList" class="list">
              <li class="muted">
                Ch∆∞a c√≥ tin nh·∫Øn n√†o. Khi tri·ªÉn khai, ph·∫ßn n√†y s·∫Ω hi·ªÉn th·ªã th√¥ng b√°o v√† trao ƒë·ªïi gi·ªØa qu·∫£n l√Ω & c∆∞ d√¢n.
              </li>
            </div>
          </section>
        </div>
      </div> <!-- /portal-grid -->
    </main>
  </div>

  <script>
    const TENANT_STORAGE_KEY = "ytHomeTenant";
    const API_URL = "https://script.google.com/macros/s/AKfycbwyqskjnUjwkn95TqRmcFjLem2eSMfKBuh23PHDD0QcL0gCwEnqNLYxd6vmi7xqDzUoow/exec";

    function logoutTenant() {
      try {
        localStorage.removeItem(TENANT_STORAGE_KEY);
      } catch (e) {
        console.error("logoutTenant error:", e);
      }
      window.location.href = "tenant.html";
    }

    function maskIdentity(identity) {
      if (!identity) return "--";
      const s = String(identity);
      if (s.length <= 4) return "***" + s;
      const last4 = s.slice(-4);
      return "**** " + last4;
    }

    function formatVND(amount) {
      if (amount === null || amount === undefined || amount === "") return "--";
      const num = Number(String(amount).replace(/[^\d.-]/g, ""));
      if (isNaN(num)) return String(amount);
      return num.toLocaleString("vi-VN") + " ƒë";
    }

    function setContractSummary(contract) {
      const statusEl   = document.getElementById("contractStatus");
      const cycleEl    = document.getElementById("billingCycle");
      const payEl      = document.getElementById("paymentMethod");
      const periodEl   = document.getElementById("contractPeriod");
      const rentEl     = document.getElementById("contractRent");
      const depositEl  = document.getElementById("contractDeposit");
      const debtEl     = document.getElementById("contractDebt");

      if (!contract) {
        if (statusEl) statusEl.textContent = "Ch∆∞a c√≥ h·ª£p ƒë·ªìng trong h·ªá th·ªëng";
        if (cycleEl)  cycleEl.textContent  = "--";
        if (payEl)    payEl.textContent    = "--";
        if (periodEl) periodEl.textContent = "--";
        if (rentEl)   rentEl.textContent   = "--";
        if (depositEl)depositEl.textContent= "--";
        if (debtEl)   debtEl.textContent   = "--";
        return;
      }

      if (statusEl)  statusEl.textContent  = contract.status       || "ƒêang hi·ªáu l·ª±c";
      if (cycleEl)   cycleEl.textContent   = contract.billingCycle || "H√†ng th√°ng";
      if (payEl)     payEl.textContent     = contract.paymentMethod|| "Chuy·ªÉn kho·∫£n / ti·ªÅn m·∫∑t";

      const start = contract.startDate || "";
      const end   = contract.endDate   || "";
      if (periodEl) {
        periodEl.textContent = start && end ? (start + " ‚Äì " + end) : (start || end || "--");
      }

      if (rentEl)     rentEl.textContent     = formatVND(contract.rentAmount);
      if (depositEl)  depositEl.textContent  = formatVND(contract.deposit);
      if (debtEl)     debtEl.textContent     = formatVND(contract.debt);
    }

    function setInvoicesTable(invoices) {
      const tbody = document.getElementById("invoiceTableBody");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!Array.isArray(invoices) || !invoices.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="muted">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o cho ph√≤ng n√†y.</td>
          </tr>
        `;
        return;
      }

      invoices.forEach((inv) => {
        const tr = document.createElement("tr");
        const period = inv.period || inv.ky || "--";
        const desc   = inv.description || inv.moTa || inv.noiDung || "";
        const amount = formatVND(inv.amount != null ? inv.amount : inv.soTien);
        const status = inv.status || inv.trangThai || "";

        tr.innerHTML = `
          <td>${period}</td>
          <td>${desc}</td>
          <td>${amount}</td>
          <td>${status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function setUtilitiesTable(utilities) {
      const tbody = document.getElementById("utilitiesTableBody");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!Array.isArray(utilities) || !utilities.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªán n∆∞·ªõc cho ph√≤ng n√†y.</td>
          </tr>
        `;
        return;
      }

      utilities.forEach((u) => {
        const tr = document.createElement("tr");
        const period = u.period || u.ky || "--";

        const eStart = u.electricStart ?? u.csDienDau ?? "";
        const eEnd   = u.electricEnd   ?? u.csDienCuoi ?? "";
        const eKwh   = u.electricKwh   ?? u.soKwh      ?? "";

        const wStart = u.waterStart    ?? u.csNuocDau  ?? "";
        const wEnd   = u.waterEnd      ?? u.csNuocCuoi ?? "";
        const wM3    = u.waterM3       ?? u.soM3       ?? "";

        const eAmt = formatVND(u.electricAmount ?? u.tienDien);
        const wAmt = formatVND(u.waterAmount    ?? u.tienNuoc);
        const tot  = formatVND(u.total          ?? u.tongTien);

        tr.innerHTML = `
          <td>${period}</td>
          <td>${eStart} ‚Üí ${eEnd} (${eKwh || 0} kWh)</td>
          <td>${wStart} ‚Üí ${wEnd} (${wM3  || 0} m¬≥)</td>
          <td>${eAmt}</td>
          <td>${wAmt}</td>
          <td>${tot}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function fetchTenantPortalData(tenant) {
      const statusNote = document.getElementById("portalStatusNote");
      if (statusNote) {
        statusNote.textContent = "ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Google Sheet (Apps Script)...";
      }

      try {
        const body = new URLSearchParams({
          action:   "tenantPortal",
          roomCode: tenant.maPhong,
          identity: tenant.identity || ""
        });

        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body
        });

        const data = await res.json();

        if (!data || !data.success) {
          if (statusNote) {
            statusNote.textContent =
              (data && data.message) ||
              "Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu portal t·ª´ Apps Script. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã.";
          }
          setContractSummary(null);
          setInvoicesTable([]);
          setUtilitiesTable([]);
          return;
        }

        if (statusNote) {
          statusNote.textContent = "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ h·ªá th·ªëng (c·∫≠p nh·∫≠t t·ª´ Google Sheet).";
        }

        setContractSummary(data.contract || null);
        setInvoicesTable(data.invoices || []);
        setUtilitiesTable(data.utilities || []);
      } catch (err) {
        console.error("fetchTenantPortalData error:", err);
        if (statusNote) {
          statusNote.textContent =
            "C√≥ l·ªói k·∫øt n·ªëi t·ªõi Apps Script. Vui l√≤ng ki·ªÉm tra API_URL ho·∫∑c th·ª≠ l·∫°i sau.";
        }
        setContractSummary(null);
        setInvoicesTable([]);
        setUtilitiesTable([]);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const roomParam = params.get("room");

      let tenant = null;
      try {
        const saved = localStorage.getItem(TENANT_STORAGE_KEY);
        if (saved) {
          tenant = JSON.parse(saved);
        }
      } catch (e) {
        console.error("read tenant error:", e);
      }

      if (!tenant || !tenant.maPhong) {
        window.location.href = "tenant.html";
        return;
      }

      if (!roomParam || roomParam !== tenant.maPhong) {
        const newUrl = "portal.html?room=" + encodeURIComponent(tenant.maPhong);
        window.history.replaceState({}, "", newUrl);
      }

      const roomBadge   = document.getElementById("roomBadge");
      const roomLabel   = document.getElementById("roomLabel");
      const tenantName  = document.getElementById("tenantName");
      const tenantIdEl  = document.getElementById("tenantIdentity");

      if (roomBadge) {
        roomBadge.textContent = "Ph√≤ng: " + tenant.maPhong;
      }
      if (roomLabel) {
        roomLabel.textContent = tenant.maPhong;
      }
      if (tenantName) {
        tenantName.textContent = tenant.name || "Ch·ªß ph√≤ng";
      }
      if (tenantIdEl) {
        tenantIdEl.textContent = maskIdentity(tenant.identity || "");
      }

      fetchTenantPortalData(tenant);
    });
  </script>
</body>
</html>
