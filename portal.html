<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home – Portal tài khoản phòng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="yt-home-common.css" />
</head>
<body class="tenant-body">

<!-- ================= POPUP THANH TOÁN ================= -->
<div id="paymentModal" class="modal hidden">
  <div class="modal-content">
    <h3>Gửi phiếu thanh toán</h3>

    <div class="form-group">
      <label>Ảnh phiếu chuyển khoản</label>
      <input type="file" id="paymentProof" accept="image/*">
    </div>

    <div class="form-group">
      <label>Ghi chú</label>
      <textarea id="paymentNote" rows="3"
        placeholder="VD: Đã chuyển khoản lúc 10h ngày 15/12..."></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closePaymentModal()">Hủy</button>
      <button class="btn btn-danger" onclick="submitPayment()">Gửi thông báo</button>
    </div>
  </div>
</div>

<div class="container">
  <main>

    <!-- ================= THANH TOÁN ================= -->
    <section class="card">
      <div class="card-title">Thanh toán</div>

      <div class="tab-row">
        <button class="tab-btn tab-pay active" data-tab="history">Lịch sử thanh toán</button>
        <button class="tab-btn tab-pay" data-tab="detail">Chi tiết hóa đơn</button>
      </div>

      <!-- ===== TAB LỊCH SỬ ===== -->
      <div class="tab-pane tab-pane-pay" id="tab-history">
        <table class="table-like">
          <thead>
            <tr>
              <th>Kỳ</th>
              <th>Phải thu</th>
              <th>Trạng thái</th>
              <th>Chi tiết</th>
            </tr>
          </thead>
          <tbody id="paymentHistoryBody"></tbody>
        </table>
      </div>

      <!-- ===== TAB CHI TIẾT ===== -->
      <div class="tab-pane tab-pane-pay hidden" id="tab-detail">
        <div id="invoiceDetail"></div>

        <div class="section-title">Chi tiết dịch vụ</div>
        <table class="table-like">
          <thead>
            <tr>
              <th>Dịch vụ</th>
              <th>Số đầu</th>
              <th>Số cuối</th>
              <th>Số lượng</th>
              <th>Đơn giá</th>
              <th>Thành tiền</th>
            </tr>
          </thead>
          <tbody id="serviceDetailBody"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="text-right"><strong>Tổng</strong></td>
              <td id="serviceTotal" class="text-right"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- ===== THÔNG TIN CHUYỂN KHOẢN ===== -->
      <div class="section-title">Thông tin chuyển khoản</div>
      <p id="bankInfo" class="small-note">--</p>

      <div class="section-title">QR thanh toán</div>
      <div id="qrContainer">--</div>
    </section>

  </main>
</div>

<script>
let selectedInvoice = null;

function renderPaymentHistory(invoices) {
  const tbody = document.getElementById("paymentHistoryBody");
  tbody.innerHTML = "";

  invoices.forEach(inv => {
    const paid = String(inv.trangThai || "").toLowerCase().includes("đã");
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${inv.namThang}</td>
      <td class="text-danger">${formatVND(inv.tongPhaiThu)}</td>
      <td>
        ${paid
          ? '<span class="badge-success">Đã thanh toán</span>'
          : '<button class="btn btn-danger btn-sm" onclick="openPaymentModal()">Thanh toán</button>'
        }
      </td>
      <td>
        <button class="btn btn-outline btn-sm"
          onclick='selectInvoice(${JSON.stringify(inv)})'>
          Xem
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function selectInvoice(inv) {
  selectedInvoice = inv;
  setActiveTab("pay", "detail");

  document.getElementById("invoiceDetail").innerHTML = `
    <p>Kỳ: <strong>${inv.namThang}</strong></p>
    <p>Phải thu: <strong class="text-danger">${formatVND(inv.tongPhaiThu)}</strong></p>
    ${
      String(inv.trangThai || "").toLowerCase().includes("đã")
      ? '<span class="badge-success">Đã thanh toán</span>'
      : '<button class="btn btn-danger" onclick="openPaymentModal()">Thanh toán</button>'
    }
  `;

  // dịch vụ
  const body = document.getElementById("serviceDetailBody");
  body.innerHTML = "";
  let total = 0;

  (inv.services || []).forEach(s => {
    total += Number(s.thanhTien || 0);
    body.innerHTML += `
      <tr>
        <td>${s.tenDV}</td>
        <td>${s.soDau || ""}</td>
        <td>${s.soCuoi || ""}</td>
        <td>${s.soLuong || ""}</td>
        <td>${formatVND(s.donGia)}</td>
        <td>${formatVND(s.thanhTien)}</td>
      </tr>
    `;
  });

  document.getElementById("serviceTotal").textContent = formatVND(total);

  // ngân hàng + QR
  document.getElementById("bankInfo").textContent =
    inv.bankInfoText || "--";

  const qr = document.getElementById("qrContainer");
  qr.innerHTML = inv.qrCode
    ? `<img src="${inv.qrCode}" style="max-width:160px">`
    : "--";
}

function openPaymentModal() {
  document.getElementById("paymentModal").classList.remove("hidden");
}
function closePaymentModal() {
  document.getElementById("paymentModal").classList.add("hidden");
}
function submitPayment() {
  alert("Đã gửi thông báo thanh toán cho chủ nhà!");
  closePaymentModal();
}
</script>
</body>
</html>
