<!DOCTYPE html - Ver 2.2->
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home – Đăng nhập tài khoản phòng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="yt-home-api" content="https://script.google.com/macros/s/AKfycbxABOcX_0-vSVBRGYX1DCfNRsyFGp_U6i4z3luapHJ_v1BNT5SC1O7DdrDvBFqjmBzIOg/exec" />

  <link rel="stylesheet" href="yt-home-common.css" />

  <style>
    body.tenant-body .page-wrapper { width: 100%; max-width: 420px; }
  </style>
</head>

<body class="tenant-body">
  <div class="container">
    <div class="page-wrapper">
      <div class="card">
        <div class="logo-row">
          <div class="logo-icon">YT</div>
          <div class="logo-text">
            <div class="logo-text-main">YT Home</div>
            <div class="logo-text-sub">Portal tài khoản phòng</div>
          </div>
        </div>

        <div class="page-title">Đăng nhập tài khoản phòng</div>
        <div class="page-subtitle">
          Nhập <strong>Mã phòng</strong> và <strong>Số điện thoại/CCCD</strong> của chủ phòng để xem portal nội bộ.
        </div>

        <div id="roomBadge" class="badge" style="display:none;"></div>

        <form id="loginForm">
          <div class="form-group">
            <label for="loginCode">Mã phòng</label>
            <input id="loginCode" class="form-control" type="text" autocomplete="off" required />
          </div>

          <div class="form-group">
            <label for="loginPhone">Số điện thoại/CCCD chủ phòng</label>
            <input id="loginPhone" class="form-control" type="tel" autocomplete="off" required />
          </div>

          <button type="submit" class="btn">Đăng nhập</button>
        </form>

        <div id="loginStatus" class="portal-status"></div>

        <div class="small-note">
          Sau khi đăng nhập thành công, hệ thống sẽ lưu tài khoản phòng để những lần sau tự chuyển thẳng vào portal.
        </div>

        <div class="tenant-footer-actions">
          <a href="index.html" class="tenant-back-link">← Quay lại trang xem phòng</a>

          <button type="button" id="logoutBtn" class="btn-logout">
            <span class="btn-logout-icon">⇄</span>
            <span>Đăng xuất / Đổi phòng</span>
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ======================================================
   * CẤU HÌNH CHUNG
   * ====================================================== */
  const API_URL = (
    window.YT_HOME_API_URL ||
    document.querySelector("meta[name=yt-home-api]")?.content ||
    "https://script.google.com/macros/s/AKfycbxABOcX_0-vSVBRGYX1DCfNRsyFGp_U6i4z3luapHJ_v1BNT5SC1O7DdrDvBFqjmBzIOg/exec"
  );
  const TENANT_STORAGE_KEY = "ytHomeTenant";

  /* ======================================================
   * CHỐNG VÒNG LẶP REDIRECT portal.html <-> tenant.html
   * - tenant.html chỉ auto-redirect về portal khi:
   *   (1) có tenant saved
   *   (2) có SID
   *   (3) portal.html có để lại "returnTo" hoặc URL room khớp
   * ====================================================== */
  const YTH_REDIRECT_GUARD_KEY = "YTH_REDIRECT_GUARD";
  const YTH_RETURN_TO_KEY = "YTH_RETURN_TO";
  const REDIRECT_MAX = 2;
  const REDIRECT_TTL_MS = 15000;

  function guardRedirectOnce(toUrl){
    let g = {};
    try { g = JSON.parse(sessionStorage.getItem(YTH_REDIRECT_GUARD_KEY) || "{}"); } catch(e){}
    const now = Date.now();

    if (!g.t || (now - g.t) > REDIRECT_TTL_MS) g = { t: now, c: 0 };
    g.c = (g.c || 0) + 1;
    g.t = now;
    sessionStorage.setItem(YTH_REDIRECT_GUARD_KEY, JSON.stringify(g));

    if (g.c > REDIRECT_MAX) return false;
    location.replace(toUrl);
    return true;
  }

  function getReturnTo(){
    try { return sessionStorage.getItem(YTH_RETURN_TO_KEY) || ""; } catch(e){ return ""; }
  }
  function clearReturnTo(){
    try { sessionStorage.removeItem(YTH_RETURN_TO_KEY); } catch(e){}
  }

  /* ======================================================
   * SID + TS + NONCE (ĐẶT TRƯỚC callApi)
   * ====================================================== */
  const YTH_SID_KEY = "YTH_SID";

  function setSID(sid) {
    if (!sid) return;
    try { sessionStorage.setItem(YTH_SID_KEY, sid); } catch(e) {}
    try { localStorage.setItem(YTH_SID_KEY, sid); } catch(e) {}
  }
  function getSID() {
    let sid = "";
    try { sid = sessionStorage.getItem(YTH_SID_KEY) || ""; } catch(e) {}
    if (!sid) { try { sid = localStorage.getItem(YTH_SID_KEY) || ""; } catch(e) {} }
    return (sid || "").trim();
  }
  function clearSID() {
    try { sessionStorage.removeItem(YTH_SID_KEY); } catch(e) {}
    try { localStorage.removeItem(YTH_SID_KEY); } catch(e) {}
  }
  function makeNonce() {
    return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
  }

  /* ======================================================
   * JSONP CALL (DUY NHẤT) - AUTO gắn sid + ts
   * ====================================================== */
  function callApi(action, params = {}) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
      window[cb] = (data) => { cleanup(); resolve(data); };

      const sid = getSID();
      const ts  = Date.now();

      const mergedParams = { ...params, ts };
      if (sid) mergedParams.sid = sid;

      const qs = new URLSearchParams({ action, ...mergedParams, callback: cb }).toString();
      const s = document.createElement("script");
      s.src = API_URL + "?" + qs;
      s.onerror = () => { cleanup(); reject(new Error("JSONP load failed")); };
      document.body.appendChild(s);

      function cleanup() {
        try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        if (s.parentNode) s.parentNode.removeChild(s);
      }
    });
  }

  function callApiWrite(action, params = {}) {
    return callApi(action, { ...params, nonce: makeNonce() });
  }

  /* ======================================================
   * LOCAL STORAGE
   * ====================================================== */
  function saveTenantToStorage(tenant) {
    try {
      if (tenant) localStorage.setItem(TENANT_STORAGE_KEY, JSON.stringify(tenant));
      else localStorage.removeItem(TENANT_STORAGE_KEY);
    } catch (e) {
      console.error("saveTenantToStorage error:", e);
    }
  }

  function readTenantFromStorage(){
    try {
      const saved = localStorage.getItem(TENANT_STORAGE_KEY);
      if (!saved) return null;
      const t = JSON.parse(saved);
      return (t && t.maPhong) ? t : null;
    } catch(e){
      return null;
    }
  }

  function safeGotoPortal(room){
    const returnTo = getReturnTo();
    clearReturnTo();

    // ưu tiên quay về URL mà portal.html đã để lại (nếu có)
    if (returnTo) {
      const ok = guardRedirectOnce(returnTo);
      if (!ok) {
        // fallback
        window.location.href = "portal.html?room=" + encodeURIComponent(room || "");
      }
      return;
    }

    // fallback theo room
    window.location.href = "portal.html?room=" + encodeURIComponent(room || "");
  }

  function logoutTenant() {
    saveTenantToStorage(null);
    clearSID();
    clearReturnTo();

    const status = document.getElementById("loginStatus");
    if (status) status.textContent = "Đã xoá phiên đăng nhập. Bạn có thể đăng nhập lại với phòng khác.";

    const phoneEl = document.getElementById("loginPhone");
    if (phoneEl) phoneEl.value = "";
    
    const codeEl = document.getElementById("loginCode");
    if (codeEl) codeEl.value = "";

    const badgeEl = document.getElementById("roomBadge");
    if (badgeEl) { badgeEl.style.display = "none"; badgeEl.textContent = ""; }
  }

  /* ======================================================
   * LOGIN SUBMIT
   * ====================================================== */
  async function handleLoginSubmit(event) {
    event.preventDefault();

    const statusEl   = document.getElementById("loginStatus");
    const roomCodeEl = document.getElementById("loginCode");
    const phoneEl    = document.getElementById("loginPhone");

    const roomCode = roomCodeEl ? roomCodeEl.value.trim().toUpperCase() : "";
    const phoneOrCCCD = phoneEl ? phoneEl.value.trim() : "";

    if (!roomCode || !phoneOrCCCD) {
      if (statusEl) statusEl.textContent = "Vui lòng nhập đầy đủ Mã phòng và Số điện thoại/CCCD.";
      return;
    }

    if (statusEl) statusEl.textContent = "Đang kiểm tra thông tin đăng nhập...";

    try {
      const data = await callApi("tenantLogin", { roomCode, identity: phoneOrCCCD });
    
      if (!data || !data.success) {
        if (statusEl) statusEl.textContent = data?.message || "Đăng nhập không hợp lệ.";
        return;
      }
    
      // ✅ LƯU SID SAU LOGIN
      if (data.sid) setSID(data.sid);
    
      const tenant = {
        maPhong: (data.roomCode || data.maPhong || roomCode || "").toUpperCase(),
        identity: phoneOrCCCD,
        name: data.tenantName || data.tenNguoiThue || ""
      };
    
      saveTenantToStorage(tenant);
    
      if (statusEl) statusEl.textContent = "Đăng nhập thành công. Đang chuyển vào portal...";
      safeGotoPortal(tenant.maPhong);
    
    } catch (err) {
      console.error("handleLoginSubmit error:", err);
      if (statusEl) statusEl.textContent = "Lỗi kết nối Apps Script. Vui lòng thử lại.";
    }
  }

  /* ======================================================
   * DOM READY
   * ====================================================== */
  document.addEventListener("DOMContentLoaded", () => {
    const params      = new URLSearchParams(window.location.search);
    const roomFromURL = (params.get("room") || "").trim();

    const loginCodeEl = document.getElementById("loginCode");
    const roomBadgeEl = document.getElementById("roomBadge");
    const statusEl    = document.getElementById("loginStatus");

    // ✅ PREFILL room từ URL (nếu có)
    if (roomFromURL && loginCodeEl) {
      loginCodeEl.value = roomFromURL.toUpperCase();
      if (roomBadgeEl) {
        roomBadgeEl.style.display = "inline-block";
        roomBadgeEl.textContent = "Đang đăng nhập cho phòng: " + roomFromURL.toUpperCase();
      }
    }

    // ✅ AUTO REDIRECT nếu đã có tenant + có SID + phòng khớp (tránh loop)
    const savedTenant = readTenantFromStorage();
    const sid = getSID();

    if (savedTenant && sid) {
      const okRoom =
        (!roomFromURL) ||
        (roomFromURL.toUpperCase() === String(savedTenant.maPhong).toUpperCase());

      if (okRoom) {
        // chỉ tự chuyển khi đủ điều kiện, dùng guard để không loop
        const msg = "Đã có phiên đăng nhập. Đang chuyển vào portal...";
        if (statusEl) statusEl.textContent = msg;

        // ưu tiên returnTo nếu portal vừa đá về
        const returnTo = getReturnTo();
        if (returnTo) {
          const ok = guardRedirectOnce(returnTo);
          if (!ok && statusEl) statusEl.textContent = "Đang ở trang đăng nhập (đã chặn vòng lặp chuyển trang). Bấm Đăng nhập để vào portal.";
          return;
        }

        const ok = guardRedirectOnce("portal.html?room=" + encodeURIComponent(savedTenant.maPhong));
        if (!ok && statusEl) statusEl.textContent = "Đang ở trang đăng nhập (đã chặn vòng lặp chuyển trang). Bấm Đăng nhập để vào portal.";
        return;
      }
    }

    // nếu có tenant saved nhưng thiếu SID => đừng auto-redirect
    if (savedTenant && !sid) {
      if (statusEl) statusEl.textContent = "Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.";
    }

    const form = document.getElementById("loginForm");
    if (form) form.addEventListener("submit", handleLoginSubmit);

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) logoutBtn.addEventListener("click", logoutTenant);
  });
</script>
</body>
</html>





