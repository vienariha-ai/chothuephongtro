<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home – Đăng nhập tài khoản phòng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="yt-home-api" content="https://script.google.com/macros/s/AKfycbyTCSCKa4CS3FkmgQAjbvbMaeiZ4RhtZI_h4qBroK2ppLAstrfi3hKjHIGzbKEgWWXd7Q/exec" />

  <!-- NHỚ sửa lại href cho đúng tên file CSS chung của bạn -->
  <link rel="stylesheet" href="yt-home-common.css" />

  <style>
    /* Giới hạn rộng khung login trong trang tenant */
    body.tenant-body .page-wrapper {
      width: 100%;
      max-width: 420px;
    }
  </style>
</head>

<body class="tenant-body">
  <div class="container">
    <div class="page-wrapper">
      <div class="card">
        <!-- Logo -->
        <div class="logo-row">
          <div class="logo-icon">YT</div>
          <div class="logo-text">
            <div class="logo-text-main">YT Home</div>
            <div class="logo-text-sub">Portal tài khoản phòng</div>
          </div>
        </div>

        <!-- Tiêu đề & mô tả -->
        <div class="page-title">Đăng nhập tài khoản phòng</div>
        <div class="page-subtitle">
          Nhập <strong>Mã phòng</strong> và <strong>Số điện thoại/CCCD</strong> của chủ phòng để xem portal nội bộ.
        </div>

        <!-- Badge hiển thị phòng từ URL -->
        <div id="roomBadge" class="badge" style="display:none;"></div>

        <!-- Form đăng nhập -->
        <form id="loginForm">
          <div class="form-group">
            <label for="loginCode">Mã phòng</label>
            <input id="loginCode" class="form-control" type="text" autocomplete="off" required />
          </div>

          <div class="form-group">
            <label for="loginPhone">Số điện thoại/CCCD chủ phòng</label>
            <input id="loginPhone" class="form-control" type="tel" autocomplete="off" required />
          </div>

          <button type="submit" class="btn">
            Đăng nhập
          </button>
        </form>

        <!-- Trạng thái đăng nhập -->
        <div id="loginStatus" class="portal-status"></div>

        <!-- Ghi chú nhỏ -->
        <div class="small-note">
          Sau khi đăng nhập thành công, hệ thống sẽ lưu tài khoản phòng để những lần sau tự chuyển thẳng vào portal.
        </div>

        <!-- Footer: quay lại & đăng xuất/đổi phòng -->
        <div class="tenant-footer-actions">
          <a href="index.html" class="tenant-back-link">
            ← Quay lại trang xem phòng
          </a>

          <button type="button" id="logoutBtn" class="btn-logout">
            <span class="btn-logout-icon">⇄</span>
            <span>Đăng xuất / Đổi phòng</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
  const API_URL = (window.YT_HOME_API_URL || document.querySelector("meta[name=yt-home-api]")?.content || "");
  const TENANT_KEYS = ["ytHomeTenant","YT_HOME_TENANT","tenantRoom","tenantAuth","ytHomeTenantAuth"];
  const JUST_LOGGED_OUT_KEY = "ytHomeJustLoggedOut";

  function normRoomCode(s){ return String(s||"").trim().toUpperCase(); }
  function normIdentity(s){ return String(s||"").trim(); }

  function setStatus(msg){
    const el = document.getElementById("loginStatus");
    if (el) el.textContent = msg || "";
  }

  function setTenant(t){
    try{
      const raw = t ? JSON.stringify(t) : "";
      TENANT_KEYS.forEach(k=>{
        try{
          if (!t) localStorage.removeItem(k);
          else localStorage.setItem(k, raw);
        }catch(e){}
      });
    }catch(e){
      console.error("setTenant error:", e);
    }
  }

  function getTenant(){
    for (const k of TENANT_KEYS){
      try{
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        const t = JSON.parse(raw);
        const maPhong = normRoomCode(t?.maPhong || t?.roomCode || t?.room || t?.MaPhong || "");
        if (!maPhong) continue;
        return {
          maPhong,
          identity: normIdentity(t?.identity || t?.phone || t?.cccd || ""),
          name: String(t?.name || t?.tenKhach || t?.tenChuPhong || "")
        };
      }catch(e){}
    }
    return null;
  }

  function clearTenant(){
    setTenant(null);
  }

  function logoutTenant(){
    clearTenant();
    try{ sessionStorage.setItem(JUST_LOGGED_OUT_KEY, "1"); }catch(e){}
    setStatus("Đã xoá phiên đăng nhập. Bạn có thể đăng nhập lại với phòng khác.");
    const phoneEl = document.getElementById("loginPhone");
    if (phoneEl) phoneEl.value = "";
    const badgeEl = document.getElementById("roomBadge");
    if (badgeEl) { badgeEl.style.display="none"; badgeEl.textContent=""; }
  }

  async function apiGet(action, params){
    const qs = new URLSearchParams(Object.assign({ action }, params || {}));
    const url = API_URL + (API_URL.includes("?") ? "&" : "?") + qs.toString();
    const res = await fetch(url, { method:"GET" });
    return res.json();
  }

  async function handleLoginSubmit(event){
    event.preventDefault();

    if(!API_URL){
      setStatus("Thiếu API URL (meta yt-home-api).");
      return;
    }

    const roomCode = normRoomCode(document.getElementById("loginCode")?.value || "");
    const identity = normIdentity(document.getElementById("loginPhone")?.value || "");

    if(!roomCode || !identity){
      setStatus("Vui lòng nhập đầy đủ Mã phòng và Số điện thoại/CCCD.");
      return;
    }

    setStatus("Đang kiểm tra thông tin đăng nhập...");
    try{
      const data = await apiGet("tenantLogin", { roomCode, identity });
      const ok = !!(data && (data.success || data.ok));
      if(!ok){
        setStatus((data && (data.message || data.error)) || "Không tìm thấy Hợp đồng hiệu lực hoặc Số điện thoại/CCCD không khớp.");
        return;
      }

      const tenant = {
        maPhong: normRoomCode(data.maPhong || roomCode),
        identity,
        name: String(data.tenKhach || data.tenChuPhong || "")
      };

      setTenant(tenant);
      try{ sessionStorage.removeItem(JUST_LOGGED_OUT_KEY); }catch(e){}
      setStatus("Đăng nhập thành công. Đang chuyển vào portal...");
      window.location.href = "portal.html?room=" + encodeURIComponent(tenant.maPhong);
    }catch(err){
      console.error("handleLoginSubmit error:", err);
      setStatus("Có lỗi khi đăng nhập. Vui lòng thử lại sau.");
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    const params      = new URLSearchParams(window.location.search);
    const roomFromURL = normRoomCode(params.get("room") || "");
    const loginCodeEl = document.getElementById("loginCode");
    const roomBadgeEl = document.getElementById("roomBadge");

    // ✅ chống loop: nếu vừa logout từ portal -> KHÔNG auto redirect
    try{
      const justOut = sessionStorage.getItem(JUST_LOGGED_OUT_KEY) === "1";
      if (justOut) sessionStorage.removeItem(JUST_LOGGED_OUT_KEY);
      if (!justOut){
        const t = getTenant();
        if (t && t.maPhong){
          if (!roomFromURL || roomFromURL === t.maPhong){
            window.location.href = "portal.html?room=" + encodeURIComponent(t.maPhong);
            return;
          }
        }
      }
    }catch(e){}

    if (roomFromURL && loginCodeEl){
      loginCodeEl.value = roomFromURL;
      if (roomBadgeEl){
        roomBadgeEl.style.display = "inline-block";
        roomBadgeEl.textContent = "Đang đăng nhập cho phòng: " + roomFromURL;
      }
    }

    document.getElementById("loginForm")?.addEventListener("submit", handleLoginSubmit);
    document.getElementById("logoutBtn")?.addEventListener("click", logoutTenant);
  });
</script>
</body>
</html>

