<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì ƒêƒÉng nh·∫≠p t√†i kho·∫£n ph√≤ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="yt-home-api" content="https://script.google.com/macros/s/AKfycbxA2djnaTUjekiWl89BFJL-9ZLEbKClWb-5z7z3o_ZoamgPImDpIzhStGjuCx7BHB_MkQ/exec" />

  <!-- NH·ªö s·ª≠a l·∫°i href cho ƒë√∫ng t√™n file CSS chung c·ªßa b·∫°n -->
  <link rel="stylesheet" href="yt-home-common.css" />

  <style>
    /* Gi·ªõi h·∫°n r·ªông khung login trong trang tenant */
    body.tenant-body .page-wrapper {
      width: 100%;
      max-width: 420px;
    }
  </style>
</head>

<body class="tenant-body">
  <div class="container">
    <div class="page-wrapper">
      <div class="card">
        <!-- Logo -->
        <div class="logo-row">
          <div class="logo-icon">YT</div>
          <div class="logo-text">
            <div class="logo-text-main">YT Home</div>
            <div class="logo-text-sub">Portal t√†i kho·∫£n ph√≤ng</div>
          </div>
        </div>

        <!-- Ti√™u ƒë·ªÅ & m√¥ t·∫£ -->
        <div class="page-title">ƒêƒÉng nh·∫≠p t√†i kho·∫£n ph√≤ng</div>
        <div class="page-subtitle">
          Nh·∫≠p <strong>M√£ ph√≤ng</strong> v√† <strong>S·ªë ƒëi·ªán tho·∫°i/CCCD</strong> c·ªßa ch·ªß ph√≤ng ƒë·ªÉ xem portal n·ªôi b·ªô.
        </div>

        <!-- Badge hi·ªÉn th·ªã ph√≤ng t·ª´ URL -->
        <div id="roomBadge" class="badge" style="display:none;"></div>

        <!-- Form ƒëƒÉng nh·∫≠p -->
        <form id="loginForm">
          <div class="form-group">
            <label for="loginCode">M√£ ph√≤ng</label>
            <input id="loginCode" class="form-control" type="text" autocomplete="off" required />
          </div>

          <div class="form-group">
            <label for="loginPhone">S·ªë ƒëi·ªán tho·∫°i/CCCD ch·ªß ph√≤ng</label>
            <input id="loginPhone" class="form-control" type="tel" autocomplete="off" required />
          </div>

          <button type="submit" class="btn">
            ƒêƒÉng nh·∫≠p
          </button>
        </form>

        <!-- Tr·∫°ng th√°i ƒëƒÉng nh·∫≠p -->
        <div id="loginStatus" class="portal-status"></div>

        <!-- Ghi ch√∫ nh·ªè -->
        <div class="small-note">
          Sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng, h·ªá th·ªëng s·∫Ω l∆∞u t√†i kho·∫£n ph√≤ng ƒë·ªÉ nh·ªØng l·∫ßn sau t·ª± chuy·ªÉn th·∫≥ng v√†o portal.
        </div>

        <!-- Footer: quay l·∫°i & ƒëƒÉng xu·∫•t/ƒë·ªïi ph√≤ng -->
        <div class="tenant-footer-actions">
          <a href="index.html" class="tenant-back-link">
            ‚Üê Quay l·∫°i trang xem ph√≤ng
          </a>

          <button type="button" id="logoutBtn" class="btn-logout">
            <span class="btn-logout-icon">‚áÑ</span>
            <span>ƒêƒÉng xu·∫•t / ƒê·ªïi ph√≤ng</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ======================================================
   * C·∫§U H√åNH CHUNG
   * ====================================================== */
  const API_URL = (
    window.YT_HOME_API_URL ||
    document.querySelector("meta[name=yt-home-api]")?.content ||
    "https://script.google.com/macros/s/AKfycbxA2djnaTUjekiWl89BFJL-9ZLEbKClWb-5z7z3o_ZoamgPImDpIzhStGjuCx7BHB_MkQ/exec"
  );
  const TENANT_STORAGE_KEY = "ytHomeTenant";

  /* ======================================================
   * JSONP CALL (DUY NH·∫§T ‚Äì D√ôNG CHO TO√ÄN PORTAL)
   * ====================================================== */
  function callApi(action, params = {}) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
      window[cb] = (data) => { cleanup(); resolve(data); };
  
      const qs = new URLSearchParams({ action, ...params, callback: cb }).toString();
      const s = document.createElement("script");
      s.src = API_URL + "?" + qs;
      s.onerror = () => { cleanup(); reject(new Error("JSONP load failed")); };
      document.body.appendChild(s);
  
      function cleanup() {
        try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        if (s.parentNode) s.parentNode.removeChild(s);
      }
    });
  }

  async function handleLoginSubmit(event) {
    event.preventDefault();
  
    const statusEl   = document.getElementById("loginStatus");
    const roomCodeEl = document.getElementById("loginCode");
    const phoneEl    = document.getElementById("loginPhone");
  
    const roomCode = roomCodeEl ? roomCodeEl.value.trim().toUpperCase() : "";
    const phoneOrCCCD = phoneEl ? phoneEl.value.trim() : "";
  
    if (!roomCode || !phoneOrCCCD) {
      if (statusEl) statusEl.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß M√£ ph√≤ng v√† S·ªë ƒëi·ªán tho·∫°i/CCCD.";
      return;
    }
  
    if (statusEl) statusEl.textContent = "ƒêang ki·ªÉm tra th√¥ng tin ƒëƒÉng nh·∫≠p...";
  
    try {
      // ‚úÖ KH·ªöP doGet c·ªßa b·∫°n: action=tenantLogin + param phoneOrCCCD
      const data = await callApi("tenantLogin", {
        roomCode,
        phoneOrCCCD
      });
  
      if (!data || !data.success) {
        if (statusEl) statusEl.textContent = (data && data.message) || "ƒêƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá.";
        return;
      }
  
      const tenant = {
        maPhong: data.roomCode || roomCode,
        identity: phoneOrCCCD,
        name: data.tenKhach || data.tenChuPhong || ""
      };
      saveTenantToStorage(tenant);
  
      if (statusEl) statusEl.textContent = "ƒêƒÉng nh·∫≠p th√†nh c√¥ng. ƒêang chuy·ªÉn v√†o portal...";
      window.location.href = "portal.html?room=" + encodeURIComponent(tenant.maPhong);
  
    } catch (err) {
      console.error("handleLoginSubmit error:", err);
      if (statusEl) statusEl.textContent = "L·ªói k·∫øt n·ªëi Apps Script. Vui l√≤ng th·ª≠ l·∫°i.";
    }
  }


  /* ======================================================
   * LOCAL STORAGE
   * ====================================================== */
  function saveTenantToStorage(tenant) {
    try {
      if (tenant) {
        localStorage.setItem(TENANT_STORAGE_KEY, JSON.stringify(tenant));
      } else {
        localStorage.removeItem(TENANT_STORAGE_KEY);
      }
    } catch (e) {
      console.error("saveTenantToStorage error:", e);
    }
  }

  function logoutTenant() {
    saveTenantToStorage(null);
    const status = document.getElementById("loginStatus");
    if (status) {
      status.textContent = "ƒê√£ xo√° phi√™n ƒëƒÉng nh·∫≠p. B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p l·∫°i v·ªõi ph√≤ng kh√°c.";
    }

    const phoneEl = document.getElementById("loginPhone");
    if (phoneEl) phoneEl.value = "";

    const badgeEl = document.getElementById("roomBadge");
    if (badgeEl) {
      badgeEl.style.display = "none";
      badgeEl.textContent = "";
    }
  }

  /* ======================================================
   * LOGIN SUBMIT (ƒê√É CHUY·ªÇN SANG JSONP doGet)
   * ====================================================== */
  async function handleLoginSubmit(event) {
    event.preventDefault();

    const statusEl   = document.getElementById("loginStatus");
    const roomCodeEl = document.getElementById("loginCode");
    const phoneEl    = document.getElementById("loginPhone");

    const roomCode = roomCodeEl ? roomCodeEl.value.trim().toUpperCase() : "";
    const identity = phoneEl ? phoneEl.value.trim() : "";

    if (!roomCode || !identity) {
      if (statusEl) {
        statusEl.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß M√£ ph√≤ng v√† S·ªë ƒëi·ªán tho·∫°i/CCCD.";
      }
      return;
    }

    if (statusEl) {
      statusEl.textContent = "ƒêang ki·ªÉm tra th√¥ng tin ƒëƒÉng nh·∫≠p...";
    }

    try {
      // üî¥ CH·ªà D√íNG N√ÄY L√Ä G·ªåI BACKEND
      const data = await callApi("tenantLogin", {
        roomCode: roomCode,
        phoneOrCCCD: identity
      });

      if (!data || !data.success) {
        if (statusEl) {
          statusEl.textContent =
            (data && data.message) ||
            "Kh√¥ng t√¨m th·∫•y H·ª£p ƒë·ªìng hi·ªáu l·ª±c ho·∫∑c S·ªë ƒëi·ªán tho·∫°i/CCCD kh√¥ng kh·ªõp.";
        }
        return;
      }

      const tenant = {
        maPhong: data.maPhong || roomCode,
        identity: identity,
        name: data.tenKhach || data.tenChuPhong || ""
      };
      saveTenantToStorage(tenant);

      if (statusEl) {
        statusEl.textContent = "ƒêƒÉng nh·∫≠p th√†nh c√¥ng. ƒêang chuy·ªÉn v√†o portal...";
      }

      window.location.href =
        "portal.html?room=" + encodeURIComponent(tenant.maPhong);

    } catch (err) {
      console.error("handleLoginSubmit error:", err);
      if (statusEl) {
        statusEl.textContent = "C√≥ l·ªói khi ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i sau.";
      }
    }
  }

  /* ======================================================
   * DOM READY
   * ====================================================== */
  document.addEventListener("DOMContentLoaded", () => {
    const params       = new URLSearchParams(window.location.search);
    const roomFromURL  = params.get("room");
    const loginCodeEl  = document.getElementById("loginCode");
    const roomBadgeEl  = document.getElementById("roomBadge");

    // Auto redirect n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë√≥
    try {
      const saved = localStorage.getItem(TENANT_STORAGE_KEY);
      if (saved) {
        const tenant = JSON.parse(saved);
        if (tenant && tenant.maPhong) {
          if (!roomFromURL || roomFromURL === tenant.maPhong) {
            window.location.href =
              "portal.html?room=" + encodeURIComponent(tenant.maPhong);
            return;
          }
        }
      }
    } catch (e) {
      console.error("check existing tenant error:", e);
    }

    // G√°n ph√≤ng t·ª´ URL
    if (roomFromURL && loginCodeEl) {
      loginCodeEl.value = roomFromURL;
      if (roomBadgeEl) {
        roomBadgeEl.style.display = "inline-block";
        roomBadgeEl.textContent = "ƒêang ƒëƒÉng nh·∫≠p cho ph√≤ng: " + roomFromURL;
      }
    }

    const form = document.getElementById("loginForm");
    if (form) {
      form.addEventListener("submit", handleLoginSubmit);
    }

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", logoutTenant);
    }
  });
</script>
</body>
</html>




