<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="yt-home-api" content="https://script.google.com/macros/s/AKfycbyIsWxsDlyCpUNfAii3zZlvdJZ5F9uL-wYj8UhuLO9vsM5o4Ve2XpLQcYKzXLoXKfW0HA/exec" />
  <link rel="stylesheet" href="yt-home-common.css" />

  <style>
    .admin-top { display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; }
    .admin-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .kpi-grid { display:grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap:10px; }
    @media (max-width: 900px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); } }
    .kpi { padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }
    .kpi .k { font-size:12px; opacity:.85; }
    .kpi .v { font-size:22px; font-weight:700; margin-top:6px; }
    .filters { display:flex; gap:8px; flex-wrap:wrap; align-items:end; }
    .filters .field { min-width:180px; }
    .muted { opacity:.75; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); cursor:pointer; user-select:none; }
    .chip:hover { background: rgba(255,255,255,.07); }
    .right { text-align:right; }
    .nowrap { white-space:nowrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table-like td .btn { padding:6px 10px; }
  </style>
</head>

<body class="tenant-body">
  <div class="container">
    <header class="header admin-top">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Admin ‚Äì T·∫°m tr√∫ / CT01 / Dashboard</div>
        </div>
      </div>

      <div class="admin-actions">
        <a class="btn btn-outline" href="index.html">Trang xem ph√≤ng</a>
        <a class="btn btn-outline" href="tenant.html">Portal c∆∞ d√¢n</a>
        <button class="btn btn-outline" type="button" onclick="logoutAdmin()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</div>
      <div class="page-subtitle">
        ƒêƒÉng nh·∫≠p b·∫±ng <b>M√£ ph√≤ng Admin</b>. Ch·ªâ admin m·ªõi xem ƒë∆∞·ª£c dashboard & x·ª≠ l√Ω h·ªì s∆° t·∫°m tr√∫/CT01.
      </div>

      <div id="adminStatus" class="portal-status">ƒêang ki·ªÉm tra quy·ªÅn admin‚Ä¶</div>

      <!-- LOGIN ADMIN -->
      <section class="card" id="adminLoginCard" style="display:none;">
        <div class="card-title">ƒêƒÉng nh·∫≠p Admin</div>
        <div class="filters">
          <label class="field">
            <div class="field-label">M√£ ph√≤ng admin</div>
            <input id="adminRoomCode" class="form-control" type="text" placeholder="V√≠ d·ª•: ADMIN ho·∫∑c P000" />
          </label>
          <button class="btn" type="button" onclick="adminLogin()">X√°c nh·∫≠n</button>
        </div>
        <div class="small-note muted">H·ªá th·ªëng ki·ªÉm tra theo c·∫•u h√¨nh <span class="mono">ConfigLienHe.AdminRoomCodes</span>.</div>
      </section>

      <!-- MAIN ADMIN -->
      <div id="adminMain" style="display:none;">
        <!-- KPI / BADGES -->
        <section class="card">
          <div class="card-title">T·ªïng quan T·∫°m tr√∫</div>

          <div class="kpi-grid" style="margin-top:10px;">
            <div class="kpi"><div class="k">T·ªïng h·ªì s∆°</div><div class="v" id="kpiTotal">--</div></div>
            <div class="kpi"><div class="k">C√≤n h·∫°n</div><div class="v" id="kpiValid">--</div></div>
            <div class="kpi"><div class="k">S·∫Øp h·∫øt h·∫°n</div><div class="v" id="kpiSoon">--</div></div>
            <div class="kpi"><div class="k">H·∫øt h·∫°n</div><div class="v" id="kpiExpired">--</div></div>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
            <div class="chip" onclick="applyFilter({warning:'>2m'})">‚ö†Ô∏è &gt;2 th√°ng</div>
            <div class="chip" onclick="applyFilter({warning:'>30d'})">‚è≥ &gt;30 ng√†y</div>
            <div class="chip" onclick="applyFilter({warning:'>3d'})">üî• &gt;3 ng√†y</div>
            <div class="chip" onclick="applyFilter({warning:'1d'})">üö® 1 ng√†y</div>
            <div class="chip" onclick="applyFilter({status:'C√≤n h·∫°n'})">‚úÖ C√≤n h·∫°n</div>
            <div class="chip" onclick="applyFilter({status:'S·∫Øp h·∫øt h·∫°n'})">üü† S·∫Øp h·∫øt h·∫°n</div>
            <div class="chip" onclick="applyFilter({status:'H·∫øt h·∫°n'})">‚õî H·∫øt h·∫°n</div>
            <div class="chip" onclick="applyFilter({status:'', warning:''})">üßπ B·ªè l·ªçc</div>
          </div>

          <div class="small-note muted" style="margin-top:10px;">
            Tip: b·∫•m chip ƒë·ªÉ l·ªçc danh s√°ch b√™n d∆∞·ªõi.
          </div>
        </section>

        <!-- DASHBOARD FILTER -->
        <section class="card">
          <div class="card-title">Dashboard theo th√°ng</div>

          <div class="filters" style="margin-top:10px;">
            <label class="field">
              <div class="field-label">NƒÉm</div>
              <input id="dashYear" class="form-control" type="number" min="2020" max="2100" />
            </label>
            <label class="field">
              <div class="field-label">Th√°ng (1‚Äì12)</div>
              <input id="dashMonth" class="form-control" type="number" min="1" max="12" />
            </label>
            <button class="btn" type="button" onclick="loadDashboard()">T·∫£i dashboard</button>
          </div>

          <div class="table-wrap" style="margin-top:10px;">
            <table class="table-like">
              <thead>
                <tr>
                  <th>Ch·ªâ s·ªë</th>
                  <th class="right">Gi√° tr·ªã</th>
                </tr>
              </thead>
              <tbody id="dashSummaryBody">
                <tr><td colspan="2" class="muted">Ch∆∞a t·∫£i.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="small-note muted" style="margin-top:8px;">
            (N·∫øu b·∫°n mu·ªën bi·ªÉu ƒë·ªì c·ªôt/line: m√¨nh s·∫Ω th√™m Chart.js sau. Hi·ªán t·∫°i b·∫£ng summary ƒë·ªß d√πng ƒë·ªÉ b√†n giao.)
          </div>
        </section>

        <!-- LIST -->
        <section class="card">
          <div class="card-title">Danh s√°ch h·ªì s∆° T·∫°m tr√∫</div>

          <div class="filters" style="margin-top:10px;">
            <label class="field">
              <div class="field-label">L·ªçc theo Tr·∫°ng th√°i</div>
              <select id="filterStatus" class="form-control" onchange="applyFilter({status:this.value})">
                <option value="">-- T·∫•t c·∫£ --</option>
                <option value="C√≤n h·∫°n">C√≤n h·∫°n</option>
                <option value="S·∫Øp h·∫øt h·∫°n">S·∫Øp h·∫øt h·∫°n</option>
                <option value="H·∫øt h·∫°n">H·∫øt h·∫°n</option>
              </select>
            </label>

            <label class="field">
              <div class="field-label">L·ªçc theo C·∫£nh b√°o</div>
              <select id="filterWarning" class="form-control" onchange="applyFilter({warning:this.value})">
                <option value="">-- T·∫•t c·∫£ --</option>
                <option value=">2m">&gt;2 th√°ng</option>
                <option value=">30d">&gt;30 ng√†y</option>
                <option value=">3d">&gt;3 ng√†y</option>
                <option value="1d">1 ng√†y</option>
              </select>
            </label>

            <label class="field">
              <div class="field-label">Tra c·ª©u l·ªãch s·ª≠ theo CCCD</div>
              <input id="searchCCCD" class="form-control" placeholder="012345678901" />
            </label>
            <button class="btn btn-outline" type="button" onclick="searchHistory()">Tra c·ª©u</button>
          </div>

          <div class="table-wrap" style="margin-top:10px;">
            <table class="table-like">
              <thead>
                <tr>
                  <th class="nowrap">ID</th>
                  <th class="nowrap">Ph√≤ng</th>
                  <th>H·ªç t√™n</th>
                  <th class="nowrap">CCCD</th>
                  <th class="nowrap">T·ª´</th>
                  <th class="nowrap">ƒê·∫øn</th>
                  <th class="nowrap">Tr·∫°ng th√°i</th>
                  <th class="nowrap">C·∫£nh b√°o</th>
                  <th class="nowrap">CT01</th>
                </tr>
              </thead>
              <tbody id="tamtruListBody">
                <tr><td colspan="9" class="muted">ƒêang t·∫£i‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- HISTORY RESULT -->
        <section class="card" id="historyCard" style="display:none;">
          <div class="card-title">L·ªãch s·ª≠ t·∫°m tr√∫ theo CCCD</div>
          <div class="table-wrap" style="margin-top:10px;">
            <table class="table-like">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Ph√≤ng</th>
                  <th>H·ªç t√™n</th>
                  <th>T·ª´</th>
                  <th>ƒê·∫øn</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>CT01</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <tr><td colspan="7" class="muted">--</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

<script>
  const API_URL = (window.YT_HOME_API_URL || document.querySelector('meta[name=yt-home-api]')?.content || '');
  const ADMIN_STORAGE_KEY = "ytHomeAdmin";
  let currentFilter = { status:'', warning:'' };

  function qs(obj){
    const p = new URLSearchParams();
    Object.keys(obj || {}).forEach(k=>{
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).length) p.set(k, v);
    });
    return p.toString();
  }
  async function apiGet(action, params){
    const url = API_URL + (API_URL.includes('?')?'&':'?') + qs(Object.assign({ action }, params || {}));
    const res = await fetch(url, { method:'GET' });
    return res.json();
  }

  function saveAdmin(roomCode){
    localStorage.setItem(ADMIN_STORAGE_KEY, JSON.stringify({ roomCode }));
  }
  function getSavedAdmin(){
    try { return JSON.parse(localStorage.getItem(ADMIN_STORAGE_KEY) || 'null'); } catch(e){ return null; }
  }
  function logoutAdmin(){
    localStorage.removeItem(ADMIN_STORAGE_KEY);
    location.reload();
  }

  function setStatus(msg){ const el=document.getElementById('adminStatus'); if(el) el.textContent = msg; }

  async function checkAdmin(roomCode){
    const out = await apiGet('adminRole', { roomCode });
    return !!(out && (out.ok || out.success) && out.role === 'admin');
  }

  async function adminLogin(){
    const rc = (document.getElementById('adminRoomCode')?.value || '').trim().toUpperCase();
    if(!rc) return setStatus('Vui l√≤ng nh·∫≠p m√£ ph√≤ng admin.');
    setStatus('ƒêang ki·ªÉm tra quy·ªÅn admin‚Ä¶');
    try{
      const ok = await checkAdmin(rc);
      if(!ok){
        setStatus('Kh√¥ng c√≥ quy·ªÅn admin cho m√£ ph√≤ng n√†y.');
        return;
      }
      saveAdmin(rc);
      setStatus('OK. ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶');
      showAdminUI_();
    }catch(err){
      console.error(err);
      setStatus('L·ªói k·∫øt n·ªëi Apps Script.');
    }
  }

  function showLoginUI_(){
    document.getElementById('adminLoginCard').style.display='block';
    document.getElementById('adminMain').style.display='none';
  }
  function showAdminUI_(){
    document.getElementById('adminLoginCard').style.display='none';
    document.getElementById('adminMain').style.display='block';

    // set default month/year
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const yEl = document.getElementById('dashYear');
    const mEl = document.getElementById('dashMonth');
    if(yEl && !yEl.value) yEl.value = y;
    if(mEl && !mEl.value) mEl.value = m;

    loadAll();
  }

  function applyFilter(next){
    currentFilter = Object.assign({}, currentFilter, next || {});
    // sync selects
    const st = document.getElementById('filterStatus');
    const wn = document.getElementById('filterWarning');
    if(st && st.value !== currentFilter.status) st.value = currentFilter.status || '';
    if(wn && wn.value !== currentFilter.warning) wn.value = currentFilter.warning || '';
    loadTamTruList();
  }

  async function loadAll(){
    await loadBadge();
    await loadDashboard();
    await loadTamTruList();
    setStatus('S·∫µn s√†ng.');
  }

  async function loadBadge(){
    const out = await apiGet('tamtru_badge', {});
    // accept many shapes
    const b = out?.data || out?.badge || out || {};
    document.getElementById('kpiTotal').textContent   = (b.total ?? b.Total ?? '--');
    document.getElementById('kpiValid').textContent   = (b.valid ?? b.conHan ?? '--');
    document.getElementById('kpiSoon').textContent    = (b.soon ?? b.sapHet ?? '--');
    document.getElementById('kpiExpired').textContent = (b.expired ?? b.hetHan ?? '--');
  }

  async function loadDashboard(){
    const year  = String(document.getElementById('dashYear')?.value || '').trim();
    const month = String(document.getElementById('dashMonth')?.value || '').trim();
    const out = await apiGet('dash_tamtru_summary', { year, month });

    const rows = out?.rows || out?.data || out?.summary || out;
    const body = document.getElementById('dashSummaryBody');
    if(!body) return;

    const map = (rows && typeof rows === 'object') ? rows : {};
    const entries = Object.keys(map).map(k=>[k, map[k]]);
    if(!entries.length){
      body.innerHTML = '<tr><td colspan="2" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
      return;
    }
    body.innerHTML = entries.map(([k,v])=>`
      <tr><td>${escapeHtml(k)}</td><td class="right">${escapeHtml(String(v))}</td></tr>
    `).join('');
  }

  async function loadTamTruList(){
    const out = await apiGet('tamtru_list', { status: currentFilter.status || '', warning: currentFilter.warning || '' });
    const items = out?.data || out?.items || out?.list || [];
    const body = document.getElementById('tamtruListBody');
    if(!body) return;

    if(!Array.isArray(items) || !items.length){
      body.innerHTML = '<tr><td colspan="9" class="muted">Kh√¥ng c√≥ h·ªì s∆° ph√π h·ª£p b·ªô l·ªçc.</td></tr>';
      return;
    }

    body.innerHTML = items.map(it=>{
      const id = it.id || it.ID || '';
      const room = it.maPhong || it.roomCode || it.room || '';
      const name = it.hoTen || it.name || '';
      const cccd = it.cccd || '';
      const from = it.ngayBD || it.from || '';
      const to   = it.ngayKT || it.to || '';
      const st   = it.trangThai || it.status || '';
      const wn   = it.canhBao || it.warning || '';
      const ct01Url = it.ct01Url || it.linkCT01 || it.ct01 || '';

      return `
        <tr>
          <td class="mono nowrap">${escapeHtml(String(id))}</td>
          <td class="nowrap">${escapeHtml(String(room))}</td>
          <td>${escapeHtml(String(name))}</td>
          <td class="mono nowrap">${escapeHtml(String(cccd))}</td>
          <td class="nowrap">${escapeHtml(String(from))}</td>
          <td class="nowrap">${escapeHtml(String(to))}</td>
          <td class="nowrap">${escapeHtml(String(st))}</td>
          <td class="nowrap">${escapeHtml(String(wn))}</td>
          <td class="nowrap">
            ${ct01Url ? `<a class="btn btn-outline btn-sm" target="_blank" href="${escapeAttr(ct01Url)}">M·ªü</a>` : ''}
            <button class="btn btn-sm" type="button" onclick="genCT01('${escapeJs(String(id))}')">Sinh</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function genCT01(id){
    if(!id) return alert('Thi·∫øu ID h·ªì s∆°.');
    setStatus('ƒêang sinh CT01‚Ä¶');
    try{
      const out = await apiGet('ct01_generate', { id });
      const url = out?.url || out?.pdfUrl || out?.fileUrl;
      if(url) window.open(url, '_blank');
      await loadTamTruList();
      setStatus('ƒê√£ sinh CT01.');
    }catch(err){
      console.error(err);
      setStatus('L·ªói sinh CT01.');
      alert('Kh√¥ng sinh ƒë∆∞·ª£c CT01. Ki·ªÉm tra Template/Folder ID trong code.gs');
    }
  }

  async function searchHistory(){
    const cccd = (document.getElementById('searchCCCD')?.value || '').trim();
    if(!cccd) return alert('Nh·∫≠p CCCD ƒë·ªÉ tra c·ª©u.');
    setStatus('ƒêang tra c·ª©u l·ªãch s·ª≠‚Ä¶');
    try{
      const out = await apiGet('tamtru_history', { cccd });
      const list = out?.data || out?.items || out?.history || [];
      const card = document.getElementById('historyCard');
      const body = document.getElementById('historyBody');

      if(!Array.isArray(list) || !list.length){
        card.style.display='block';
        body.innerHTML = '<tr><td colspan="7" class="muted">Kh√¥ng c√≥ l·ªãch s·ª≠.</td></tr>';
        setStatus('Kh√¥ng c√≥ l·ªãch s·ª≠.');
        return;
      }

      card.style.display='block';
      body.innerHTML = list.map(it=>{
        const id = it.id || it.ID || '';
        const room = it.maPhong || it.roomCode || it.room || '';
        const name = it.hoTen || it.name || '';
        const from = it.ngayBD || it.from || '';
        const to   = it.ngayKT || it.to || '';
        const st   = it.trangThai || it.status || '';
        const ct01Url = it.ct01Url || it.linkCT01 || it.ct01 || '';

        return `
          <tr>
            <td class="mono">${escapeHtml(String(id))}</td>
            <td>${escapeHtml(String(room))}</td>
            <td>${escapeHtml(String(name))}</td>
            <td>${escapeHtml(String(from))}</td>
            <td>${escapeHtml(String(to))}</td>
            <td>${escapeHtml(String(st))}</td>
            <td class="nowrap">
              ${ct01Url ? `<a class="btn btn-outline btn-sm" target="_blank" href="${escapeAttr(ct01Url)}">M·ªü</a>` : ''}
              <button class="btn btn-sm" type="button" onclick="genCT01('${escapeJs(String(id))}')">Sinh</button>
            </td>
          </tr>
        `;
      }).join('');

      setStatus('ƒê√£ t·∫£i l·ªãch s·ª≠.');
    }catch(err){
      console.error(err);
      setStatus('L·ªói tra c·ª©u.');
      alert('L·ªói tra c·ª©u l·ªãch s·ª≠ CCCD.');
    }
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
  function escapeJs(s){ return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

  // boot
  document.addEventListener('DOMContentLoaded', async ()=>{
    if(!API_URL){
      setStatus('Thi·∫øu API URL. H√£y set meta yt-home-api.');
      showLoginUI_();
      return;
    }

    const saved = getSavedAdmin();
    if(saved && saved.roomCode){
      try{
        const ok = await checkAdmin(String(saved.roomCode).trim().toUpperCase());
        if(ok){
          showAdminUI_();
          return;
        }
      }catch(e){}
    }
    setStatus('Vui l√≤ng ƒëƒÉng nh·∫≠p admin.');
    showLoginUI_();
  });
</script>
</body>
</html>




