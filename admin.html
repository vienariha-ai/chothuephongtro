<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YT Home ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="yt-home-api" content="https://script.google.com/macros/s/AKfycbx4ealkWipJClmTelSHgHXnV6c4TJOLC92VndIxfO0KHK9tZ8NuJti8ucQ6OmMWhXam9A/exec" />
  <link rel="stylesheet" href="yt-home-common.css" />

  <style>
    .admin-top { display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; }
    .admin-actions { display:flex; gap:8px; flex-wrap:wrap; }

    .kpi-grid { display:grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap:10px; }
    @media (max-width: 900px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); } }

    .kpi { padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }
    .kpi .k { font-size:12px; opacity:.85; }
    .kpi .v { font-size:22px; font-weight:700; margin-top:6px; }

    .filters { display:flex; gap:8px; flex-wrap:wrap; align-items:end; }
    .filters .field { min-width:180px; }

    .muted { opacity:.75; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); cursor:pointer; user-select:none; }
    .chip:hover { background: rgba(255,255,255,.07); }

    .right { text-align:right; }
    .nowrap { white-space:nowrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table-like td .btn { padding:6px 10px; }

    /* --- Login polish --- */
    .login-grid { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px; }
    .login-grid .field { min-width:220px; flex: 1; }
    .pw-wrap { position: relative; }
    .pw-toggle {
      position:absolute; right:8px; top:50%; transform: translateY(-50%);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff; border-radius:10px;
      padding:6px 10px; cursor:pointer;
    }
    .row-inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .chk{ display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none; }
    .chk input{ transform: translateY(1px); }
    .msg{
      display:none;
      margin-top:10px;
      border-radius:12px;
      padding:10px 12px;
      font-size: 13px;
      line-height: 1.4;
      border: 1px solid rgba(255,255,255,.14);
    }
    .msg.ok{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35); }
    .msg.err{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.35); }

    .btn-spin{
      width: 14px; height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.35);
      border-top-color: rgba(255,255,255,1);
      display:none;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
  </style>
</head>

<body class="tenant-body">
  <div class="container">
    <header class="header admin-top">
      <div class="logo-row">
        <div class="logo-icon">YT</div>
        <div class="logo-text">
          <div class="logo-text-main">YT Home</div>
          <div class="logo-text-sub">Admin ‚Äì T·∫°m tr√∫ / CT01 / Dashboard</div>
        </div>
      </div>

      <div class="admin-actions">
        <a class="btn btn-outline" href="index.html">Trang xem ph√≤ng</a>
        <a class="btn btn-outline" href="tenant.html">Portal c∆∞ d√¢n</a>
        <button class="btn btn-outline" type="button" onclick="logoutAdmin()">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main>
      <div class="page-title">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</div>
      <div class="page-subtitle">
        Ch·ªâ admin m·ªõi xem ƒë∆∞·ª£c dashboard & x·ª≠ l√Ω h·ªì s∆° t·∫°m tr√∫/CT01.
        ƒêƒÉng nh·∫≠p b·∫±ng <b>M√£ ph√≤ng Admin</b> + <b>M·∫≠t kh·∫©u</b>.
      </div>

      <div id="adminStatus" class="portal-status">ƒêang ki·ªÉm tra quy·ªÅn admin‚Ä¶</div>

      <!-- LOGIN ADMIN -->
      <section class="card" id="adminLoginCard" style="display:none;">
        <div class="card-title">ƒêƒÉng nh·∫≠p Admin</div>

        <div class="login-grid">
          <label class="field">
            <div class="field-label">M√£ ph√≤ng admin</div>
            <input id="adminRoomCode" class="form-control" type="text" placeholder="V√≠ d·ª•: P000 ho·∫∑c 13LTQ" />
          </label>

          <label class="field">
            <div class="field-label">M·∫≠t kh·∫©u admin</div>
            <div class="pw-wrap">
              <input id="adminPassword" class="form-control" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u admin" />
              <button class="pw-toggle" type="button" onclick="togglePw()">üëÅ</button>
            </div>
          </label>

          <button class="btn" type="button" id="btnAdminLogin" onclick="adminLogin()">
            <span class="btn-text">X√°c nh·∫≠n</span>
            <span class="btn-spin" aria-hidden="true"></span>
          </button>
        </div>

        <div class="row-inline">
          <label class="chk muted">
            <input id="rememberAdmin" type="checkbox" />
            <span>Ghi nh·ªõ ƒëƒÉng nh·∫≠p (8 gi·ªù)</span>
          </label>
          <div class="small-note muted">
            H·ªá th·ªëng ki·ªÉm tra theo <span class="mono">ConfigLienHe.AdminRoomCodes</span> & <span class="mono">ConfigLienHe.AdminPassword</span>.
          </div>
        </div>

        <div id="adminMsg" class="msg"></div>
      </section>

      <!-- MAIN ADMIN -->
      <div id="adminMain" style="display:none;">
        <!-- KPI / BADGES -->
        <section class="card">
          <div class="card-title">T·ªïng quan T·∫°m tr√∫</div>

          <div class="kpi-grid" style="margin-top:10px;">
            <div class="kpi"><div class="k">T·ªïng h·ªì s∆°</div><div class="v" id="kpiTotal">--</div></div>
            <div class="kpi"><div class="k">C√≤n h·∫°n</div><div class="v" id="kpiValid">--</div></div>
            <div class="kpi"><div class="k">S·∫Øp h·∫øt h·∫°n</div><div class="v" id="kpiSoon">--</div></div>
            <div class="kpi"><div class="k">H·∫øt h·∫°n</div><div class="v" id="kpiExpired">--</div></div>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
            <div class="chip" onclick="applyFilter({warning:'>2m'})">‚ö†Ô∏è &gt;2 th√°ng</div>
            <div class="chip" onclick="applyFilter({warning:'>30d'})">‚è≥ &gt;30 ng√†y</div>
            <div class="chip" onclick="applyFilter({warning:'>3d'})">üî• &gt;3 ng√†y</div>
            <div class="chip" onclick="applyFilter({warning:'1d'})">üö® 1 ng√†y</div>
            <div class="chip" onclick="applyFilter({status:'C√≤n h·∫°n'})">‚úÖ C√≤n h·∫°n</div>
            <div class="chip" onclick="applyFilter({status:'S·∫Øp h·∫øt h·∫°n'})">üü† S·∫Øp h·∫øt h·∫°n</div>
            <div class="chip" onclick="applyFilter({status:'H·∫øt h·∫°n'})">‚õî H·∫øt h·∫°n</div>
            <div class="chip" onclick="applyFilter({status:'', warning:''})">üßπ B·ªè l·ªçc</div>
          </div>

          <div class="small-note muted" style="margin-top:10px;">
            Tip: b·∫•m chip ƒë·ªÉ l·ªçc danh s√°ch b√™n d∆∞·ªõi.
          </div>
        </section>

        <!-- DASHBOARD FILTER -->
        <section class="card">
          <div class="card-title">Dashboard theo th√°ng</div>

          <div class="filters" style="margin-top:10px;">
            <label class="field">
              <div class="field-label">NƒÉm</div>
              <input id="dashYear" class="form-control" type="number" min="2020" max="2100" />
            </label>
            <label class="field">
              <div class="field-label">Th√°ng (1‚Äì12)</div>
              <input id="dashMonth" class="form-control" type="number" min="1" max="12" />
            </label>
            <button class="btn" type="button" onclick="loadDashboard()">T·∫£i dashboard</button>
          </div>

          <div class="table-wrap" style="margin-top:10px;">
            <table class="table-like">
              <thead>
                <tr>
                  <th>Ch·ªâ s·ªë</th>
                  <th class="right">Gi√° tr·ªã</th>
                </tr>
              </thead>
              <tbody id="dashSummaryBody">
                <tr><td colspan="2" class="muted">Ch∆∞a t·∫£i.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="small-note muted" style="margin-top:8px;">
            (N·∫øu b·∫°n mu·ªën bi·ªÉu ƒë·ªì c·ªôt/line: m√¨nh s·∫Ω th√™m Chart.js sau. Hi·ªán t·∫°i b·∫£ng summary ƒë·ªß d√πng ƒë·ªÉ b√†n giao.)
          </div>
        </section>

        <!-- LIST -->
        <section class="card">
          <div class="card-title">Danh s√°ch h·ªì s∆° T·∫°m tr√∫</div>

          <div class="filters" style="margin-top:10px;">
            <label class="field">
              <div class="field-label">L·ªçc theo Tr·∫°ng th√°i</div>
              <select id="filterStatus" class="form-control" onchange="applyFilter({status:this.value})">
                <option value="">-- T·∫•t c·∫£ --</option>
                <option value="C√≤n h·∫°n">C√≤n h·∫°n</option>
                <option value="S·∫Øp h·∫øt h·∫°n">S·∫Øp h·∫øt h·∫°n</option>
                <option value="H·∫øt h·∫°n">H·∫øt h·∫°n</option>
              </select>
            </label>

            <label class="field">
              <div class="field-label">L·ªçc theo C·∫£nh b√°o</div>
              <select id="filterWarning" class="form-control" onchange="applyFilter({warning:this.value})">
                <option value="">-- T·∫•t c·∫£ --</option>
                <option value=">2m">&gt;2 th√°ng</option>
                <option value=">30d">&gt;30 ng√†y</option>
                <option value=">3d">&gt;3 ng√†y</option>
                <option value="1d">1 ng√†y</option>
              </select>
            </label>

            <label class="field">
              <div class="field-label">Tra c·ª©u l·ªãch s·ª≠ theo CCCD</div>
              <input id="searchCCCD" class="form-control" placeholder="012345678901" />
            </label>
            <button class="btn btn-outline" type="button" onclick="searchHistory()">Tra c·ª©u</button>
          </div>

          <div class="table-wrap" style="margin-top:10px;">
            <table class="table-like">
              <thead>
                <tr>
                  <th class="nowrap">ID</th>
                  <th class="nowrap">Ph√≤ng</th>
                  <th>H·ªç t√™n</th>
                  <th class="nowrap">CCCD</th>
                  <th class="nowrap">T·ª´</th>
                  <th class="nowrap">ƒê·∫øn</th>
                  <th class="nowrap">Tr·∫°ng th√°i</th>
                  <th class="nowrap">C·∫£nh b√°o</th>
                  <th class="nowrap">CT01</th>
                </tr>
              </thead>
              <tbody id="tamtruListBody">
                <tr><td colspan="9" class="muted">ƒêang t·∫£i‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- HISTORY RESULT -->
        <section class="card" id="historyCard" style="display:none;">
          <div class="card-title">L·ªãch s·ª≠ t·∫°m tr√∫ theo CCCD</div>
          <div class="table-wrap" style="margin-top:10px;">
            <table class="table-like">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Ph√≤ng</th>
                  <th>H·ªç t√™n</th>
                  <th>T·ª´</th>
                  <th>ƒê·∫øn</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>CT01</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <tr><td colspan="7" class="muted">--</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

<script>
  const API_URL = (window.YT_HOME_API_URL || document.querySelector('meta[name=yt-home-api]')?.content || '');
  const ADMIN_STORAGE_KEY = "ytHomeAdmin_v2"; // versioned
  const ADMIN_SESSION_HOURS = 8;
  let currentFilter = { status:'', warning:'' };

  function setStatus(msg){ const el=document.getElementById('adminStatus'); if(el) el.textContent = msg; }

  function setMsg(type, text){
    const el = document.getElementById('adminMsg');
    if(!el) return;
    el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
    el.textContent = text;
    el.style.display = 'block';
  }

  function setLoading(loading){
    const btn = document.getElementById('btnAdminLogin');
    if(!btn) return;
    const spin = btn.querySelector('.btn-spin');
    const txt = btn.querySelector('.btn-text');
    btn.disabled = !!loading;
    if(spin) spin.style.display = loading ? 'inline-block' : 'none';
    if(txt) txt.textContent = loading ? 'ƒêang ki·ªÉm tra...' : 'X√°c nh·∫≠n';
  }

  function togglePw(){
    const ip = document.getElementById('adminPassword');
    if(!ip) return;
    ip.type = (ip.type === 'password') ? 'text' : 'password';
  }

  function saveAdminAuth(roomCode, adminPassword, remember){
    const exp = Date.now() + ADMIN_SESSION_HOURS * 60 * 60 * 1000;
    const payload = { roomCode, adminPassword, exp };

    // remember => localStorage, else => sessionStorage
    try{
      if(remember){
        localStorage.setItem(ADMIN_STORAGE_KEY, JSON.stringify(payload));
        sessionStorage.removeItem(ADMIN_STORAGE_KEY);
      }else{
        sessionStorage.setItem(ADMIN_STORAGE_KEY, JSON.stringify(payload));
        localStorage.removeItem(ADMIN_STORAGE_KEY);
      }
    }catch(e){}
  }

  function getSavedAdminAuth(){
    try{
      const raw = sessionStorage.getItem(ADMIN_STORAGE_KEY) || localStorage.getItem(ADMIN_STORAGE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.roomCode || !obj.adminPassword || !obj.exp) return null;
      if(Date.now() > Number(obj.exp)){
        sessionStorage.removeItem(ADMIN_STORAGE_KEY);
        localStorage.removeItem(ADMIN_STORAGE_KEY);
        return null;
      }
      return obj;
    }catch(e){
      return null;
    }
  }

  function logoutAdmin(){
    localStorage.removeItem(ADMIN_STORAGE_KEY);
    sessionStorage.removeItem(ADMIN_STORAGE_KEY);
    location.reload();
  }

  // --- API calls ---
  function qs(obj){
    const p = new URLSearchParams();
    Object.keys(obj || {}).forEach(k=>{
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).length) p.set(k, v);
    });
    return p.toString();
  }

  // Public GET only (non-sensitive)
  async function apiGet(action, params){
    const url = API_URL + (API_URL.includes('?')?'&':'?') + qs(Object.assign({ action }, params || {}));
    const res = await fetch(url, { method:'GET' });
    return res.json();
  }

  // Admin POST JSON (sensitive) - kh√¥ng l·ªô password tr√™n URL
  async function apiAdmin(action, params){
    const auth = getSavedAdminAuth();
    if(!auth) throw new Error('Ch∆∞a ƒëƒÉng nh·∫≠p admin.');

    const payload = Object.assign({}, params || {}, {
      action,
      roomCode: auth.roomCode,
      adminPassword: auth.adminPassword
    });

    const res = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    return res.json();
  }

  // Login check: d√πng 1 admin action nh·∫π ƒë·ªÉ verify (tamtru_badge)
  async function verifyAdmin(roomCode, adminPassword){
    console.log('VERIFY payload =', { action:'tamtru_badge', roomCode, adminPassword });
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ action:'tamtru_badge', roomCode, adminPassword })
    }).then(r=>r.json());

    // ch·∫•p nh·∫≠n nhi·ªÅu shape
    if(!res) return false;
    if(res.success === false || res.ok === false) return false;
    // n·∫øu Apps Script throw Error => th∆∞·ªùng message/error
    if(res.error && String(res.error).toLowerCase().includes('permission')) return false;
    if(res.message && String(res.message).toLowerCase().includes('permission')) return false;
    return true;
  }

  function showLoginUI_(){
    document.getElementById('adminLoginCard').style.display='block';
    document.getElementById('adminMain').style.display='none';
  }

  function showAdminUI_(){
    document.getElementById('adminLoginCard').style.display='none';
    document.getElementById('adminMain').style.display='block';

    // set default month/year
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const yEl = document.getElementById('dashYear');
    const mEl = document.getElementById('dashMonth');
    if(yEl && !yEl.value) yEl.value = y;
    if(mEl && !mEl.value) mEl.value = m;

    loadAll();
  }

  async function adminLogin(){
    const rc = (document.getElementById('adminRoomCode')?.value || '').trim().toUpperCase();
    const pw = (document.getElementById('adminPassword')?.value || '').trim();
    const remember = !!document.getElementById('rememberAdmin')?.checked;

    if(!rc) { setStatus('Vui l√≤ng nh·∫≠p m√£ ph√≤ng admin.'); setMsg('err','Thi·∫øu m√£ ph√≤ng admin.'); return; }
    if(!pw) { setStatus('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u admin.'); setMsg('err','Thi·∫øu m·∫≠t kh·∫©u admin.'); return; }

    setLoading(true);
    setStatus('ƒêang ki·ªÉm tra quy·ªÅn admin‚Ä¶');
    setMsg('ok','ƒêang ki·ªÉm tra‚Ä¶');

    try{
      const ok = await verifyAdmin(rc, pw);
      if(!ok){
        setStatus('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Sai m√£ ph√≤ng admin ho·∫∑c m·∫≠t kh·∫©u.');
        setMsg('err','Sai m√£ ph√≤ng admin ho·∫∑c m·∫≠t kh·∫©u. Ki·ªÉm tra ConfigLienHe.AdminRoomCodes / AdminPassword.');
        return;
      }
      saveAdminAuth(rc, pw, remember);
      setStatus('OK. ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶');
      setMsg('ok','ƒêƒÉng nh·∫≠p admin th√†nh c√¥ng.');
      showAdminUI_();
    }catch(err){
      console.error(err);
      setStatus('L·ªói k·∫øt n·ªëi Apps Script.');
      setMsg('err','L·ªói k·∫øt n·ªëi Apps Script ho·∫∑c ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá.');
    }finally{
      setLoading(false);
    }
  }

  function applyFilter(next){
    currentFilter = Object.assign({}, currentFilter, next || {});
    // sync selects
    const st = document.getElementById('filterStatus');
    const wn = document.getElementById('filterWarning');
    if(st && st.value !== currentFilter.status) st.value = currentFilter.status || '';
    if(wn && wn.value !== currentFilter.warning) wn.value = currentFilter.warning || '';
    loadTamTruList();
  }

  async function loadAll(){
    await loadBadge();
    await loadDashboard();
    await loadTamTruList();
    setStatus('S·∫µn s√†ng.');
  }

  async function loadBadge(){
    const out = await apiAdmin('tamtru_badge', {});
    const b = out?.data || out?.badge || out || {};
    document.getElementById('kpiTotal').textContent   = (b.total ?? b.Total ?? '--');
    document.getElementById('kpiValid').textContent   = (b.valid ?? b.conHan ?? '--');
    document.getElementById('kpiSoon').textContent    = (b.soon ?? b.sapHet ?? '--');
    document.getElementById('kpiExpired').textContent = (b.expired ?? b.hetHan ?? '--');
  }

  async function loadDashboard(){
    const year  = String(document.getElementById('dashYear')?.value || '').trim();
    const month = String(document.getElementById('dashMonth')?.value || '').trim();

    const out = await apiAdmin('dash_tamtru_summary', { year, month });

    const rows = out?.rows || out?.data || out?.summary || out;
    const body = document.getElementById('dashSummaryBody');
    if(!body) return;

    const map = (rows && typeof rows === 'object') ? rows : {};
    const entries = Object.keys(map).map(k=>[k, map[k]]);
    if(!entries.length){
      body.innerHTML = '<tr><td colspan="2" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
      return;
    }
    body.innerHTML = entries.map(([k,v])=>`
      <tr><td>${escapeHtml(k)}</td><td class="right">${escapeHtml(String(v))}</td></tr>
    `).join('');
  }

  async function loadTamTruList(){
    const out = await apiAdmin('tamtru_list', { status: currentFilter.status || '', warning: currentFilter.warning || '' });

    const items = out?.data || out?.items || out?.list || [];
    const body = document.getElementById('tamtruListBody');
    if(!body) return;

    if(!Array.isArray(items) || !items.length){
      body.innerHTML = '<tr><td colspan="9" class="muted">Kh√¥ng c√≥ h·ªì s∆° ph√π h·ª£p b·ªô l·ªçc.</td></tr>';
      return;
    }

    body.innerHTML = items.map(it=>{
      const id = it.id || it.ID || '';
      const room = it.maPhong || it.roomCode || it.room || '';
      const name = it.hoTen || it.name || '';
      const cccd = it.cccd || '';
      const from = it.ngayBD || it.from || '';
      const to   = it.ngayKT || it.to || '';
      const st   = it.trangThai || it.status || '';
      const wn   = it.canhBao || it.warning || '';
      const ct01Url = it.ct01Url || it.linkCT01 || it.ct01 || '';

      return `
        <tr>
          <td class="mono nowrap">${escapeHtml(String(id))}</td>
          <td class="nowrap">${escapeHtml(String(room))}</td>
          <td>${escapeHtml(String(name))}</td>
          <td class="mono nowrap">${escapeHtml(String(cccd))}</td>
          <td class="nowrap">${escapeHtml(String(from))}</td>
          <td class="nowrap">${escapeHtml(String(to))}</td>
          <td class="nowrap">${escapeHtml(String(st))}</td>
          <td class="nowrap">${escapeHtml(String(wn))}</td>
          <td class="nowrap">
            ${ct01Url ? `<a class="btn btn-outline btn-sm" target="_blank" href="${escapeAttr(ct01Url)}">M·ªü</a>` : ''}
            <button class="btn btn-sm" type="button" onclick="genCT01('${escapeJs(String(id))}')">Sinh</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function genCT01(id){
    if(!id) return alert('Thi·∫øu ID h·ªì s∆°.');
    setStatus('ƒêang sinh CT01‚Ä¶');
    try{
      const out = await apiAdmin('ct01_generate', { id });
      const url = out?.url || out?.pdfUrl || out?.fileUrl;
      if(url) window.open(url, '_blank');
      await loadTamTruList();
      setStatus('ƒê√£ sinh CT01.');
    }catch(err){
      console.error(err);
      setStatus('L·ªói sinh CT01.');
      alert('Kh√¥ng sinh ƒë∆∞·ª£c CT01. Ki·ªÉm tra Template/Folder ID trong code.gs');
    }
  }

  async function searchHistory(){
    const cccd = (document.getElementById('searchCCCD')?.value || '').trim();
    if(!cccd) return alert('Nh·∫≠p CCCD ƒë·ªÉ tra c·ª©u.');
    setStatus('ƒêang tra c·ª©u l·ªãch s·ª≠‚Ä¶');
    try{
      const out = await apiAdmin('tamtru_history', { cccd });

      const list = out?.data || out?.items || out?.history || [];
      const card = document.getElementById('historyCard');
      const body = document.getElementById('historyBody');

      if(!Array.isArray(list) || !list.length){
        card.style.display='block';
        body.innerHTML = '<tr><td colspan="7" class="muted">Kh√¥ng c√≥ l·ªãch s·ª≠.</td></tr>';
        setStatus('Kh√¥ng c√≥ l·ªãch s·ª≠.');
        return;
      }

      card.style.display='block';
      body.innerHTML = list.map(it=>{
        const id = it.id || it.ID || '';
        const room = it.maPhong || it.roomCode || it.room || '';
        const name = it.hoTen || it.name || '';
        const from = it.ngayBD || it.from || '';
        const to   = it.ngayKT || it.to || '';
        const st   = it.trangThai || it.status || '';
        const ct01Url = it.ct01Url || it.linkCT01 || it.ct01 || '';

        return `
          <tr>
            <td class="mono">${escapeHtml(String(id))}</td>
            <td>${escapeHtml(String(room))}</td>
            <td>${escapeHtml(String(name))}</td>
            <td>${escapeHtml(String(from))}</td>
            <td>${escapeHtml(String(to))}</td>
            <td>${escapeHtml(String(st))}</td>
            <td class="nowrap">
              ${ct01Url ? `<a class="btn btn-outline btn-sm" target="_blank" href="${escapeAttr(ct01Url)}">M·ªü</a>` : ''}
              <button class="btn btn-sm" type="button" onclick="genCT01('${escapeJs(String(id))}')">Sinh</button>
            </td>
          </tr>
        `;
      }).join('');

      setStatus('ƒê√£ t·∫£i l·ªãch s·ª≠.');
    }catch(err){
      console.error(err);
      setStatus('L·ªói tra c·ª©u.');
      alert('L·ªói tra c·ª©u l·ªãch s·ª≠ CCCD.');
    }
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
  function escapeJs(s){ return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

  // boot
  document.addEventListener('DOMContentLoaded', async ()=>{
    if(!API_URL){
      setStatus('Thi·∫øu API URL. H√£y set meta yt-home-api.');
      showLoginUI_();
      return;
    }

    // N·∫øu c√≥ auth -> verify l·∫°i b·∫±ng tamtru_badge (POST)
    const saved = getSavedAdminAuth();
    if(saved && saved.roomCode && saved.adminPassword){
      setStatus('ƒêang ki·ªÉm tra quy·ªÅn admin‚Ä¶');
      try{
        const ok = await verifyAdmin(saved.roomCode, saved.adminPassword);
        if(ok){
          setStatus('OK. ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶');
          showAdminUI_();
          return;
        }
      }catch(e){}
    }

    setStatus('Vui l√≤ng ƒëƒÉng nh·∫≠p admin.');
    showLoginUI_();
  });
</script>
</body>
</html>




